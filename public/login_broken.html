<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>TownRanker Admin - Lead Management Dashboard</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		:root {
			--primary: #6366f1;
			--primary-dark: #4f46e5;
			--success: #10b981;
			--warning: #f59e0b;
			--danger: #ef4444;
			--dark: #1f2937;
			--gray: #6b7280;
			--light: #f9fafb;
			--white: #ffffff;
			--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
			/* Light mode (default) */
			--bg-primary: #f9fafb;
			--bg-secondary: #ffffff;
			--text-primary: #1f2937;
			--text-secondary: #6b7280;
			--border-color: #e5e7eb;
			--hover-bg: #f3f4f6;
		}
		/* Dark mode */
		[data-theme="dark"] {
			--primary: #818cf8;
			--primary-dark: #6366f1;
			--success: #34d399;
			--warning: #fbbf24;
			--danger: #f87171;
			--dark: #f9fafb;
			--gray: #9ca3af;
			--light: #374151;
			--white: #1f2937;
			--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
			--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
			--bg-primary: #0f172a;
			--bg-secondary: #1e293b;
			--text-primary: #f1f5f9;
			--text-secondary: #94a3b8;
			--border-color: #334155;
			--hover-bg: #334155;
		}
		/* Dark mode specific adjustments */
		[data-theme="dark"] .status-badge {
			opacity: 0.9;
		}
		[data-theme="dark"] .btn-primary {
			background: var(--primary);
			color: #0f172a;
		}
		[data-theme="dark"] .btn-secondary {
			background: #334155;
			color: #f1f5f9;
		}
		[data-theme="dark"] .login-container {
			background: linear-gradient(135deg, #4338ca 0%, #7c3aed 100%);
		}
		body {
			font-family: 'Inter', sans-serif;
			background: var(--bg-primary);
			color: var(--text-primary);
			transition: background-color 0.3s ease, color 0.3s ease;
		}
		/* Login Screen */
		.login-container {
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}
		.login-box {
			background: var(--bg-secondary);
			padding: 40px;
			border-radius: 12px;
			box-shadow: var(--shadow-lg);
			width: 100%;
			max-width: 400px;
		}
		.login-box h1 {
			text-align: center;
			margin-bottom: 30px;
			color: var(--primary);
		}
		.form-group {
			margin-bottom: 20px;
		}
		.form-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: var(--dark);
		}
		.form-control {
			width: 100%;
			padding: 12px;
			border: 2px solid var(--border-color);
			border-radius: 8px;
			font-size: 16px;
			transition: all 0.3s ease;
		}
		.form-control:focus {
			outline: none;
			border-color: var(--primary);
			box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
		}
		.btn-login {
			width: 100%;
			padding: 12px;
			background: var(--primary);
			color: white;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.btn-login:hover {
			background: var(--primary-dark);
		}
		/* Dashboard */
		.dashboard {
			display: none;
			min-height: 100vh;
			padding-bottom: 80px; /* Space for bottom nav */
		}
		.dashboard.active {
			display: flex;
			flex-direction: column;
		}
		/* Header */
		.header {
			background: var(--bg-secondary);
			box-shadow: var(--shadow);
			padding: 20px 30px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			z-index: 100;
			border-top: 1px solid var(--border-color);
		}
		/* Main content area */
		.main-content {
			flex: 1;
			overflow-y: auto;
			padding-bottom: 20px;
		}
		/* Page title for desktop */
		.page-title {
			padding: 20px 30px;
			background: var(--bg-secondary);
			border-bottom: 1px solid var(--border-color);
			margin-bottom: 20px;
		}
		.page-title h1 {
			color: var(--primary);
			font-size: 24px;
			margin: 0;
		}
		/* Hide on mobile by default */
		.mobile-hide {
			display: block;
		}
		.header h1 {
			color: var(--primary);
			font-size: 24px;
		}
		.header-actions {
			display: flex;
			gap: 15px;
			align-items: center;
		}
		.btn {
			padding: 10px 20px;
			border: none;
			border-radius: 8px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.btn-primary {
			background: var(--primary);
			color: white;
		}
		.btn-primary:hover {
			background: var(--primary-dark);
		}
		.btn-secondary {
			background: var(--gray);
			color: white;
		}
		.btn-secondary:hover {
			background: #4b5563;
		}
		/* Stats Cards */
		.stats-container {
			padding: 30px;
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
		}
		.stat-card {
			background: var(--bg-secondary);
			padding: 25px;
			border-radius: 12px;
			box-shadow: var(--shadow);
		}
		.stat-card h3 {
			color: var(--gray);
			font-size: 14px;
			font-weight: 500;
			margin-bottom: 10px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.stat-value {
			font-size: 32px;
			font-weight: 700;
			color: var(--dark);
			margin-bottom: 10px;
		}
		.stat-change {
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 5px;
		}
		.stat-change.positive {
			color: var(--success);
		}
		.stat-change.negative {
			color: var(--danger);
		}
		/* Filters */
		.filters-container {
			padding: 0 30px 20px;
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
		}
		.filter-select {
			padding: 10px 15px;
			border: 2px solid var(--border-color);
			border-radius: 8px;
			font-size: 14px;
			background: white;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.filter-select:focus {
			outline: none;
			border-color: var(--primary);
		}
		.search-box {
			flex: 1;
			min-width: 250px;
			position: relative;
		}
		.search-box input {
			width: 100%;
			padding: 10px 15px 10px 40px;
			border: 2px solid var(--border-color);
			border-radius: 8px;
			font-size: 14px;
		}
		.search-box .material-icons {
			position: absolute;
			left: 12px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--gray);
		}
		/* Leads Table */
		.table-container {
			padding: 0 30px 30px;
			overflow-x: auto;
			-webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
		}
		.leads-table {
			background: var(--bg-secondary);
			border-radius: 12px;
			overflow-x: auto;
			overflow-y: auto;
			max-height: calc(100vh - 400px); /* Limit height for vertical scroll */
			box-shadow: var(--shadow);
			-webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
		}
		/* Table wrapper for better mobile scrolling */
		.table-wrapper {
			overflow-x: auto;
			overflow-y: auto;
			max-height: calc(100vh - 400px);
			-webkit-overflow-scrolling: touch;
			border-radius: 12px;
		}
		table {
			width: 100%;
			min-width: 900px; /* Ensure table doesn't compress too much */
			border-collapse: collapse;
		}
		th {
			background: var(--light);
			padding: 15px;
			text-align: left;
			font-weight: 600;
			color: var(--dark);
			font-size: 14px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		td {
			padding: 15px;
			border-top: 1px solid var(--border-color);
			font-size: 14px;
		}
		tbody tr {
			cursor: pointer;
			transition: all 0.2s ease;
		}
		tbody tr:hover {
			background: var(--hover-bg);
			transform: scale(1.01);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		tbody tr:active {
			transform: scale(0.99);
		}
		.status-badge {
			display: inline-block;
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 500;
			text-transform: capitalize;
		}
		.status-badge.new {
			background: #dbeafe;
			color: #1e40af;
		}
		.status-badge.contacted {
			background: #fef3c7;
			color: #92400e;
		}
		.status-badge.qualified {
			background: #d1fae5;
			color: #065f46;
		}
		.status-badge.proposal {
			background: #ede9fe;
			color: #5b21b6;
		}
		.status-badge.closed-won {
			background: #10b981;
			color: white;
		}
		.status-badge.closed-lost {
			background: #fee2e2;
			color: #991b1b;
		}
		.project-type {
			background: var(--light);
			padding: 4px 8px;
			border-radius: 4px;
			font-weight: 500;
			text-transform: capitalize;
		}
		.budget {
			font-weight: 600;
			color: var(--primary);
		}
		/* Lead Details Modal */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
		}
		.modal.active {
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.modal-content {
			background: var(--bg-secondary);
			border-radius: 12px;
			width: 90%;
			max-width: 800px;
			max-height: 90vh;
			overflow-y: auto;
		}
		/* Customer Profile Modal Styles */
		.profile-tabs {
			display: flex;
			border-bottom: 1px solid var(--border-color);
			margin-bottom: 20px;
		}
		.profile-tab {
			padding: 15px 20px;
			background: transparent;
			border: none;
			cursor: pointer;
			font-weight: 500;
			color: var(--text-secondary);
			border-bottom: 2px solid transparent;
			transition: all 0.3s ease;
		}
		.profile-tab.active {
			color: var(--primary);
			border-bottom-color: var(--primary);
		}
		.profile-tab:hover {
			color: var(--primary);
			background: var(--hover-bg);
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		.profile-header {
			display: flex;
			align-items: center;
			gap: 20px;
			padding: 20px;
			background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
			color: white;
			border-radius: 12px 12px 0 0;
		}
		.profile-avatar {
			width: 80px;
			height: 80px;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.2);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 32px;
			font-weight: bold;
		}
		.profile-info h2 {
			margin: 0 0 5px 0;
		}
		.profile-info .subtitle {
			opacity: 0.8;
			font-size: 14px;
		}
		.profile-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
			gap: 15px;
			margin: 20px 0;
		}
		.profile-stat {
			text-align: center;
			padding: 15px;
			background: var(--light);
			border-radius: 8px;
		}
		.profile-stat-value {
			font-size: 24px;
			font-weight: bold;
			color: var(--primary);
			margin-bottom: 5px;
		}
		.profile-stat-label {
			font-size: 12px;
			color: var(--text-secondary);
			text-transform: uppercase;
		}
		.interaction-timeline {
			max-height: 400px;
			overflow-y: auto;
		}
		.timeline-item {
			display: flex;
			gap: 15px;
			padding: 15px 0;
			border-bottom: 1px solid var(--border-color);
		}
		.timeline-item:last-child {
			border-bottom: none;
		}
		.timeline-icon {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
			flex-shrink: 0;
		}
		.timeline-icon.email {
			background: #dbeafe;
			color: #1e40af;
		}
		.timeline-icon.email.incoming {
			background: #d1fae5;
			color: #065f46;
		}
		.timeline-icon.email.outgoing {
			background: #fef3c7;
			color: #92400e;
		}
		.timeline-icon.call {
			background: #d1fae5;
			color: #065f46;
		}
		.timeline-icon.meeting {
			background: #fef3c7;
			color: #92400e;
		}
		.timeline-icon.status {
			background: #ede9fe;
			color: #5b21b6;
		}
		.timeline-content {
			flex: 1;
		}
		.timeline-content h4 {
			margin: 0 0 5px 0;
			color: var(--text-primary);
		}
		.timeline-content p {
			margin: 0 0 5px 0;
			color: var(--text-secondary);
			font-size: 14px;
		}
		.timeline-time {
			font-size: 12px;
			color: var(--gray);
		}
		.notes-section {
			margin-top: 20px;
		}
		.note-item {
			background: var(--light);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 10px;
		}
		.note-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.note-author {
			font-weight: 500;
			color: var(--primary);
		}
		.note-date {
			font-size: 12px;
			color: var(--gray);
		}
		.note-content {
			color: var(--text-primary);
			line-height: 1.5;
		}
		.add-note-form {
			background: var(--light);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
		}
		.add-note-form textarea {
			width: 100%;
			min-height: 80px;
			padding: 10px;
			border: 1px solid var(--border-color);
			border-radius: 6px;
			resize: vertical;
			font-family: inherit;
		}
		.tags-container {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin: 15px 0;
		}
		.tag {
			display: inline-block;
			padding: 4px 12px;
			background: var(--primary);
			color: white;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 500;
		}
		.tag.priority-high {
			background: var(--danger);
		}
		.tag.priority-medium {
			background: var(--warning);
		}
		.tag.priority-low {
			background: var(--success);
		}
		.editable-field {
			border: none;
			background: transparent;
			color: inherit;
			font-size: inherit;
			padding: 4px 8px;
			border-radius: 4px;
			transition: all 0.3s ease;
		}
		.editable-field:hover {
			background: var(--hover-bg);
		}
		.editable-field:focus {
			outline: none;
			background: var(--bg-primary);
			border: 1px solid var(--primary);
		}
		.project-pipeline {
			display: flex;
			flex-direction: column;
			gap: 15px;
		}
		.pipeline-stage {
			padding: 20px;
			border-radius: 8px;
			border-left: 4px solid var(--border-color);
			background: var(--light);
			cursor: pointer;
			transition: all 0.2s ease;
			position: relative;
		}
		.pipeline-stage:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			border-left-width: 6px;
		}
		.pipeline-stage.clickable:hover {
			background: rgba(99, 102, 241, 0.08);
		}
		.pipeline-stage.completed:hover {
			border-left-color: var(--success);
			background: rgba(16, 185, 129, 0.08);
		}
		.pipeline-stage:active {
			transform: translateY(0);
		}
		.pipeline-stage.active {
			border-left-color: var(--primary);
			background: rgba(99, 102, 241, 0.05);
		}
		.pipeline-stage.completed {
			border-left-color: var(--success);
			background: rgba(16, 185, 129, 0.05);
		}
		.pipeline-stage h4 {
			margin: 0 0 10px 0;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.stage-progress {
			width: 100%;
			height: 8px;
			background: var(--border-color);
			border-radius: 4px;
			overflow: hidden;
			margin-top: 10px;
		}
		.stage-progress-bar {
			height: 100%;
			background: var(--primary);
			transition: width 0.3s ease;
		}
		/* Workflow Tab Styles */
		.workflow-board {
			background: white;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
		}
		.workflow-header {
			background: var(--light);
			padding: 16px 20px;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.workflow-actions {
			display: flex;
			gap: 12px;
			align-items: center;
		}
		.workflow-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}
		.workflow-table th {
			background: #f8fafc;
			padding: 12px 16px;
			text-align: left;
			font-weight: 600;
			font-size: 13px;
			color: #1f2937;
			border-bottom: 2px solid #e5e7eb;
			border-right: 1px solid #f1f5f9;
			position: sticky;
			top: 0;
			z-index: 10;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.workflow-table th:last-child {
			border-right: none;
		}
		.workflow-table td {
			padding: 12px 16px;
			border-bottom: 1px solid #f1f5f9;
			border-right: 1px solid #f1f5f9;
			vertical-align: middle;
			font-size: 14px;
			background: #ffffff;
			color: #111827;
		}
		.workflow-table td:last-child {
			border-right: none;
		}
		.workflow-row {
			transition: background-color 0.2s ease;
		}
		.workflow-row:hover {
			background: #f8fafc;
		}
		.workflow-row:hover td {
			background: #f8fafc;
		}
		.workflow-row.selected {
			background: rgba(99, 102, 241, 0.05);
		}
		.workflow-item {
			display: flex;
			align-items: center;
			gap: 8px;
			cursor: pointer;
			color: #111827;
			font-weight: 500;
		}
		.workflow-item.subitem {
			padding-left: 40px;
			position: relative;
		}
		.workflow-item.subitem::before {
			content: '';
			position: absolute;
			left: 20px;
			width: 16px;
			height: 1px;
			background: #d1d5db;
			top: 50%;
			transform: translateY(-50%);
		}
		.workflow-item.subitem::after {
			content: '';
			position: absolute;
			left: 20px;
			width: 1px;
			height: 24px;
			background: #d1d5db;
			top: -12px;
		}
		.workflow-expand-btn {
			width: 20px;
			height: 20px;
			border: none;
			background: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 4px;
			transition: background-color 0.2s ease;
		}
		.workflow-expand-btn:hover {
			background: var(--hover-bg);
		}
		.workflow-expand-btn .material-icons {
			font-size: 16px;
			color: var(--text-secondary);
			transition: transform 0.2s ease;
		}
		.workflow-expand-btn.expanded .material-icons {
			transform: rotate(90deg);
		}
		.workflow-checkbox {
			width: 16px;
			height: 16px;
			cursor: pointer;
		}
		.workflow-cell {
			position: relative;
		}
		.workflow-cell.editable {
			cursor: text;
			color: #111827;
			font-weight: 500;
		}
		.workflow-cell.editable:hover {
			background: rgba(99, 102, 241, 0.05);
			border-radius: 4px;
		}
		.status-dropdown {
			padding: 4px 8px;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			background: white;
			font-size: 12px;
			min-width: 100px;
			cursor: pointer;
		}
		.status-badge {
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: 500;
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}
		.status-badge.not-started {
			background: #f3f4f6;
			color: #374151;
			border: 1px solid #d1d5db;
		}
		.status-badge.in-progress {
			background: #fef3c7;
			color: #92400e;
			border: 1px solid #f59e0b;
		}
		.status-badge.completed {
			background: #d1fae5;
			color: #047857;
			border: 1px solid #10b981;
		}
		.status-badge.on-hold {
			background: #fee2e2;
			color: #dc2626;
			border: 1px solid #ef4444;
		}
		.priority-badge {
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: 500;
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}
		.priority-badge.low {
			background: #f0fdf4;
			color: #15803d;
			border: 1px solid #22c55e;
		}
		.priority-badge.medium {
			background: #fefce8;
			color: #a16207;
			border: 1px solid #eab308;
		}
		.priority-badge.high {
			background: #fef2f2;
			color: #dc2626;
			border: 1px solid #ef4444;
		}
		.priority-badge.critical {
			background: #7c2d12;
			color: #ffffff;
			border: 1px solid #dc2626;
			font-weight: 600;
		}
		.progress-bar {
			width: 80px;
			height: 8px;
			background: #e5e7eb;
			border-radius: 4px;
			overflow: hidden;
		}
		.progress-fill {
			height: 100%;
			background: var(--primary);
			border-radius: 4px;
			transition: width 0.3s ease;
		}
		.workflow-actions-cell {
			display: flex;
			gap: 8px;
			justify-content: flex-end;
		}
		.workflow-btn {
			padding: 8px 12px;
			border: 1px solid #d1d5db;
			border-radius: 6px;
			background: #ffffff;
			color: #374151;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 6px;
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
		}
		.workflow-btn:hover {
			background: #f9fafb;
			border-color: #6366f1;
			color: #4f46e5;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		.workflow-btn.primary {
			background: #4f46e5;
			color: #ffffff;
			border-color: #4f46e5;
			font-weight: 600;
		}
		.workflow-btn.primary:hover {
			background: #4338ca;
			border-color: #4338ca;
			box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
		}
		.workflow-btn.secondary {
			background: #f3f4f6;
			color: #6b7280;
			border-color: #d1d5db;
		}
		.workflow-btn.secondary:hover {
			background: #e5e7eb;
			color: #374151;
			border-color: #9ca3af;
		}
		.workflow-btn.danger {
			background: #ffffff;
			color: #dc2626;
			border-color: #fecaca;
		}
		.workflow-btn.danger:hover {
			background: #fef2f2;
			color: #b91c1c;
			border-color: #f87171;
		}
		.workflow-templates {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
		}
		.template-btn {
			padding: 12px 16px;
			background: #ffffff;
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			color: #374151;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			gap: 8px;
			min-height: 44px;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
		}
		.template-btn:hover {
			border-color: #4f46e5;
			background: #f8fafc;
			color: #4f46e5;
			box-shadow: 0 2px 6px rgba(79, 70, 229, 0.15);
			transform: translateY(-1px);
		}
		.template-btn:active {
			transform: translateY(0);
		}
		/* Communication Tab Styles */
		.communication-section {
			padding: 0;
		}
		.email-composer {
			background: var(--light);
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 20px;
		}
		.email-history {
			border-top: 1px solid var(--border-color);
			padding-top: 20px;
		}
		.email-item {
			background: var(--bg-secondary);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 10px;
		}
		.email-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
			font-size: 14px;
		}
		.email-subject {
			font-weight: 600;
			color: var(--text-primary);
		}
		.email-date {
			color: var(--text-secondary);
			font-size: 12px;
		}
		.email-preview {
			color: var(--text-secondary);
			font-size: 14px;
			line-height: 1.4;
		}
		.email-status {
			display: inline-block;
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 500;
			text-transform: uppercase;
		}
		.email-status.sent {
			background: #d1fae5;
			color: #065f46;
		}
		.email-status.draft {
			background: #fef3c7;
			color: #92400e;
		}
		.email-status.opened {
			background: #d1fae5;
			color: #065f46;
		}
		.email-status.unopened {
			background: #e5e7eb;
			color: #6b7280;
		}
		.email-open-info {
			font-size: 11px;
			color: var(--text-secondary);
			margin-top: 5px;
			display: flex;
			align-items: center;
			gap: 5px;
		}
		.email-open-indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			display: inline-block;
		}
		.email-open-indicator.opened {
			background: var(--success);
		}
		.email-open-indicator.unopened {
			background: var(--gray);
		}
		/* Email Open Notifications */
		.email-notifications {
			background: var(--light);
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 20px;
			border-left: 4px solid var(--success);
		}
		.notification-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px;
			background: var(--bg-secondary);
			border-radius: 6px;
			margin-bottom: 8px;
			border: 1px solid var(--border-color);
			animation: slideIn 0.3s ease-out;
		}
		.notification-item:last-child {
			margin-bottom: 0;
		}
		.notification-icon {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			background: var(--success);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 16px;
			flex-shrink: 0;
		}
		.notification-content {
			flex: 1;
		}
		.notification-title {
			font-weight: 600;
			color: var(--text-primary);
			margin-bottom: 2px;
		}
		.notification-time {
			font-size: 12px;
			color: var(--text-secondary);
		}
		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateX(-20px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}
		.notification-badge {
			background: var(--danger);
			color: white;
			border-radius: 50%;
			width: 20px;
			height: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 11px;
			font-weight: bold;
		}
		/* iPhone-style Conversation UI */
		.conversation-container {
			background: #f5f5f7;
			border-radius: 12px;
			border: 1px solid #d1d1d6;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}
		.messages-area {
			height: 600px;
			overflow-y: auto;
			padding: 20px;
			background: linear-gradient(180deg, #f5f5f7 0%, #e5e5ea 100%);
		}
		.message-bubble {
			max-width: 70%;
			margin-bottom: 4px;
			word-wrap: break-word;
			animation: messageSlideIn 0.3s ease-out;
		}
		.message-sent {
			margin-left: auto;
			text-align: right;
		}
		.message-received {
			margin-right: auto;
			text-align: left;
		}
		.message-content {
			padding: 12px 16px;
			border-radius: 18px;
			position: relative;
			display: inline-block;
			max-width: 100%;
		}
		.message-sent .message-content {
			background: #007aff;
			color: white;
			border-bottom-right-radius: 6px;
		}
		.message-received .message-content {
			background: white;
			color: #1d1d1f;
			border-bottom-left-radius: 6px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.1);
		}
		.message-subject {
			font-weight: 600;
			font-size: 14px;
			margin-bottom: 4px;
			opacity: 0.9;
		}
		.message-text {
			font-size: 16px;
			line-height: 1.4;
			white-space: pre-wrap;
		}
		.message-meta {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: 12px;
			margin-top: 4px;
			opacity: 0.7;
		}
		.message-sent .message-meta {
			justify-content: flex-end;
		}
		.message-received .message-meta {
			justify-content: flex-start;
		}
		.message-time {
			font-size: 11px;
		}
		.message-status {
			display: flex;
			align-items: center;
			gap: 2px;
		}
		.read-receipt {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			background: #34c759;
			font-size: 8px;
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		/* Message timestamps under bubbles */
		.message-timestamp {
			font-size: 11px;
			color: #8e8e93;
			margin-bottom: 16px;
			padding: 0 8px;
		}
		.message-timestamp-sent {
			text-align: right;
			margin-left: auto;
			max-width: 70%;
		}
		.message-timestamp-received {
			text-align: left;
			margin-right: auto;
			max-width: 70%;
		}

		/* iMessage-style compose interface */
		.imessage-compose {
			background: rgba(248, 248, 248, 0.85);
			backdrop-filter: blur(20px);
			border-top: 0.5px solid rgba(0, 0, 0, 0.15);
		}
		.quick-replies {
			padding: 12px 16px 8px;
			border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
		}
		.quick-reply-scroll {
			display: flex;
			gap: 8px;
			overflow-x: auto;
			padding-bottom: 4px;
		}
		.quick-reply-scroll::-webkit-scrollbar {
			height: 2px;
		}
		.quick-reply-scroll::-webkit-scrollbar-thumb {
			background: rgba(0, 0, 0, 0.2);
			border-radius: 2px;
		}
		.quick-reply-chip {
			background: #ffffff;
			border: 0.5px solid #d1d1d6;
			border-radius: 16px;
			padding: 8px 14px;
			font-size: 13px;
			color: #007aff;
			cursor: pointer;
			transition: all 0.15s ease;
			white-space: nowrap;
			flex-shrink: 0;
		}
		.quick-reply-chip:hover {
			background: #f2f2f7;
			transform: scale(1.02);
		}
		.compose-container {
			padding: 12px 16px;
		}
		.compose-subject {
			margin-bottom: 12px;
		}
		.subject-input {
			width: 100%;
			border: none;
			background: rgba(118, 118, 128, 0.12);
			border-radius: 20px;
			padding: 8px 16px;
			font-size: 16px;
			color: #000;
			outline: none;
		}
		.subject-input::placeholder {
			color: #8e8e93;
		}
		.compose-input-container {
			display: flex;
			align-items: flex-end;
			gap: 8px;
			background: rgba(255, 255, 255, 0.9);
			border: 0.5px solid rgba(0, 0, 0, 0.15);
			border-radius: 20px;
			padding: 6px;
		}
		.compose-btn {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			border: none;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.15s ease;
			flex-shrink: 0;
		}
		.compose-btn-options {
			background: #f2f2f7;
			color: #8e8e93;
		}
		.compose-btn-options:hover {
			background: #e5e5ea;
			transform: scale(1.1);
		}
		.compose-btn-send {
			background: #007aff;
			color: white;
		}
		.compose-btn-send:hover:not(:disabled) {
			background: #0056cc;
			transform: scale(1.1);
		}
		.compose-btn-send:disabled {
			background: #f2f2f7;
			color: #8e8e93;
			cursor: not-allowed;
		}
		.compose-input-wrapper {
			flex: 1;
			min-height: 32px;
			display: flex;
			align-items: center;
		}
		.compose-textarea {
			width: 100%;
			border: none;
			background: transparent;
			resize: none;
			outline: none;
			font-size: 16px;
			line-height: 20px;
			padding: 6px 0;
			color: #000;
			min-height: 20px;
			max-height: 100px;
		}
		.compose-textarea::placeholder {
			color: #8e8e93;
		}
		/* Prevent mobile zoom on input focus */
		input, textarea, select {
			font-size: 16px !important;
		}
		@media screen and (max-width: 768px) {
			input, textarea, select {
				font-size: 16px !important;
				transform: translateZ(0);
			}
		}
		.conversation-status {
			font-size: 12px;
			padding: 4px 8px;
			border-radius: 10px;
			font-weight: 500;
		}
		.conversation-status.online {
			background: #34c759;
			color: white;
		}
		.conversation-status.offline {
			background: #8e8e93;
			color: white;
		}
		.btn-icon {
			background: transparent;
			border: 1px solid #d1d1d6;
			border-radius: 8px;
			padding: 6px;
			cursor: pointer;
			color: #007aff;
			transition: all 0.2s ease;
		}
		.btn-icon:hover {
			background: #f2f2f7;
		}
		.btn-icon .material-icons {
			font-size: 18px;
		}
		@keyframes messageSlideIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		.typing-indicator {
			display: flex;
			align-items: center;
			gap: 6px;
			padding: 12px 16px;
			background: white;
			border-radius: 18px;
			border-bottom-left-radius: 6px;
			max-width: 70%;
			margin-bottom: 12px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.1);
		}
		.typing-dots {
			display: flex;
			gap: 4px;
		}
		.typing-dot {
			width: 6px;
			height: 6px;
			border-radius: 50%;
			background: #8e8e93;
			animation: typing 1.4s infinite;
		}
		.typing-dot:nth-child(2) {
			animation-delay: 0.2s;
		}
		.typing-dot:nth-child(3) {
			animation-delay: 0.4s;
		}
		@keyframes typing {
			0%, 60%, 100% {
				transform: translateY(0);
				opacity: 0.4;
			}
			30% {
				transform: translateY(-10px);
				opacity: 1;
			}
		}
		/* Toggle Switch Styles */
		.toggle-switch {
			position: relative;
			display: inline-block;
			width: 50px;
			height: 24px;
		}
		.toggle-switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}
		.toggle-slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 24px;
		}
		.toggle-slider:before {
			position: absolute;
			content: "";
			height: 18px;
			width: 18px;
			left: 3px;
			bottom: 3px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}
		input:checked + .toggle-slider {
			background-color: var(--primary);
		}
		input:focus + .toggle-slider {
			box-shadow: 0 0 1px var(--primary);
		}
		input:checked + .toggle-slider:before {
			transform: translateX(26px);
		}
		.modal-header {
			padding: 20px;
			border-bottom: 1px solid #e5e7eb;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.modal-header h2 {
			color: var(--dark);
		}
		.close-modal {
			background: transparent;
			border: none;
			font-size: 24px;
			color: var(--gray);
			cursor: pointer;
		}
		.modal-body {
			padding: 20px;
		}
		.detail-group {
			margin-bottom: 20px;
		}
		.detail-label {
			font-weight: 600;
			color: var(--gray);
			font-size: 12px;
			text-transform: uppercase;
			margin-bottom: 5px;
		}
		.detail-value {
			color: var(--dark);
			font-size: 16px;
		}
		/* Customer Profile Tabs */
		.profile-tabs {
			display: flex;
			border-bottom: 2px solid var(--border-color);
			margin-bottom: 20px;
		}
		.profile-tab {
			padding: 12px 24px;
			background: transparent;
			border: none;
			font-size: 14px;
			font-weight: 600;
			color: var(--text-secondary);
			cursor: pointer;
			transition: all 0.3s ease;
			border-bottom: 3px solid transparent;
			position: relative;
		}
		.profile-tab.active {
			color: var(--primary);
			border-bottom-color: var(--primary);
		}
		.profile-tab:hover:not(.active) {
			color: var(--text-primary);
			background: var(--hover-bg);
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		/* Communications Styles */
		.communications-container {
			max-height: 400px;
			overflow-y: auto;
			overflow-x: hidden;
			padding: 16px;
			background: var(--bg-primary);
			border-radius: 12px;
			border: 1px solid var(--border-color);
			scroll-behavior: smooth;
			display: flex;
			flex-direction: column;
		}
		.conversation-thread {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
		.email-message {
			background: var(--bg-secondary);
			border-radius: 12px;
			padding: 16px;
			border-left: 4px solid var(--border-color);
			transition: all 0.2s ease;
		}
		.email-message:hover {
			box-shadow: var(--shadow);
			transform: translateX(2px);
		}
		.email-message.sent {
			border-left-color: var(--primary);
			margin-left: 20px;
		}
		.email-message.received {
			border-left-color: var(--success);
			margin-right: 20px;
		}
		.email-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 12px;
			padding-bottom: 8px;
			border-bottom: 1px solid var(--border-color);
		}
		.email-from {
			font-weight: 600;
			color: var(--text-primary);
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.email-from .material-icons {
			font-size: 16px;
			color: var(--primary);
		}
		.email-timestamp {
			font-size: 12px;
			color: var(--text-secondary);
		}
		.email-subject {
			font-weight: 600;
			color: var(--text-primary);
			margin-bottom: 8px;
		}
		.email-body {
			color: var(--text-primary);
			line-height: 1.5;
			white-space: pre-wrap;
		}
		.conversation-actions {
			margin-top: 20px;
			padding-top: 16px;
			border-top: 1px solid var(--border-color);
			display: flex;
			gap: 12px;
		}
		.no-communications {
			text-align: center;
			color: var(--text-secondary);
			padding: 40px 20px;
		}
		.no-communications .material-icons {
			font-size: 48px;
			margin-bottom: 12px;
			opacity: 0.5;
		}

		/* Chat Interface Styles */
		.chat-modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 9999;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.chat-modal-backdrop {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
		}

		.chat-modal-content {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
		}

		.chat-container {
			position: relative;
			z-index: 10000;
		}

		.chat-interface {
			position: relative;
			width: 480px;
			height: 600px;
			background: var(--bg-primary);
			border-radius: 16px;
			border: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
		}

		.chat-header {
			padding: 16px;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: var(--bg-secondary);
			border-radius: 16px 16px 0 0;
		}

		.chat-header-info h3 {
			margin: 0 0 4px 0;
			color: var(--text-primary);
			font-size: 16px;
		}

		.phone-number {
			color: var(--text-secondary);
			font-size: 14px;
			display: block;
			margin-bottom: 4px;
		}

		.chat-status {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: 12px;
		}

		.status-indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: #4CAF50;
		}

		.status-indicator.imessage {
			background: #007AFF;
		}

		.chat-actions {
			display: flex;
			gap: 8px;
		}

		.btn-icon {
			width: 32px;
			height: 32px;
			border: none;
			background: transparent;
			border-radius: 6px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--text-secondary);
			transition: all 0.2s ease;
		}

		.btn-icon:hover {
			background: var(--hover-bg);
			color: var(--text-primary);
		}

		.chat-messages {
			flex: 1;
			padding: 16px;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.message {
			display: flex;
			flex-direction: column;
			max-width: 80%;
			animation: fadeIn 0.3s ease;
		}

		.message.outbound {
			align-self: flex-end;
		}

		.message.inbound {
			align-self: flex-start;
		}

		.message-content {
			padding: 12px 16px;
			border-radius: 18px;
			position: relative;
		}

		.message.outbound .message-content {
			background: #007AFF;
			color: white;
		}

		.message.inbound .message-content {
			background: var(--bg-secondary);
			color: var(--text-primary);
			border: 1px solid var(--border-color);
		}

		.message.imessage.outbound .message-content {
			background: #007AFF;
		}

		.message.sms.outbound .message-content {
			background: #34C759;
		}

		.message-text {
			word-wrap: break-word;
			line-height: 1.4;
		}

		.message-meta {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-top: 4px;
			font-size: 11px;
			opacity: 0.7;
		}

		.message-time {
			color: var(--text-secondary);
		}

		.message-status {
			display: flex;
			align-items: center;
		}

		.status-sending { color: #FF9500; }
		.status-sent { color: #34C759; }
		.status-delivered { color: #007AFF; }
		.status-failed { color: #FF3B30; }

		.imessage-indicator {
			font-size: 10px;
			color: #007AFF;
			font-weight: 500;
		}

		.chat-input-container {
			padding: 16px;
			border-top: 1px solid var(--border-color);
			background: var(--bg-secondary);
			border-radius: 0 0 16px 16px;
		}

		.chat-input-wrapper {
			display: flex;
			align-items: flex-end;
			gap: 8px;
			background: var(--bg-primary);
			border-radius: 20px;
			border: 1px solid var(--border-color);
			padding: 8px;
		}

		.chat-input {
			flex: 1;
			border: none;
			background: transparent;
			color: var(--text-primary);
			font-family: inherit;
			font-size: 14px;
			resize: none;
			outline: none;
			min-height: 20px;
			max-height: 100px;
			padding: 6px 12px;
		}

		.send-button {
			width: 32px;
			height: 32px;
			border: none;
			background: #007AFF;
			color: white;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s ease;
		}

		.send-button:disabled {
			background: var(--text-muted);
			cursor: not-allowed;
		}

		.send-button:not(:disabled):hover {
			background: #0051D5;
		}

		.chat-info {
			display: flex;
			justify-content: space-between;
			margin-top: 8px;
			font-size: 11px;
			color: var(--text-secondary);
		}

		.loading-indicator {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 40px;
			color: var(--text-secondary);
		}

		.spinner, .spinner-small {
			border: 2px solid var(--border-color);
			border-top: 2px solid #007AFF;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		.spinner {
			width: 24px;
			height: 24px;
			margin-bottom: 12px;
		}

		.spinner-small {
			width: 16px;
			height: 16px;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}

		/* Chat button in customer profile */
		.chat-button {
			background: #007AFF;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 6px;
			transition: all 0.2s ease;
		}

		.chat-button:hover {
			background: #0051D5;
		}
		.features-list {
			list-style: none;
			padding: 0;
		}
		.features-list li {
			padding: 5px 0;
			color: var(--dark);
		}
		.features-list li::before {
			content: '✓ ';
			color: var(--success);
			font-weight: bold;
		}
		/* Empty State */
		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: var(--gray);
		}
		.empty-state .material-icons {
			font-size: 48px;
			margin-bottom: 20px;
			opacity: 0.5;
		}
		/* Loading */
		.loading {
			text-align: center;
			padding: 40px;
			color: var(--gray);
		}
		.spinner {
			border: 3px solid var(--light);
			border-top: 3px solid var(--primary);
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 0 auto;
		}
		@keyframes spin {
			0% { transform: rotate(0deg)}
			100% { transform: rotate(360deg)}
		}
		/* Mobile scroll indicator */
		.scroll-indicator {
			display: none;
			text-align: center;
			padding: 10px;
			background: var(--light);
			color: var(--gray);
			font-size: 12px;
			border-radius: 8px 8px 0 0;
		}
		/* Add row click indicator on mobile */
		@media (hover: none) {
			tbody tr:active {
				background: #e5e7eb;
				transform: scale(0.98);
			}
		}
		/* Hide button text on small screens - but show in bottom nav */
		@media (max-width: 768px) {
			.header .btn-text, .header .theme-text {
				display: block;
				font-size: 10px;
				margin-top: 2px;
			}
		}
		/* Responsive */
		@media (max-width: 768px) {
			.stats-container {
				grid-template-columns: 1fr;
				padding: 15px;
			}
			.filters-container {
				flex-direction: column;
				padding: 0 15px 15px;
			}
			.search-box {
				width: 100%;
			}
			.table-container {
				padding: 0 10px 20px;
			}
			.leads-table {
				max-height: calc(100vh - 200px); /* Adjusted for bottom nav */
			}
			.table-wrapper {
				max-height: calc(100vh - 200px);
				position: relative;
			}
			table {
				min-width: 1000px; /* Ensure all columns are visible */
			}
			.scroll-indicator {
				display: block;
			}
			/* Reduce padding on mobile but keep good touch targets */
			th, td {
				padding: 12px 8px;
				font-size: 12px;
			}
			/* Ensure rows have minimum height for touch */
			tbody tr {
				min-height: 48px;
			}
			/* Better modal on mobile */
			.modal-content {
				width: 95%;
				max-width: none;
				margin: 10px;
				max-height: 95vh;
			}
			/* Bottom navigation bar styles */
			.header {
				padding: 10px 15px;
				flex-direction: row;
				justify-content: center;
				box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
			}
			.header h1.mobile-hide {
				display: none;
			}
			.page-title {
				display: none; /* Hide desktop title on mobile */
			}
			.header-actions {
				gap: 5px;
				flex: 1;
				display: flex;
				justify-content: space-around;
				max-width: 400px;
			}
			.btn {
				padding: 10px;
				font-size: 12px;
				flex-direction: column;
				align-items: center;
				background: transparent;
				border: none;
				color: var(--text-primary);
				min-width: 60px;
			}
			.btn .material-icons {
				margin-bottom: 4px;
			}
			.btn-primary {
				color: var(--primary);
			}
			.main-content {
				padding-bottom: 80px; /* Space for fixed bottom nav */
			}
			.dashboard {
				padding-bottom: 0;
			}
		}
	</style>
</head>
<body>
	<!-- Login Screen -->
	<div id="loginScreen" class="login-container">
		<div class="login-box">
			<h1>Admin Login</h1>
			<form id="loginForm">
				<div class="form-group">
					<label for="password">Access Token</label>
					<input type="password" id="password" class="form-control" placeholder="Enter admin token" required>
				</div>
				<button type="submit" class="btn-login">Login to Dashboard</button>
			</form>
			<div id="debugInfo" style="text-align: center; margin-top: 20px; color: green; font-size: 12px;">
				JavaScript loading...
			</div>
			<div id="testDebug" style="text-align: center; margin-top: 10px; color: blue; font-size: 12px;">
				Use token: Madman155!
			</div>
			<div id="loginStatus" style="text-align: center; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 14px; display: none;">
				Status will appear here...
			</div>
		</div>
	</div>
	<!-- Dashboard -->
	<div id="dashboard" class="dashboard">
		<!-- Main Content Area -->
		<div class="main-content">
			<!-- Page Title with Logo (visible on desktop, hidden on mobile) -->
			<div class="page-title" style="display: flex; align-items: center; gap: 20px;">
				<img src="images/townranker-logo.svg" alt="TownRanker" style="height: 50px; width: auto;">
				<h1>Lead Management Dashboard</h1>
			</div>
			<!-- Stats Cards -->
		<div class="stats-container">
			<div class="stat-card">
				<h3>Total Leads</h3>
				<div class="stat-value" id="totalLeads">0</div>
				<div class="stat-change positive">
					<span class="material-icons" style="font-size: 16px;">trending_up</span>
					<span id="leadGrowth">+0% this month</span>
				</div>
			</div>
			<div class="stat-card">
				<h3>New Leads</h3>
				<div class="stat-value" id="newLeads">0</div>
				<div class="stat-change positive">
					<span class="material-icons" style="font-size: 16px;">fiber_new</span>
					<span>Awaiting contact</span>
				</div>
			</div>
			<div class="stat-card">
				<h3>Qualified Leads</h3>
				<div class="stat-value" id="qualifiedLeads">0</div>
				<div class="stat-change positive">
					<span class="material-icons" style="font-size: 16px;">verified</span>
					<span>Ready for proposal</span>
				</div>
			</div>
			<div class="stat-card">
				<h3>Conversion Rate</h3>
				<div class="stat-value" id="conversionRate">0%</div>
				<div class="stat-change positive">
					<span class="material-icons" style="font-size: 16px;">insights</span>
					<span>Win rate</span>
				</div>
			</div>
		</div>
		<!-- Filters -->
		<div class="filters-container">
			<select class="filter-select" id="statusFilter" onchange="filterLeads()">
				<option value="">All Status</option>
				<option value="new">New</option>
				<option value="contacted">Contacted</option>
				<option value="qualified">Qualified</option>
				<option value="proposal">Proposal Sent</option>
				<option value="closed-won">Closed Won</option>
				<option value="closed-lost">Closed Lost</option>
			</select>
			<select class="filter-select" id="projectFilter" onchange="filterLeads()">
				<option value="">All Projects</option>
				<option value="business,business-website">Business Website</option>
				<option value="ecommerce,ecommerce-store">E-Commerce</option>
				<option value="webapp,web-application">Web Application</option>
				<option value="landing,landing-page">Landing Page</option>
				<option value="mobile">Mobile App</option>
				<option value="other">Other</option>
			</select>
			<select class="filter-select" id="budgetFilter" onchange="filterLeads()">
				<option value="">All Budgets</option>
				<option value="0-1000">$500 - $1k</option>
				<option value="1000-5000">$1k - $5k</option>
				<option value="5000-10000">$5k - $10k</option>
				<option value="10000-25000">$10k - $25k</option>
				<option value="25000+">$25k+</option>
			</select>
			<div class="search-box">
				<span class="material-icons">search</span>
				<input type="text" id="searchInput" placeholder="Search by name, email, or company..." onkeyup="filterLeads()">
			</div>
		</div>
		<!-- Leads Table -->
		<div class="table-container">
			<div class="leads-table">
				<div id="loadingState" class="loading" style="display: none;">
					<div class="spinner"></div>
					<p style="margin-top: 20px;">Loading leads...</p>
				</div>
				<div id="emptyState" class="empty-state" style="display: none;">
					<span class="material-icons">inbox</span>
					<h3>No leads found</h3>
					<p>New leads will appear here when they submit the form</p>
				</div>
				<div class="scroll-indicator">
					← Swipe to scroll | Tap any row to view details →
				</div>
				<div class="table-wrapper">
					<table id="leadsTable" style="display: none;">
						<thead>
							<tr>
								<th>Date</th>
								<th>Name</th>
								<th>Contact</th>
								<th>Project</th>
								<th>Budget</th>
								<th>Timeline</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody id="leadsTableBody">
							<!-- Leads will be populated here -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
		</div> <!-- End main-content -->
		<!-- Bottom Navigation Bar -->
		<div class="header">
			<div class="header-actions">
				<button class="btn btn-secondary" onclick="openSettings()" title="Settings">
					<span class="material-icons" style="font-size: 20px;">settings</span>
					<span class="btn-text">Settings</span>
				</button>
				<button class="btn btn-secondary" onclick="toggleDarkMode()" title="Toggle Dark Mode">
					<span class="material-icons" style="font-size: 20px;" id="themeIcon">dark_mode</span>
					<span class="theme-text">Dark</span>
				</button>
				<button class="btn btn-primary" onclick="openAddCustomerModal()" title="Add Customer" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
					<span class="material-icons" style="font-size: 20px;">person_add</span>
					<span class="btn-text">Add Customer</span>
				</button>
				<button class="btn btn-primary" onclick="refreshData()" title="Refresh">
					<span class="material-icons" style="font-size: 20px;">refresh</span>
					<span class="btn-text">Refresh</span>
				</button>
				<button class="btn btn-secondary" onclick="exportLeads()" title="Export CSV">
					<span class="material-icons" style="font-size: 20px;">download</span>
					<span class="btn-text">Export</span>
				</button>
				<button class="btn btn-secondary" onclick="logout()" title="Logout">
					<span class="material-icons" style="font-size: 20px;">logout</span>
					<span class="btn-text">Logout</span>
				</button>
			</div>
		</div>
	</div>
	<!-- Customer Profile Modal -->
	<div id="leadModal" class="modal">
		<div class="modal-content">
			<!-- Profile Header -->
			<div class="profile-header" id="profileHeader">
				<div class="profile-avatar" id="profileAvatar">JD</div>
				<div class="profile-info">
					<h2 id="profileName">John Doe</h2>
					<div class="subtitle" id="profileSubtitle">john@example.com • +1 (555) 123-4567</div>
					<div class="tags-container" id="profileTags">
						<!-- Tags will be populated here -->
					</div>
				</div>
				<div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
					<button id="deleteCustomerBtn" onclick="deleteCustomer()" title="Delete Customer" style="background: rgba(239,68,68,0.9); color: white; border: none; font-size: 18px; cursor: pointer; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
						<span class="material-icons" style="font-size: 18px;">delete</span>
					</button>
					<button class="close-modal" onclick="closeModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; font-size: 24px; cursor: pointer; padding: 10px; border-radius: 50%; width: 40px; height: 40px;">×</button>
				</div>
			</div>
			<!-- Profile Stats -->
			<div class="profile-stats" id="profileStats">
				<div class="profile-stat">
					<div class="profile-stat-value" id="daysAsCustomer">0</div>
					<div class="profile-stat-label">Days as Customer</div>
				</div>
				<div class="profile-stat">
					<div class="profile-stat-value" id="totalInteractions">0</div>
					<div class="profile-stat-label">Interactions</div>
				</div>
				<div class="profile-stat">
					<div class="profile-stat-value" id="projectValue">$0</div>
					<div class="profile-stat-label">Project Value</div>
				</div>
				<div class="profile-stat">
					<div class="profile-stat-value" id="responseTime">N/A</div>
					<div class="profile-stat-label">Avg Response</div>
				</div>
			</div>
			<!-- Profile Navigation Tabs -->
			<div class="profile-tabs">
				<button class="profile-tab active" onclick="switchTab('overview')">
					<span class="material-icons" style="font-size: 16px; margin-right: 5px;">person</span>
					Overview
				</button>
				<button class="profile-tab" onclick="switchTab('timeline')">
					<span class="material-icons" style="font-size: 16px; margin-right: 5px;">timeline</span>
					Timeline
				</button>
				<button class="profile-tab" onclick="switchTab('pipeline')">
					<span class="material-icons" style="font-size: 16px; margin-right: 5px;">trending_up</span>
					Pipeline
				</button>
				<button class="profile-tab" onclick="switchTab('workflow')">
					<span class="material-icons" style="font-size: 16px; margin-right: 5px;">view_list</span>
					Workflow
				</button>
				<button class="profile-tab" onclick="switchTab('communication')">
					<span class="material-icons" style="font-size: 16px; margin-right: 5px;">email</span>
					Communication
				</button>
			</div>
			<!-- Modal Body with Tab Content -->
			<div class="modal-body">
				<!-- Overview Tab -->
				<div id="tab-overview" class="tab-content active">
					<div class="detail-group">
						<div class="detail-label">Contact Information</div>
						<div class="detail-value">
							<strong>Name:</strong> <input type="text" class="editable-field" id="editableName" onblur="updateField('name', this.value)">
						</div>
						<div class="detail-value">
							<strong>Email:</strong> <input type="email" class="editable-field" id="editableEmail" onblur="updateField('email', this.value)">
						</div>
						<div class="detail-value">
							<strong>Phone:</strong> <input type="tel" class="editable-field" id="editablePhone" onblur="updateField('phone', this.value)">
						</div>
						<div class="detail-value">
							<strong>Company:</strong> <input type="text" class="editable-field" id="editableCompany" onblur="updateField('company', this.value)">
						</div>
					</div>
					<div class="detail-group">
						<div class="detail-label">Project Details</div>
						<div class="detail-value" id="projectType">Type: Business Website</div>
						<div class="detail-value" id="projectBudget">Budget: $5,000</div>
						<div class="detail-value" id="projectTimeline">Timeline: 1-2 Months</div>
						<div class="detail-value" id="projectStatus">Status: <span class="status-badge new">New</span></div>
					</div>
					<div class="detail-group" id="featuresGroup" style="display: none;">
						<div class="detail-label">Requested Features</div>
						<ul class="features-list" id="featuresList">
							<!-- Features will be populated here -->
						</ul>
					</div>
					<div class="detail-group" id="messageGroup" style="display: none;">
						<div class="detail-label">Additional Message</div>
						<div class="detail-value" id="additionalMessage"></div>
					</div>
					<div class="detail-group">
						<div class="detail-label">Lead Information</div>
						<div class="detail-value" id="leadCreated">Created: January 15, 2024</div>
						<div class="detail-value" id="leadId">Lead ID: 507f1f77bcf86cd799439011</div>
					</div>
				</div>
				<!-- Timeline Tab -->
				<div id="tab-timeline" class="tab-content">
					<div class="interaction-timeline" id="interactionTimeline">
						<!-- Timeline items will be populated here -->
					</div>
				</div>
				<!-- Pipeline Tab -->
				<div id="tab-pipeline" class="tab-content">
					<div class="project-pipeline" id="projectPipeline">
						<!-- Pipeline stages will be populated here -->
					</div>
				</div>
				<!-- Workflow Tab -->
				<div id="tab-workflow" class="tab-content">
					<div class="workflow-board" id="workflowBoard">
						<!-- Workflow content will be populated here -->
					</div>
				</div>
				<!-- Communication Tab -->
				<div id="tab-communication" class="tab-content">
					<div class="communication-section">
						<!-- Chat Actions -->
						<div class="communication-actions" style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
							<button id="openChatButton" class="chat-button" onclick="openChatForCurrentLead()">
								<i class="material-icons">sms</i>
								Open Chat
							</button>
							<span class="chat-info-text" style="color: var(--text-secondary); font-size: 14px;">
								Send SMS and iMessage to customer • Messages sync automatically in real-time
							</span>
						</div>
						
						<!-- Email Conversation -->
						<div class="email-conversation" style="margin-top: 30px;">
							<h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
								<span class="material-icons">chat</span>
								Email Conversation
								<div style="margin-left: auto; display: flex; gap: 10px;">
									<span class="conversation-status online">Online</span>
									<button onclick="refreshConversation()" class="btn-icon" title="Refresh">
										<span class="material-icons">refresh</span>
									</button>
								</div>
							</h4>
							<div class="conversation-container" id="conversationContainer">
								<div class="messages-area" id="messagesArea">
									<!-- Messages will be populated here -->
								</div>
								<!-- iMessage-style compose interface -->
								<div class="imessage-compose">
									<!-- Quick replies (collapsible) -->
									<div class="quick-replies" id="quickReplies" style="display: none;">
										<div class="quick-reply-scroll">
											<button class="quick-reply-chip" onclick="insertQuickReply('Thanks for your interest! Let me get back to you shortly.')">
												Thanks for your interest
											</button>
											<button class="quick-reply-chip" onclick="insertQuickReply('I\'ve sent you a detailed proposal. Please review and let me know your thoughts.')">
												Proposal sent
											</button>
											<button class="quick-reply-chip" onclick="insertQuickReply('When would be a good time for a quick call to discuss your project?')">
												Schedule call
											</button>
											<button class="quick-reply-chip" onclick="insertQuickReply('Let me know if you have any questions!')">
												Any questions?
											</button>
										</div>
									</div>
									<!-- Main compose area -->
									<div class="compose-container">
										<!-- Subject line (collapsible) -->
										<div class="compose-subject" id="composeSubject" style="display: none;">
											<input type="text" id="emailSubject" placeholder="Subject" class="subject-input">
										</div>
										<!-- Message input -->
										<div class="compose-input-container">
											<button class="compose-btn compose-btn-options" onclick="toggleComposeOptions()" title="Options">
												<span class="material-icons">add</span>
											</button>
											<div class="compose-input-wrapper">
												<textarea id="emailBody" placeholder="iMessage" class="compose-textarea" rows="1" oninput="autoResizeTextarea(this)" onkeydown="handleComposeKeydown(event)"></textarea>
											</div>
											<button class="compose-btn compose-btn-send"  title="Send" disabled>
												<span class="material-icons">send</span>
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Settings Modal -->
	<div id="settingsModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="modal-header">
				<h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
					<span class="material-icons">settings</span>
					Dashboard Settings
				</h2>
				<button class="close-modal" onclick="closeSettings()" style="background: transparent; border: none; font-size: 24px; color: var(--gray); cursor: pointer;">×</button>
			</div>
			<div class="modal-body">
				<!-- Email Notifications Section -->
				<div class="setting-section" style="margin-bottom: 30px;">
					<h3 style="margin: 0 0 15px 0; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
						<span class="material-icons">email</span>
						Email Notifications
					</h3>
					<div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
						<div>
							<div style="font-weight: 500; color: var(--text-primary); margin-bottom: 5px;">Email Open Notifications</div>
							<div style="font-size: 14px; color: var(--text-secondary);">Get notified when customers open your emails</div>
						</div>
						<label class="toggle-switch">
							<input type="checkbox" id="emailNotificationsToggle" checked>
							<span class="toggle-slider"></span>
						</label>
					</div>
					<div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); margin-top: 10px;">
						<div>
							<div style="font-weight: 500; color: var(--text-primary); margin-bottom: 5px;">Customer Reply Notifications</div>
							<div style="font-size: 14px; color: var(--text-secondary);">Get notified when customers reply to your emails</div>
						</div>
						<label class="toggle-switch">
							<input type="checkbox" id="replyNotificationsToggle" checked>
							<span class="toggle-slider"></span>
						</label>
					</div>
				</div>
				<!-- System Settings Section -->
				<div class="setting-section" style="margin-bottom: 30px;">
					<h3 style="margin: 0 0 15px 0; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
						<span class="material-icons">tune</span>
						System Settings
					</h3>
					<div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
						<div>
							<div style="font-weight: 500; color: var(--text-primary); margin-bottom: 5px;">Auto-refresh Dashboard</div>
							<div style="font-size: 14px; color: var(--text-secondary);">Automatically refresh customer data every 5 minutes</div>
						</div>
						<label class="toggle-switch">
							<input type="checkbox" id="autoRefreshToggle">
							<span class="toggle-slider"></span>
						</label>
					</div>
				</div>
				<!-- Save Button -->
				<div style="text-align: center; margin-top: 30px;">
					<button onclick="saveSettings()" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
						<span class="material-icons" style="font-size: 18px;">save</span>
						Save Settings
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Create Event Modal -->
	<div id="createEventModal" class="modal">
		<div class="modal-content" style="max-width: 600px;">
			<div class="modal-header">
				<h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
					<span class="material-icons">event</span>
					Create Calendar Event
				</h2>
				<button class="close-modal"  style="background: transparent; border: none; font-size: 24px; color: var(--gray); cursor: pointer;">×</button>
			</div>
			<div class="modal-body">
				<form id="createEventForm" style="display: flex; flex-direction: column; gap: 20px;">
					<!-- Event Title -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Event Title *</label>
						<input type="text" id="eventTitle" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);" placeholder="Enter event title">
					</div>

					<!-- Event Date and Time -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
						<div>
							<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Date *</label>
							<input type="date" id="eventDate" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
						</div>
						<div>
							<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Time *</label>
							<input type="time" id="eventTime" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
						</div>
					</div>

					<!-- Duration -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Duration</label>
						<select id="eventDuration" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="30">30 minutes</option>
							<option value="60" selected>1 hour</option>
							<option value="90">1.5 hours</option>
							<option value="120">2 hours</option>
							<option value="180">3 hours</option>
							<option value="custom">Custom</option>
						</select>
					</div>

					<!-- Custom Duration (hidden by default) -->
					<div id="customDurationSection" style="display: none;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Custom Duration (minutes)</label>
						<input type="number" id="customDuration" min="15" step="15" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);" placeholder="Enter duration in minutes">
					</div>

					<!-- Client Selection -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Associated Client</label>
						<select id="eventClient" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="">Select a client (optional)</option>
						</select>
					</div>

					<!-- Event Description -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Description</label>
						<textarea id="eventDescription" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); resize: vertical;" placeholder="Enter event description (optional)"></textarea>
					</div>

					<!-- Event Location -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Location</label>
						<input type="text" id="eventLocation" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);" placeholder="Enter location or meeting link">
					</div>

					<!-- Reminder -->
					<div>
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Reminder</label>
						<select id="eventReminder" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="0">No reminder</option>
							<option value="15" selected>15 minutes before</option>
							<option value="30">30 minutes before</option>
							<option value="60">1 hour before</option>
							<option value="1440">1 day before</option>
						</select>
					</div>

					<!-- Action Buttons -->
					<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
						<button type="button"  style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
							Cancel
						</button>
						<button type="submit" style="background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
							<span class="material-icons" style="font-size: 16px;">event</span>
							Create Event
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Add Customer Modal -->
	<div id="addCustomerModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="modal-header">
				<h2 style="margin: 0; color: var(--text-primary); font-size: 24px;">Add New Customer</h2>
				<button class="close-modal" onclick="closeAddCustomerModal()" style="background: rgba(255,255,255,0.1); color: var(--text-primary); border: none; font-size: 24px; cursor: pointer; padding: 10px; border-radius: 50%; width: 40px; height: 40px;">×</button>
			</div>
			<div class="modal-body" style="padding: 30px;">
				<form id="addCustomerForm" onsubmit="handleAddCustomer(event)">
					<!-- Name -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Name <span style="color: #ef4444;">*</span>
						</label>
						<input type="text" id="newCustomerName" required
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="John Doe">
					</div>

					<!-- Email -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Email <span style="color: #ef4444;">*</span>
						</label>
						<input type="email" id="newCustomerEmail" required
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="john@example.com">
					</div>

					<!-- Phone -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Phone <span style="color: #ef4444;">*</span>
						</label>
						<input type="tel" id="newCustomerPhone" required
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="+1 (555) 123-4567">
					</div>

					<!-- Company -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Company
						</label>
						<input type="text" id="newCustomerCompany"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="Acme Inc. (optional)">
					</div>

					<!-- Project Type -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Project Type
						</label>
						<select id="newCustomerProjectType"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="">Select a project type</option>
							<option value="business-website">Business Website</option>
							<option value="ecommerce-store">E-Commerce Store</option>
							<option value="web-application">Web Application</option>
							<option value="landing-page">Landing Page</option>
							<option value="other">Other</option>
						</select>
					</div>

					<!-- Budget -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Budget
						</label>
						<input type="number" id="newCustomerBudget" min="0" step="100"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="10000">
					</div>

					<!-- Timeline -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Timeline
						</label>
						<select id="newCustomerTimeline"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="">Select timeline</option>
							<option value="asap">ASAP</option>
							<option value="1-2months">1-2 Months</option>
							<option value="3-4months">3-4 Months</option>
							<option value="flexible">Flexible</option>
						</select>
					</div>

					<!-- Initial Message/Notes -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Initial Notes
						</label>
						<textarea id="newCustomerMessage" rows="4"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); resize: vertical;"
							placeholder="Any initial notes or requirements..."></textarea>
					</div>

					<!-- Form Actions -->
					<div style="display: flex; gap: 12px; justify-content: flex-end;">
						<button type="button" onclick="closeAddCustomerModal()"
							style="padding: 12px 24px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
							Cancel
						</button>
						<button type="submit"
							style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
							Add Customer
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Schedule Event Modal -->
	<div id="scheduleEventModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="modal-header">
				<h2 style="margin: 0; color: var(--text-primary); font-size: 24px;">Schedule Event</h2>
				<button class="close-modal"  style="background: rgba(255,255,255,0.1); color: var(--text-primary); border: none; font-size: 24px; cursor: pointer; padding: 10px; border-radius: 50%; width: 40px; height: 40px;">×</button>
			</div>
			<div class="modal-body" style="padding: 30px;">
				<form id="scheduleEventForm" onsubmit="handleScheduleEvent(event)">
					<!-- Event Title -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Event Title <span style="color: #ef4444;">*</span>
						</label>
						<input type="text" id="eventTitle" required
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
					</div>

					<!-- Event Type -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Event Type
						</label>
						<select id="eventType"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="discovery-call">Discovery Call</option>
							<option value="follow-up">Follow-up Meeting</option>
							<option value="proposal-review">Proposal Review</option>
							<option value="project-kickoff">Project Kickoff</option>
							<option value="check-in">Check-in</option>
							<option value="final-review">Final Review</option>
							<option value="other">Other</option>
						</select>
					</div>

					<!-- Date & Time -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
						<div>
							<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
								Date <span style="color: #ef4444;">*</span>
							</label>
							<input type="date" id="eventDate" required
								style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
						</div>
						<div>
							<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
								Time <span style="color: #ef4444;">*</span>
							</label>
							<input type="time" id="eventTime" required
								style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
						</div>
					</div>

					<!-- Duration -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Duration
						</label>
						<select id="eventDuration"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);">
							<option value="15">15 minutes</option>
							<option value="30">30 minutes</option>
							<option value="45">45 minutes</option>
							<option value="60" selected>1 hour</option>
							<option value="90">1.5 hours</option>
							<option value="120">2 hours</option>
						</select>
					</div>

					<!-- Location/Meeting Link -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Location / Meeting Link
						</label>
						<input type="text" id="eventLocation"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary);"
							placeholder="e.g., Zoom link, phone number, or address">
					</div>

					<!-- Description/Notes -->
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
							Description / Notes
						</label>
						<textarea id="eventDescription" rows="3"
							style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
					</div>

					<!-- Sync to Google Calendar -->
					<div style="margin-bottom: 20px;">
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
							<input type="checkbox" id="syncToGoogle" checked>
							<span style="color: var(--text-primary); font-size: 14px;">Add to Google Calendar</span>
						</label>
					</div>

					<!-- Hidden fields for workflow data -->
					<input type="hidden" id="workflowItemId">
					<input type="hidden" id="workflowItemType">
					<input type="hidden" id="eventLeadId">

					<!-- Form Actions -->
					<div style="display: flex; gap: 12px; justify-content: flex-end;">
						<button type="button" 
							style="padding: 12px 24px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
							Cancel
						</button>
						<button type="submit"
							style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
							Schedule Event
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<!-- Google Calendar API -->
	
	<!-- Socket.io client -->
	<script src="/socket.io/socket.io.js"></script>
	<!-- Chat functionality -->
	<script src="/js/chat.js"></script>
	<script>
		// Debug: Check if scripts loaded
		console.log('Socket.io loaded:', typeof io !== 'undefined');
		console.log('Chat script loaded:', typeof openCustomerChat === 'function');
	</script>
	
	<script>
		// Immediate execution to update debug message
		console.log('Script starting...');
		setTimeout(function() {
			const debugInfo = document.getElementById('debugInfo');
			const testDebug = document.getElementById('testDebug');
			console.log('Timeout - Debug element:', debugInfo);
			console.log('Timeout - Test element:', testDebug);
			if (debugInfo) {
				debugInfo.textContent = 'JavaScript loaded successfully!';
				debugInfo.style.color = 'green';
			}
			if (testDebug) {
				testDebug.textContent = 'JavaScript is working! ' + new Date().toLocaleTimeString();
				testDebug.style.color = 'blue';
			}
		}, 100);

		let authToken = '';
		let allLeads = [];
		let filteredLeads = [];
		
		// Wait for DOM to be ready
		document.addEventListener('DOMContentLoaded', function() {
			console.log('DOM ready, setting up login form...');
			const loginForm = document.getElementById('loginForm');
			if (!loginForm) {
				console.error('Login form not found!');
				return;
			}
			
			// Login
			loginForm.addEventListener('submit', async function(e) {
			e.preventDefault();
			console.log('Login form submitted');
			
			const statusDiv = document.getElementById('loginStatus');
			statusDiv.style.display = 'block';
			statusDiv.innerHTML = '🔄 Starting login...';
			
			const password = document.getElementById('password').value;
			console.log('Password entered:', password ? 'YES' : 'NO');
			if (!password) {
				alert('Please enter the admin token');
				statusDiv.innerHTML = '❌ No password entered';
				return;
			}
			
			try {
				// Show loading
				const debugInfo = document.getElementById('debugInfo');
				if (debugInfo) debugInfo.textContent = 'Logging in...';
				statusDiv.innerHTML = '🔄 Contacting server...';
				console.log('Attempting login...');
				
				const response = await fetch('/api/admin/login', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ password: password })
				});
				console.log('Login response received:', response.status);
				statusDiv.innerHTML = '🔄 Server responded...';
				
				const result = await response.json();
				
				if (result.success) {
					console.log('Login successful!', result);
					statusDiv.innerHTML = '✅ Login successful! Loading dashboard...';
					statusDiv.style.background = '#d4edda';
					statusDiv.style.color = '#155724';
					
					authToken = result.token;
					// Store in sessionStorage
					sessionStorage.setItem('adminToken', result.token);
					
					// Wait a moment so user can see the success message
					setTimeout(() => {
						// Show dashboard
						console.log('Hiding login screen...');
						document.getElementById('loginScreen').style.display = 'none';
						console.log('Showing dashboard...');
						document.getElementById('dashboard').classList.add('active');
						// Load leads
						console.log('Loading leads...');
						loadLeads();
					}, 500);
					
					if (debugInfo) debugInfo.textContent = 'Login successful ✓';
				} else {
					statusDiv.innerHTML = '❌ Login failed: ' + (result.message || 'Invalid token');
					statusDiv.style.background = '#f8d7da';
					statusDiv.style.color = '#721c24';
					if (debugInfo) debugInfo.textContent = 'Login failed ✗';
				}
			} catch (error) {
				statusDiv.innerHTML = '❌ Error: ' + error.message;
				statusDiv.style.background = '#f8d7da';
				statusDiv.style.color = '#721c24';
				const debugInfo = document.getElementById('debugInfo');
				if (debugInfo) debugInfo.textContent = 'Login error ✗';
			}
			});
		}); // End of DOMContentLoaded
		
		// Check if already logged in and load theme
		window.onload = function() {
			try {
				// Debug indicator
				const debugInfo = document.getElementById('debugInfo');
				if (debugInfo) debugInfo.textContent = 'JavaScript loaded ✓';
				
				// Load theme preference
				const savedTheme = localStorage.getItem('theme') || 'light';
				document.documentElement.setAttribute('data-theme', savedTheme);
				updateThemeIcon(savedTheme);
				// Initialize settings
				applySettings();
				const savedToken = sessionStorage.getItem('adminToken');
				if (savedToken) {
					authToken = savedToken;
					document.getElementById('loginScreen').style.display = 'none';
					document.getElementById('dashboard').classList.add('active');
					loadLeads();
					
					// Initialize Google Calendar after dashboard loads
					// For now, we're using direct Google Calendar links instead of OAuth
					setTimeout(async () => {
						// Set button to normal state
						const btn = document.getElementById('googleCalendarBtn');
						if (btn) {
							btn.style.background = '#4285f4';
						}
						
						// Load calendar events from database
						await //loadCalendarEvents();
					}, 500);
				}
			} catch (error) {
				alert('Page load error: ' + error.message);
			}
		};
		// Logout
		function logout() {
			sessionStorage.removeItem('adminToken');
			authToken = '';
			document.getElementById('dashboard').classList.remove('active');
			document.getElementById('loginScreen').style.display = 'flex';
		}
		// Load leads
		async function loadLeads() {
			console.log('loadLeads function called');
			const loadingState = document.getElementById('loadingState');
			const emptyState = document.getElementById('emptyState');
			const table = document.getElementById('leadsTable');
			
			if (!loadingState || !emptyState || !table) {
				console.error('Missing required elements:', {
					loadingState: !!loadingState,
					emptyState: !!emptyState,
					table: !!table
				});
				return;
			}
			
			loadingState.style.display = 'block';
			emptyState.style.display = 'none';
			table.style.display = 'none';
			try {
				const response = await fetch('/api/leads', {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.status === 401) {
					alert(`Invalid token: "${authToken}". Please login again.`);
					logout();
					return;
				}
				const data = await response.json();
				if (data.success) {
					allLeads = data.leads || [];
					filteredLeads = allLeads;
					updateStats();
					renderLeads();
				} else {
					throw new Error(data.message || 'Failed to load leads');
				}
			} catch (error) {
				console.error('Error loading leads:', error);
				if (emptyState) emptyState.style.display = 'block';
			} finally {
				loadingState.style.display = 'none';
			}
		}
		// Update stats
		function updateStats() {
			const totalLeads = allLeads.length;
			const newLeads = allLeads.filter(l => l.status === 'new').length;
			const qualifiedLeads = allLeads.filter(l => l.status === 'qualified').length;
			const closedWon = allLeads.filter(l => l.status === 'closed-won').length;
			const closedTotal = allLeads.filter(l => l.status.startsWith('closed')).length;
			const conversionRate = closedTotal > 0 ? Math.round((closedWon / closedTotal) * 100) : 0;
			document.getElementById('totalLeads').textContent = totalLeads;
			document.getElementById('newLeads').textContent = newLeads;
			document.getElementById('qualifiedLeads').textContent = qualifiedLeads;
			document.getElementById('conversionRate').textContent = conversionRate + '%';
			// Calculate growth (mock data for demo)
			const growth = Math.round(Math.random() * 30) + 10;
			document.getElementById('leadGrowth').textContent = `+${growth}% this month`;
		}
		// Render leads
		function renderLeads() {
			const tbody = document.getElementById('leadsTableBody');
			const table = document.getElementById('leadsTable');
			const emptyState = document.getElementById('emptyState');
			// Rendering filtered leads
			if (filteredLeads.length === 0) {
				table.style.display = 'none';
				emptyState.style.display = 'block';
				return;
			}
			table.style.display = 'table';
			emptyState.style.display = 'none';
			try {
				tbody.innerHTML = filteredLeads.map(lead => `
				<tr onclick="viewLead('${lead._id}')" style="cursor: pointer;">
					<td>${lead.createdAt ? new Date(lead.createdAt).toLocaleDateString() : 'N/A'}</td>
					<td><strong>${lead.name || 'Unknown'}</strong></td>
					<td>
						<div>${lead.email || 'No email'}</div>
						<div style="color: var(--gray); font-size: 12px;">${lead.phone || 'No phone'}</div>
					</td>
					<td><span class="project-type">${formatProjectType(lead.projectType || '')}</span></td>
					<td class="budget">$${(lead.budget || 0).toLocaleString()}</td>
					<td>${formatTimeline(lead.timeline || '')}</td>
					<td>
						<span class="status-badge ${lead.status || 'new'}">${(lead.status || 'new').replace('-', ' ')}</span>
					</td>
				</tr>
			`).join('');
			} catch (error) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error rendering leads. Check console for details.</td></tr>';
			}
		}
		// Format timeline
		function formatTimeline(timeline) {
			switch(timeline) {
				case 'asap': return 'ASAP';
				case '1-2months': return '1-2 Months';
				case '3-4months': return '3-4 Months';
				case 'flexible': return 'Flexible';
				default: return timeline;
			}
		}
		// Format project type
		function formatProjectType(type) {
			switch(type) {
				case 'business': return 'Business Website';
				case 'business-website': return 'Business Website';
				case 'ecommerce': return 'E-Commerce';
				case 'ecommerce-store': return 'E-Commerce Store';
				case 'webapp': return 'Web Application';
				case 'web-application': return 'Web Application';
				case 'landing': return 'Landing Page';
				case 'landing-page': return 'Landing Page';
				case 'mobile': return 'Mobile App';
				case 'other': return 'Other';
				default: return type;
			}
		}
		// Filter leads
		function filterLeads() {
			const statusFilter = document.getElementById('statusFilter').value;
			const projectFilter = document.getElementById('projectFilter').value;
			const budgetFilter = document.getElementById('budgetFilter').value;
			const searchTerm = document.getElementById('searchInput').value.toLowerCase();
			filteredLeads = allLeads.filter(lead => {
				// Status filter
				if (statusFilter && lead.status !== statusFilter) return false;
				// Project filter
				if (projectFilter) {
					const projectTypes = projectFilter.split(',');
					if (!projectTypes.includes(lead.projectType)) return false;
				}
				// Budget filter
				if (budgetFilter) {
					const budget = lead.budget;
					switch(budgetFilter) {
						case '0-1000':
							if (budget < 500 || budget >= 1000) return false;
							break;
						case '1000-5000':
							if (budget < 1000 || budget >= 5000) return false;
							break;
						case '5000-10000':
							if (budget < 5000 || budget >= 10000) return false;
							break;
						case '10000-25000':
							if (budget < 10000 || budget >= 25000) return false;
							break;
						case '25000+':
							if (budget < 25000) return false;
							break;
					}
				}
				// Search filter
				if (searchTerm) {
					const searchIn = `${lead.name} ${lead.email} ${lead.company || ''}`.toLowerCase();
					if (!searchIn.includes(searchTerm)) return false;
				}
				return true;
			});
			renderLeads();
		}
		// Current lead being viewed
		let currentLead = null;
		// View lead details with enhanced profile
		async function viewLead(leadId) {
			try {
				// Clear any previous lead references first
				currentLead = null;
				window.currentLeadId = null;
				currentLeadId = null;
				
				const lead = allLeads.find(l => l._id === leadId);
				if (!lead) {
					alert(`Customer not found. Lead ID: ${leadId}\nAvailable leads: ${allLeads.length}`);
					return;
				}
				currentLead = lead;
				window.currentLeadId = leadId;
				// Show modal first to provide immediate feedback
				const modal = document.getElementById('leadModal');
				if (!modal) {
					return;
				}
				modal.classList.add('active');
				// Populate profile header
				const initials = lead.name ? lead.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'NA';
				const avatarEl = document.getElementById('profileAvatar');
				const nameEl = document.getElementById('profileName');
				const subtitleEl = document.getElementById('profileSubtitle');
				if (avatarEl) avatarEl.textContent = initials;
				if (nameEl) {
					nameEl.textContent = lead.name || 'Unknown';
					nameEl.dataset.leadId = lead._id;
				}
				if (subtitleEl) subtitleEl.textContent = `${lead.email || 'No email'} • ${lead.phone || 'No phone'}`;
				// Store current lead ID globally
				currentLeadId = lead._id;
				// Populate tags
				const tagsContainer = document.getElementById('profileTags');
				if (tagsContainer) {
					const tags = getCustomerTags(lead);
					tagsContainer.innerHTML = tags.map(tag => 
						`<span class="tag ${tag.type}">${tag.text}</span>`
					).join('');
				}
				// Reset to overview tab first
				switchTab('overview');
				// Populate overview tab
				populateOverviewTab(lead);
				// Populate pipeline
				populatePipelineTab(lead);
				// Populate workflow
				await populateWorkflowTab(lead);
				// Populate communication
				populateCommunicationTab(lead);
				// Load async data in background
				try {
					await populateProfileStats(lead);
				} catch (error) {
				}
				try {
					await populateTimelineTab(lead);
				} catch (error) {
				}
			} catch (error) {
				alert(`Error opening customer profile: ${error.message}\n\nCheck the browser console for more details.`);
			}
		}
		// Get customer tags based on lead data
		function getCustomerTags(lead) {
			const tags = [];
			// Priority based on budget
			if (lead.budget >= 25000) {
				tags.push({ text: 'High Value', type: 'priority-high' });
			} else if (lead.budget >= 10000) {
				tags.push({ text: 'Medium Value', type: 'priority-medium' });
			} else {
				tags.push({ text: 'Standard', type: 'priority-low' });
			}
			// Timeline urgency
			if (lead.timeline === 'asap') {
				tags.push({ text: 'Urgent', type: 'priority-high' });
			}
			// Status-based tags
			if (lead.status === 'qualified') {
				tags.push({ text: 'Qualified', type: '' });
			} else if (lead.status === 'proposal') {
				tags.push({ text: 'Proposal Sent', type: '' });
			}
			return tags;
		}
		// Populate profile stats with real data
		async function populateProfileStats(lead) {
			const createdDate = new Date(lead.createdAt);
			const now = new Date();
			const daysAsCustomer = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
			document.getElementById('daysAsCustomer').textContent = daysAsCustomer;
			document.getElementById('projectValue').textContent = `$${(lead.budget || 0).toLocaleString()}`;
			// Get real interaction count
			try {
				const response = await fetch(`/api/leads/${lead._id}/interactions`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						document.getElementById('totalInteractions').textContent = result.data.length;
					} else {
						document.getElementById('totalInteractions').textContent = getInteractionCount(lead);
					}
				} else {
					document.getElementById('totalInteractions').textContent = getInteractionCount(lead);
				}
			} catch (error) {
				document.getElementById('totalInteractions').textContent = getInteractionCount(lead);
			}
			// Set response time based on email opens
			if (lead.lastEmailOpened) {
				const lastOpenTime = new Date(lead.lastEmailOpened);
				const hoursSinceOpen = Math.floor((now - lastOpenTime) / (1000 * 60 * 60));
				if (hoursSinceOpen < 1) {
					document.getElementById('responseTime').textContent = 'Recently active';
				} else if (hoursSinceOpen < 24) {
					document.getElementById('responseTime').textContent = `${hoursSinceOpen}h ago`;
				} else {
					document.getElementById('responseTime').textContent = getAverageResponseTime(lead);
				}
			} else {
				document.getElementById('responseTime').textContent = getAverageResponseTime(lead);
			}
		}
		// Get interaction count (mock data for now)
		function getInteractionCount(lead) {
			// This would come from actual interaction logs
			const baseInteractions = lead.status === 'new' ? 0 : 
								   lead.status === 'contacted' ? 2 : 
								   lead.status === 'qualified' ? 4 : 
								   lead.status === 'proposal' ? 6 : 8;
			return baseInteractions + Math.floor(Math.random() * 3);
		}
		// Get average response time (mock data)
		function getAverageResponseTime(lead) {
			const times = ['2h', '4h', '1d', '6h', '12h', '3h'];
			return times[Math.floor(Math.random() * times.length)];
		}
		// Populate overview tab
		function populateOverviewTab(lead) {
			// Editable fields
			document.getElementById('editableName').value = lead.name || '';
			document.getElementById('editableEmail').value = lead.email || '';
			document.getElementById('editablePhone').value = lead.phone || '';
			document.getElementById('editableCompany').value = lead.company || '';
			// Project details
			document.getElementById('projectType').textContent = `Type: ${formatProjectType(lead.projectType || '')}`;
			document.getElementById('projectBudget').textContent = `Budget: $${(lead.budget || 0).toLocaleString()}`;
			document.getElementById('projectTimeline').textContent = `Timeline: ${formatTimeline(lead.timeline || '')}`;
			document.getElementById('projectStatus').innerHTML = `Status: <span class="status-badge ${lead.status || 'new'}">${(lead.status || 'new').replace('-', ' ')}</span>`;
			// Features
			const featuresGroup = document.getElementById('featuresGroup');
			const featuresList = document.getElementById('featuresList');
			if (lead.features && lead.features.length > 0) {
				featuresGroup.style.display = 'block';
				featuresList.innerHTML = lead.features.map(f => `<li>${f}</li>`).join('');
			} else {
				featuresGroup.style.display = 'none';
			}
			// Message
			const messageGroup = document.getElementById('messageGroup');
			const additionalMessage = document.getElementById('additionalMessage');
			if (lead.message) {
				messageGroup.style.display = 'block';
				additionalMessage.textContent = lead.message;
			} else {
				messageGroup.style.display = 'none';
			}
			// Lead info
			document.getElementById('leadCreated').textContent = `Created: ${new Date(lead.createdAt).toLocaleString()}`;
			document.getElementById('leadId').textContent = `Lead ID: ${lead._id}`;
		}
		// Populate timeline tab with real interactions
		async function populateTimelineTab(lead) {
			const timeline = document.getElementById('interactionTimeline');
			try {
				// Fetch real interactions from server
				const response = await fetch(`/api/leads/${lead._id}/interactions`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						displayTimeline(result.data, lead);
						// Also fetch and add email tracking data to timeline
						await fetchEmailTrackingDataForTimeline(lead._id);
						return;
					}
				}
				// Fallback to mock data if API fails
				const interactions = generateTimelineData(lead);
				displayTimelineMock(interactions);
			} catch (error) {
				// Fallback to mock data
				const interactions = generateTimelineData(lead);
				displayTimelineMock(interactions);
			}
		}
		// Fetch email tracking data specifically for timeline
		async function fetchEmailTrackingDataForTimeline(leadId) {
			try {
				const response = await fetch(`/api/leads/${leadId}/email-tracking`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						// Add email activity to timeline
						addEmailActivityToTimeline(result.data);
					}
				}
			} catch (error) {
			}
		}
		// Display real timeline data
		function displayTimeline(interactions, lead) {
			const timeline = document.getElementById('interactionTimeline');
			// Always include lead creation as first interaction if not present
			const hasLeadCreation = interactions.some(i => i.type === 'status' && i.title === 'Lead Created');
			if (!hasLeadCreation) {
				interactions.unshift({
					type: 'status',
					title: 'Lead Created',
					description: `New lead from ${formatProjectType(lead.projectType)} inquiry`,
					timestamp: lead.createdAt
				});
			}
			if (interactions.length === 0) {
				timeline.innerHTML = `
					<div style="text-align: center; padding: 20px; color: var(--text-secondary);">
						<span class="material-icons" style="font-size: 48px; opacity: 0.5;">timeline</span>
						<p>No interactions found</p>
					</div>
				`;
				return;
			}
			// Sort interactions by timestamp - newest first (descending order)
			interactions.sort((a, b) => {
				const dateA = new Date(a.timestamp);
				const dateB = new Date(b.timestamp);
				return dateB - dateA; // Newest first
			});
			timeline.innerHTML = interactions.map(interaction => {
				const interactionTime = new Date(interaction.timestamp);
				const isIncoming = interaction.metadata?.isIncoming;
				const emailDirection = isIncoming ? 'incoming' : 'outgoing';
				const iconClass = interaction.type === 'email' ? `${interaction.type} ${emailDirection}` : interaction.type;
				return `
					<div class="timeline-item">
						<div class="timeline-icon ${iconClass}">
							<span class="material-icons">${getTimelineIcon(interaction.type, isIncoming)}</span>
						</div>
						<div class="timeline-content">
							<h4>${interaction.title}${isIncoming ? ' (Reply)' : ''}</h4>
							<p>${interaction.description || ''}</p>
							${interaction.metadata?.textContent ? `
								<div style="background: var(--light); padding: 10px; border-radius: 6px; margin-top: 8px; font-style: italic; font-size: 14px;">
									"${interaction.metadata.textContent}${interaction.metadata.textContent.length >= 500 ? '...' : ''}"
								</div>
							` : ''}
							<div class="timeline-time">${interactionTime.toLocaleString()}</div>
						</div>
					</div>
				`;
			}).join('');
		}
		// Display mock timeline data (fallback)
		function displayTimelineMock(interactions) {
			const timeline = document.getElementById('interactionTimeline');
			// Sort interactions by time - newest first (descending order)
			interactions.sort((a, b) => {
				const dateA = new Date(a.time);
				const dateB = new Date(b.time);
				return dateB - dateA; // Newest first
			});
			timeline.innerHTML = interactions.map(interaction => `
				<div class="timeline-item">
					<div class="timeline-icon ${interaction.type}">
						<span class="material-icons">${getTimelineIcon(interaction.type)}</span>
					</div>
					<div class="timeline-content">
						<h4>${interaction.title}</h4>
						<p>${interaction.description}</p>
						<div class="timeline-time">${interaction.time}</div>
					</div>
				</div>
			`).join('');
		}
		// Generate timeline data (mock for now)
		function generateTimelineData(lead) {
			const interactions = [];
			const createdDate = new Date(lead.createdAt);
			// Initial lead creation
			interactions.push({
				type: 'status',
				title: 'Lead Created',
				description: `New lead from ${formatProjectType(lead.projectType)} inquiry`,
				time: createdDate.toLocaleDateString()
			});
			// Add mock interactions based on status
			if (lead.status !== 'new') {
				interactions.push({
					type: 'email',
					title: 'Initial Contact',
					description: 'Welcome email sent with project brief questionnaire',
					time: new Date(createdDate.getTime() + 2 * 60 * 60 * 1000).toLocaleString()
				});
			}
			if (['qualified', 'proposal', 'closed-won', 'closed-lost'].includes(lead.status)) {
				interactions.push({
					type: 'call',
					title: 'Discovery Call',
					description: 'Discussed project requirements and timeline',
					time: new Date(createdDate.getTime() + 24 * 60 * 60 * 1000).toLocaleString()
				});
			}
			if (['proposal', 'closed-won', 'closed-lost'].includes(lead.status)) {
				interactions.push({
					type: 'email',
					title: 'Proposal Sent',
					description: `Detailed proposal for ${formatProjectType(lead.projectType)} project`,
					time: new Date(createdDate.getTime() + 3 * 24 * 60 * 60 * 1000).toLocaleString()
				});
			}
			return interactions.reverse(); // Show newest first
		}
		// Get timeline icon
		function getTimelineIcon(type, isIncoming = false) {
			switch(type) {
				case 'email': 
					return isIncoming ? 'mail_outline' : 'send';
				case 'call': return 'phone';
				case 'meeting': return 'event';
				case 'status': return 'update';
				default: return 'info';
			}
		}
		// Populate pipeline tab
		function populatePipelineTab(lead) {
			const pipeline = document.getElementById('projectPipeline');
			const stages = getPipelineStages(lead);
			pipeline.innerHTML = stages.map(stage => `
				<div class="pipeline-stage ${stage.status} ${stage.clickable ? 'clickable' : ''}" 
					 data-stage-index="${stage.stageIndex}">
					<div onclick="${stage.clickable ? `handleStageClick(${stage.stageIndex}, '${lead._id}')` : ''}"
						 title="${stage.clickable ? 'Click to advance to this stage' : ''}"
						 style="cursor: ${stage.clickable ? 'pointer' : 'default'};">
						<h4>
							<span class="material-icons">${stage.icon}</span>
							${stage.name}
							${stage.status === 'completed' ? '<span class="material-icons" style="color: var(--success); margin-left: auto;">check_circle</span>' : ''}
							${stage.status === 'active' ? '<span class="material-icons" style="color: var(--primary); margin-left: auto;">radio_button_checked</span>' : ''}
							${stage.clickable && stage.status === '' ? '<span class="material-icons" style="color: var(--gray); margin-left: auto; opacity: 0.5;">radio_button_unchecked</span>' : ''}
						</h4>
						<p>${stage.description}</p>
						<div class="stage-progress">
							<div class="stage-progress-bar" style="width: ${stage.progress}%"></div>
						</div>
						<small style="color: var(--gray);">${stage.progress}% Complete ${stage.clickable && stage.status === '' ? '• Click to advance' : ''}</small>
					</div>
					<div style="margin-top: 12px; display: flex; gap: 8px;">
						<button  
							style="background: #4285f4; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;"
							title="Schedule an event for this stage">
							<span class="material-icons" style="font-size: 16px;">event</span>
							Schedule
						</button>
					</div>
				</div>
			`).join('');
		}
		// Workflow data structures
		let workflowData = {
			items: [],
			columns: [],
			expandedItems: new Set()
		};
		// Default workflow columns configuration
		const defaultWorkflowColumns = [
			{ id: 'name', name: 'Item Name', type: 'text', width: 250, fixed: true, required: true },
			{ id: 'status', name: 'Status', type: 'status', width: 120, options: ['Not Started', 'In Progress', 'Completed', 'On Hold'] },
			{ id: 'priority', name: 'Priority', type: 'priority', width: 100, options: ['Low', 'Medium', 'High', 'Critical'] },
			{ id: 'assignee', name: 'Assignee', type: 'person', width: 120 },
			{ id: 'startDate', name: 'Start Date', type: 'date', width: 120 },
			{ id: 'dueDate', name: 'Due Date', type: 'date', width: 120 },
			{ id: 'progress', name: 'Progress', type: 'progress', width: 100 }
		];
		// Project templates
		const workflowTemplates = {
			'business-website': {
				name: 'Business Website',
				description: 'Professional business website with branding and SEO',
				items: [
					{
						name: 'Discovery & Branding',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Business requirements analysis', status: 'Not Started', priority: 'High' },
							{ name: 'Target audience research', status: 'Not Started', priority: 'High' },
							{ name: 'Competitive analysis', status: 'Not Started', priority: 'Medium' },
							{ name: 'Brand guidelines review', status: 'Not Started', priority: 'Medium' },
							{ name: 'Content strategy planning', status: 'Not Started', priority: 'High' }
						]
					},
					{
						name: 'Design & User Experience',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Site architecture planning', status: 'Not Started', priority: 'High' },
							{ name: 'Wireframe creation', status: 'Not Started', priority: 'High' },
							{ name: 'Custom design mockups', status: 'Not Started', priority: 'High' },
							{ name: 'Mobile responsive design', status: 'Not Started', priority: 'High' },
							{ name: 'Client design approval', status: 'Not Started', priority: 'Critical' }
						]
					},
					{
						name: 'Development & Integration',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Frontend development', status: 'Not Started', priority: 'High' },
							{ name: 'Content management setup', status: 'Not Started', priority: 'High' },
							{ name: 'Contact forms integration', status: 'Not Started', priority: 'Medium' },
							{ name: 'SEO optimization setup', status: 'Not Started', priority: 'High' },
							{ name: 'Performance optimization', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Launch & Support',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Content migration', status: 'Not Started', priority: 'High' },
							{ name: 'Testing across devices', status: 'Not Started', priority: 'High' },
							{ name: 'Domain & hosting setup', status: 'Not Started', priority: 'Critical' },
							{ name: 'Site launch', status: 'Not Started', priority: 'Critical' },
							{ name: 'Training & handover', status: 'Not Started', priority: 'Medium' }
						]
					}
				]
			},
			'ecommerce-store': {
				name: 'E-Commerce Store',
				description: 'Full-featured online store with payments and inventory',
				items: [
					{
						name: 'Store Planning & Setup',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Product catalog planning', status: 'Not Started', priority: 'High' },
							{ name: 'Payment gateway selection', status: 'Not Started', priority: 'Critical' },
							{ name: 'Shipping strategy planning', status: 'Not Started', priority: 'High' },
							{ name: 'Tax configuration planning', status: 'Not Started', priority: 'Medium' },
							{ name: 'Store policies creation', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Design & User Journey',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Store design mockups', status: 'Not Started', priority: 'High' },
							{ name: 'Product page design', status: 'Not Started', priority: 'High' },
							{ name: 'Checkout flow design', status: 'Not Started', priority: 'Critical' },
							{ name: 'Customer account design', status: 'Not Started', priority: 'Medium' },
							{ name: 'Mobile shopping optimization', status: 'Not Started', priority: 'High' }
						]
					},
					{
						name: 'E-Commerce Development',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Shopping cart implementation', status: 'Not Started', priority: 'Critical' },
							{ name: 'Payment processing setup', status: 'Not Started', priority: 'Critical' },
							{ name: 'Inventory management system', status: 'Not Started', priority: 'High' },
							{ name: 'Order management system', status: 'Not Started', priority: 'High' },
							{ name: 'Customer analytics setup', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Testing & Launch',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Payment testing', status: 'Not Started', priority: 'Critical' },
							{ name: 'Order fulfillment testing', status: 'Not Started', priority: 'Critical' },
							{ name: 'Product upload & setup', status: 'Not Started', priority: 'High' },
							{ name: 'Store launch', status: 'Not Started', priority: 'Critical' },
							{ name: 'Staff training', status: 'Not Started', priority: 'Medium' }
						]
					}
				]
			},
			'web-application': {
				name: 'Web Application',
				description: 'Custom web application with advanced functionality',
				items: [
					{
						name: 'Application Planning',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Functional requirements analysis', status: 'Not Started', priority: 'Critical' },
							{ name: 'Technical architecture planning', status: 'Not Started', priority: 'High' },
							{ name: 'Database schema design', status: 'Not Started', priority: 'High' },
							{ name: 'API planning & documentation', status: 'Not Started', priority: 'High' },
							{ name: 'Security requirements analysis', status: 'Not Started', priority: 'Critical' }
						]
					},
					{
						name: 'UI/UX Design',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'User flow mapping', status: 'Not Started', priority: 'High' },
							{ name: 'Wireframe creation', status: 'Not Started', priority: 'High' },
							{ name: 'Interactive prototypes', status: 'Not Started', priority: 'Medium' },
							{ name: 'UI component design', status: 'Not Started', priority: 'High' },
							{ name: 'User testing & feedback', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Backend Development',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Database setup & optimization', status: 'Not Started', priority: 'High' },
							{ name: 'API development', status: 'Not Started', priority: 'High' },
							{ name: 'User authentication system', status: 'Not Started', priority: 'Critical' },
							{ name: 'Real-time features implementation', status: 'Not Started', priority: 'Medium' },
							{ name: 'Third-party integrations', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Frontend Development',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Component development', status: 'Not Started', priority: 'High' },
							{ name: 'State management setup', status: 'Not Started', priority: 'High' },
							{ name: 'API integration', status: 'Not Started', priority: 'High' },
							{ name: 'Responsive implementation', status: 'Not Started', priority: 'High' },
							{ name: 'Performance optimization', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Deployment & Launch',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Cloud deployment setup', status: 'Not Started', priority: 'High' },
							{ name: 'CI/CD pipeline setup', status: 'Not Started', priority: 'Medium' },
							{ name: 'Security testing', status: 'Not Started', priority: 'Critical' },
							{ name: 'Performance testing', status: 'Not Started', priority: 'High' },
							{ name: 'Production launch', status: 'Not Started', priority: 'Critical' }
						]
					}
				]
			},
			'landing-page': {
				name: 'Landing Page',
				description: 'High-converting landing page for products or services',
				items: [
					{
						name: 'Strategy & Planning',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Conversion goal definition', status: 'Not Started', priority: 'Critical' },
							{ name: 'Target audience analysis', status: 'Not Started', priority: 'High' },
							{ name: 'Competitor landing page audit', status: 'Not Started', priority: 'Medium' },
							{ name: 'Key messaging development', status: 'Not Started', priority: 'High' },
							{ name: 'Call-to-action strategy', status: 'Not Started', priority: 'Critical' }
						]
					},
					{
						name: 'Content & Copy',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Headline & subheadline creation', status: 'Not Started', priority: 'Critical' },
							{ name: 'Benefits & features copy', status: 'Not Started', priority: 'High' },
							{ name: 'Social proof collection', status: 'Not Started', priority: 'Medium' },
							{ name: 'FAQ section creation', status: 'Not Started', priority: 'Medium' },
							{ name: 'Copy optimization & testing', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Design & Development',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Conversion-focused design', status: 'Not Started', priority: 'High' },
							{ name: 'Mobile-first implementation', status: 'Not Started', priority: 'High' },
							{ name: 'Form optimization', status: 'Not Started', priority: 'Critical' },
							{ name: 'Page speed optimization', status: 'Not Started', priority: 'High' },
							{ name: 'Analytics tracking setup', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Launch & Optimization',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'A/B testing setup', status: 'Not Started', priority: 'Medium' },
							{ name: 'Conversion tracking setup', status: 'Not Started', priority: 'High' },
							{ name: 'Page launch', status: 'Not Started', priority: 'Critical' },
							{ name: 'Performance monitoring', status: 'Not Started', priority: 'Medium' },
							{ name: 'Conversion optimization', status: 'Not Started', priority: 'Medium' }
						]
					}
				]
			},
			'mobile-app': {
				name: 'Mobile App',
				description: 'Native or hybrid mobile app for iOS and Android',
				items: [
					{
						name: 'App Planning & Strategy',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Platform selection (iOS/Android)', status: 'Not Started', priority: 'Critical' },
							{ name: 'Feature specification', status: 'Not Started', priority: 'Critical' },
							{ name: 'Technical architecture planning', status: 'Not Started', priority: 'High' },
							{ name: 'App store strategy', status: 'Not Started', priority: 'Medium' },
							{ name: 'Monetization planning', status: 'Not Started', priority: 'Low' }
						]
					},
					{
						name: 'UI/UX Design',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'User journey mapping', status: 'Not Started', priority: 'High' },
							{ name: 'Wireframes & prototypes', status: 'Not Started', priority: 'High' },
							{ name: 'Native design guidelines', status: 'Not Started', priority: 'High' },
							{ name: 'Icon & asset creation', status: 'Not Started', priority: 'Medium' },
							{ name: 'User testing & iteration', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'App Development',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Core functionality development', status: 'Not Started', priority: 'Critical' },
							{ name: 'Push notifications setup', status: 'Not Started', priority: 'Medium' },
							{ name: 'Offline support implementation', status: 'Not Started', priority: 'Medium' },
							{ name: 'API integration', status: 'Not Started', priority: 'High' },
							{ name: 'Performance optimization', status: 'Not Started', priority: 'High' }
						]
					},
					{
						name: 'Testing & Deployment',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Device testing (multiple devices)', status: 'Not Started', priority: 'Critical' },
							{ name: 'Beta testing program', status: 'Not Started', priority: 'Medium' },
							{ name: 'App store preparation', status: 'Not Started', priority: 'High' },
							{ name: 'App store submission', status: 'Not Started', priority: 'Critical' },
							{ name: 'Launch monitoring & support', status: 'Not Started', priority: 'Medium' }
						]
					}
				]
			},
			'api-development': {
				name: 'API Development',
				description: 'RESTful or GraphQL API with documentation',
				items: [
					{
						name: 'API Planning & Design',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'API specification (OpenAPI/GraphQL)', status: 'Not Started', priority: 'Critical' },
							{ name: 'Endpoint design & versioning', status: 'Not Started', priority: 'High' },
							{ name: 'Authentication strategy', status: 'Not Started', priority: 'Critical' },
							{ name: 'Rate limiting strategy', status: 'Not Started', priority: 'Medium' },
							{ name: 'Error handling design', status: 'Not Started', priority: 'High' }
						]
					},
					{
						name: 'Development & Implementation',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Core API development', status: 'Not Started', priority: 'Critical' },
							{ name: 'Database integration', status: 'Not Started', priority: 'High' },
							{ name: 'Authentication implementation', status: 'Not Started', priority: 'Critical' },
							{ name: 'Third-party integrations', status: 'Not Started', priority: 'Medium' },
							{ name: 'Validation & sanitization', status: 'Not Started', priority: 'High' }
						]
					},
					{
						name: 'Documentation & Testing',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'API documentation creation', status: 'Not Started', priority: 'High' },
							{ name: 'Interactive API explorer', status: 'Not Started', priority: 'Medium' },
							{ name: 'Unit testing', status: 'Not Started', priority: 'High' },
							{ name: 'Integration testing', status: 'Not Started', priority: 'High' },
							{ name: 'Load testing', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Deployment & Monitoring',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Production deployment', status: 'Not Started', priority: 'Critical' },
							{ name: 'API monitoring setup', status: 'Not Started', priority: 'High' },
							{ name: 'Analytics & usage tracking', status: 'Not Started', priority: 'Medium' },
							{ name: 'Security auditing', status: 'Not Started', priority: 'High' },
							{ name: 'Developer onboarding', status: 'Not Started', priority: 'Low' }
						]
					}
				]
			},
			'basic-project': {
				name: 'Basic Project',
				description: 'Simple project workflow for smaller tasks',
				items: [
					{
						name: 'Planning',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Define project goals', status: 'Not Started', priority: 'High' },
							{ name: 'Create project timeline', status: 'Not Started', priority: 'Medium' },
							{ name: 'Resource allocation', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Execution',
						type: 'item',
						status: 'Not Started',
						priority: 'High',
						subitems: [
							{ name: 'Complete core tasks', status: 'Not Started', priority: 'High' },
							{ name: 'Review progress regularly', status: 'Not Started', priority: 'Medium' },
							{ name: 'Client communication', status: 'Not Started', priority: 'Medium' }
						]
					},
					{
						name: 'Completion & Delivery',
						type: 'item',
						status: 'Not Started',
						priority: 'Medium',
						subitems: [
							{ name: 'Final quality review', status: 'Not Started', priority: 'High' },
							{ name: 'Client approval', status: 'Not Started', priority: 'Critical' },
							{ name: 'Project delivery', status: 'Not Started', priority: 'Critical' }
						]
					}
				]
			}
		};
		// Stage to status mapping for interactive pipeline
		const stageToStatusMap = {
			0: 'new',		// Initial Contact
			1: 'contacted',  // Discovery
			2: 'qualified',  // Proposal
			3: 'proposal',   // Negotiation
			4: 'closed-won'  // Project Start
		};
		const statusToStageMap = {
			'new': 0,
			'contacted': 1,
			'qualified': 2,
			'proposal': 3,
			'closed-won': 4,
			'closed-lost': 3  // Stops at negotiation
		};
		// Get pipeline stages based on lead status
		function getPipelineStages(lead) {
			const allStages = [
				{ name: 'Initial Contact', icon: 'person_add', description: 'Lead captured and initial contact made' },
				{ name: 'Discovery', icon: 'search', description: 'Understanding requirements and project scope' },
				{ name: 'Proposal', icon: 'description', description: 'Detailed proposal and pricing sent' },
				{ name: 'Negotiation', icon: 'handshake', description: 'Terms discussion and contract finalization' },
				{ name: 'Project Start', icon: 'play_arrow', description: 'Project kick-off and development begins' }
			];
			const statusMap = {
				'new': 0,
				'contacted': 1,
				'qualified': 2,
				'proposal': 3,
				'closed-won': 5,
				'closed-lost': 3
			};
			const currentStageIndex = statusMap[lead.status] || 0;
			return allStages.map((stage, index) => ({
				...stage,
				status: index < currentStageIndex ? 'completed' : 
					   index === currentStageIndex ? 'active' : '',
				progress: index < currentStageIndex ? 100 : 
						 index === currentStageIndex ? 50 : 0,
				stageIndex: index,
				clickable: index > currentStageIndex || (index < currentStageIndex && lead.status !== 'closed-lost')
			}));
		}
		// Handle stage click for pipeline interaction
		async function handleStageClick(stageIndex, leadId) {
			const lead = allLeads.find(l => l._id === leadId);
			if (!lead) {
				return;
			}
			const newStatus = stageToStatusMap[stageIndex];
			const currentStageIndex = statusToStageMap[lead.status] || 0;
			// Prevent backward progression (except for closed-lost)
			if (stageIndex < currentStageIndex && lead.status !== 'closed-lost') {
				if (!confirm(`Are you sure you want to move this lead backward to "${newStatus}" status?\n\nThis will change their current progress.`)) {
					return;
				}
			}
			// Show confirmation dialog
			const stageNames = ['Initial Contact', 'Discovery', 'Proposal', 'Negotiation', 'Project Start'];
			const confirmMsg = stageIndex > currentStageIndex 
				? `Advance lead to "${stageNames[stageIndex]}" stage (${newStatus} status)?`
				: `Move lead to "${stageNames[stageIndex]}" stage (${newStatus} status)?`;
			if (!confirm(confirmMsg)) {
				return;
			}
			try {
				// Add visual feedback
				const stageElement = document.querySelector(`[data-stage-index="${stageIndex}"]`);
				if (stageElement) {
					stageElement.style.opacity = '0.7';
					stageElement.style.pointerEvents = 'none';
				}
				const response = await fetch(`/api/leads/${leadId}`, {
					method: 'PATCH',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ status: newStatus })
				});
				const data = await response.json();
				if (data.success) {
					// Update local data
					lead.status = newStatus;
					// Refresh pipeline display
					populatePipelineTab(lead);
					// Update main leads table and stats
					renderLeads();
					updateStats();
					// Show success message
					showTemporaryMessage(`✅ Lead advanced to ${stageNames[stageIndex]} stage`);
				} else {
					throw new Error(data.message || 'Failed to update status');
				}
			} catch (error) {
				alert(`Error updating stage: ${error.message}`);
				// Restore visual state
				const stageElement = document.querySelector(`[data-stage-index="${stageIndex}"]`);
				if (stageElement) {
					stageElement.style.opacity = '';
					stageElement.style.pointerEvents = '';
				}
			}
		}
		// Show temporary success message
		function showTemporaryMessage(message) {
			const messageDiv = document.createElement('div');
			messageDiv.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				background: var(--success);
				color: white;
				padding: 12px 20px;
				border-radius: 6px;
				font-size: 14px;
				font-weight: 500;
				z-index: 10000;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
				transform: translateX(100%);
				transition: transform 0.3s ease;
			`;
			messageDiv.textContent = message;
			document.body.appendChild(messageDiv);
			// Animate in
			setTimeout(() => {
				messageDiv.style.transform = 'translateX(0)';
			}, 10);
			// Remove after 3 seconds
			setTimeout(() => {
				messageDiv.style.transform = 'translateX(100%)';
				setTimeout(() => {
					if (messageDiv.parentNode) {
						messageDiv.parentNode.removeChild(messageDiv);
					}
				}, 300);
			}, 3000);
		}
		// Initialize and populate workflow tab
		async function populateWorkflowTab(lead) {
			// Set current lead ID for save operations
			currentLeadId = lead._id;
			// Load fresh workflow data from server
			await loadWorkflowData(lead._id);
			renderWorkflowBoard();
		}
		// Load workflow data from server
		async function loadWorkflowData(leadId) {
			try {
				const response = await fetch(`/api/leads/${leadId}/workflow`, {
					method: 'GET',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					}
				});
				if (!response.ok) {
					throw new Error(`Load failed with status: ${response.status}`);
				}
				const result = await response.json();
				// Update workflowData with server data
				const loadedItems = result.data.workflowItems || [];
				const loadedColumns = result.data.workflowColumns || [...defaultWorkflowColumns];
				workflowData.items = loadedItems;
				workflowData.columns = loadedColumns;
			} catch (error) {
				// Fallback to default initialization
				workflowData.items = [];
				workflowData.columns = [...defaultWorkflowColumns];
			}
		}
		// Initialize workflow data structure
		function initializeWorkflowData(lead) {
			workflowData.columns = [...defaultWorkflowColumns];
			// Check if lead has existing workflow data
			if (lead.workflowItems && lead.workflowItems.length > 0) {
				workflowData.items = lead.workflowItems;
			} else {
				// Start with empty workflow - user can add items or apply template
				workflowData.items = [];
			}
		}
		// Render the complete workflow board
		function renderWorkflowBoard() {
			const workflowBoard = document.getElementById('workflowBoard');
			workflowBoard.innerHTML = `
				<div class="workflow-header">
					<div>
						<h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">Project Workflow</h3>
						<p style="margin: 0; font-size: 14px; color: var(--text-secondary);">Manage tasks and track project progress</p>
					</div>
					<div class="workflow-actions">
						<button class="workflow-btn secondary" onclick="showTemplateSelector()">
							<span class="material-icons" style="font-size: 16px;">library_add</span>
							Apply Template
						</button>
						<button class="workflow-btn primary" onclick="addWorkflowItem()">
							<span class="material-icons" style="font-size: 16px;">add</span>
							Add Item
						</button>
						<div style="position: relative; display: inline-block;">
							<button class="workflow-btn secondary" onclick="toggleQuickColumnMenu()" id="quickColumnBtn">
								<span class="material-icons" style="font-size: 16px;">add_box</span>
								Add Column
								<span class="material-icons" style="font-size: 16px; margin-left: 4px;">arrow_drop_down</span>
							</button>
							<div id="quickColumnMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; margin-top: 4px;">
								<!-- Quick add column options will be populated here -->
							</div>
						</div>
						<button class="workflow-btn secondary" onclick="manageWorkflowColumns()">
							<span class="material-icons" style="font-size: 16px;">settings</span>
							Manage
						</button>
					</div>
				</div>
				<div class="workflow-table-container" style="overflow-x: auto; max-height: 600px;">
					<table class="workflow-table">
						<thead>
							${renderWorkflowHeaders()}
						</thead>
						<tbody>
							${renderWorkflowRows()}
						</tbody>
					</table>
				</div>
				${workflowData.items.length === 0 ? renderEmptyWorkflowState() : ''}
			`;
		}
		// Render table headers
		function renderWorkflowHeaders() {
			return `
				<tr>
					<th style="width: 40px;">
						<input type="checkbox" class="workflow-checkbox" onchange="toggleAllWorkflowItems(this.checked)">
					</th>
					${workflowData.columns.map(col => `
						<th style="width: ${col.width}px;">
							${col.name}
							${!col.fixed ? '<span class="material-icons" style="font-size: 14px; opacity: 0.5; margin-left: 4px; cursor: pointer;" onclick="removeColumn(\'' + col.id + '\')">close</span>' : ''}
						</th>
					`).join('')}
				</tr>
			`;
		}
		// Render workflow rows (items and subitems)
		function renderWorkflowRows() {
			if (workflowData.items.length === 0) {
				return '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: var(--text-secondary);">No workflow items yet. Add an item or apply a template to get started.</td></tr>';
			}
			let html = '';
			workflowData.items.forEach((item, index) => {
				html += renderWorkflowRow(item, index, 'item');
				if (item.subitems && workflowData.expandedItems.has(item.id || index)) {
					item.subitems.forEach((subitem, subIndex) => {
						html += renderWorkflowRow(subitem, `${index}-${subIndex}`, 'subitem', index);
					});
				} else {
				}
			});
			return html;
		}
		// Render individual workflow row
		function renderWorkflowRow(item, itemIndex, itemType, parentIndex = null) {
			const isExpanded = workflowData.expandedItems.has(item.id || itemIndex);
			const hasSubitems = item.subitems && item.subitems.length > 0;
			return `
				<tr class="workflow-row" data-item-index="${itemIndex}" data-item-type="${itemType}">
					<td>
						<input type="checkbox" class="workflow-checkbox" data-item-index="${itemIndex}">
					</td>
					${workflowData.columns.map(col => renderWorkflowCell(item, col, itemIndex, itemType, hasSubitems, isExpanded)).join('')}
					<td class="workflow-actions-cell">
						<button class="workflow-btn primary" /g, '&quot;')})" title="Schedule Meeting">
							<span class="material-icons" style="font-size: 14px;">event</span>
						</button>
						${itemType === 'item' ? `
							<button class="workflow-btn secondary" onclick="addSubitem(${itemIndex})" title="Add Subitem">
								<span class="material-icons" style="font-size: 14px;">add</span>
							</button>
						` : ''}
						<button class="workflow-btn secondary" onclick="duplicateWorkflowItem('${itemIndex}')" title="Duplicate">
							<span class="material-icons" style="font-size: 14px;">content_copy</span>
						</button>
						<button class="workflow-btn danger" onclick="deleteWorkflowItem('${itemIndex}')" title="Delete">
							<span class="material-icons" style="font-size: 14px;">delete</span>
						</button>
					</td>
				</tr>
			`;
		}
		// Render individual cell based on column type
		function renderWorkflowCell(item, column, itemIndex, itemType, hasSubitems, isExpanded) {
			const value = item[column.id] || '';
			// Handle formula columns
			if (column.type === 'formula') {
				const calculatedValue = calculateFormula(column.formula, item, itemIndex);
				return `
					<td class="workflow-cell" style="color: #111827; font-weight: 500; background-color: #f8fafc;">
						<span class="material-icons" style="font-size: 14px; color: var(--primary); margin-right: 4px;">functions</span>
						${calculatedValue}
					</td>
				`;
			}
			switch (column.id) {
				case 'name':
					return `
						<td class="workflow-cell">
							<div class="workflow-item ${itemType}">
								${itemType === 'item' && hasSubitems ? `
									<button class="workflow-expand-btn ${isExpanded ? 'expanded' : ''}" onclick="toggleWorkflowItem('${itemIndex}')">
										<span class="material-icons">chevron_right</span>
									</button>
								` : '<div style="width: 20px;"></div>'}
								<span class="material-icons" style="font-size: 16px; color: var(--text-secondary);">
									${itemType === 'item' ? 'folder' : 'description'}
								</span>
								<span class="workflow-cell editable" onclick="editWorkflowCell(this, '${itemIndex}', 'name')" style="color: #111827; font-weight: 500;">${value || 'Untitled'}</span>
							</div>
						</td>
					`;
				case 'status':
					return `
						<td class="workflow-cell">
							<div class="status-badge ${getStatusClass(value)}" onclick="editStatusCell('${itemIndex}', 'status')">
								<span class="material-icons" style="font-size: 12px;">${getStatusIcon(value)}</span>
								${value || 'Not Started'}
							</div>
						</td>
					`;
				case 'priority':
					return `
						<td class="workflow-cell">
							<div class="priority-badge ${getPriorityClass(value)}" onclick="editPriorityCell('${itemIndex}', 'priority')">
								<span class="material-icons" style="font-size: 12px;">${getPriorityIcon(value)}</span>
								${value || 'Medium'}
							</div>
						</td>
					`;
				case 'progress':
					return `
						<td class="workflow-cell">
							<div class="progress-bar" onclick="editProgressCell('${itemIndex}')">
								<div class="progress-fill" style="width: ${value || 0}%"></div>
							</div>
							<small style="font-size: 11px; color: var(--text-secondary); margin-left: 4px;">${value || 0}%</small>
						</td>
					`;
				case 'startDate':
				case 'dueDate':
					const dateValue = value ? new Date(value).toLocaleDateString() : '-';
					const hasCalendarEvent = item.calendarEventId ? true : false;
					const dateColor = column.id === 'dueDate' && value && new Date(value) < new Date() ? '#ef4444' : '#111827';
					return `
						<td class="workflow-cell editable" onclick="editDateCell('${itemIndex}', '${column.id}')" style="color: ${dateColor}; font-weight: 500;">
							<div style="display: flex; align-items: center; gap: 4px;">
								${dateValue}
								${hasCalendarEvent ? '<span class="material-icons" style="font-size: 14px; color: #4285f4;" title="Synced to calendar">event_available</span>' : ''}
							</div>
						</td>
					`;
				default:
					// Handle custom column types
					if (column.type === 'date') {
						// Handle any custom date column
						const dateValue = value ? new Date(value).toLocaleDateString() : '-';
						const isPastDue = value && new Date(value) < new Date();
						const dateColor = isPastDue ? '#ef4444' : '#111827';
						return `
							<td class="workflow-cell editable" onclick="editDateCell('${itemIndex}', '${column.id}')" style="color: ${dateColor}; font-weight: 500;">
								<div style="display: flex; align-items: center; gap: 4px;">
									${dateValue}
									${isPastDue ? '<span class="material-icons" style="font-size: 14px; color: #ef4444;" title="Past due">error</span>' : ''}
								</div>
							</td>
						`;
					} else if (column.type === 'checkbox') {
						return `
							<td class="workflow-cell" onclick="toggleCheckbox('${itemIndex}', '${column.id}')" style="text-align: center; cursor: pointer;">
								<input type="checkbox" ${value ? 'checked' : ''} style="pointer-events: none;">
							</td>
						`;
					} else if (column.type === 'url') {
						return `
							<td class="workflow-cell editable" onclick="editWorkflowCell(this, '${itemIndex}', '${column.id}')" style="color: #111827; font-weight: 500;">
								${value ? `<a href="${value}" target="_blank"  style="color: var(--primary); text-decoration: none;">
									<span class="material-icons" style="font-size: 14px; vertical-align: middle;">link</span>
									${value.length > 20 ? value.substring(0, 20) + '...' : value}
								</a>` : '-'}
							</td>
						`;
					} else if (column.type === 'email') {
						return `
							<td class="workflow-cell editable" onclick="editWorkflowCell(this, '${itemIndex}', '${column.id}')" style="color: #111827; font-weight: 500;">
								${value ? `<a href="mailto:${value}"  style="color: var(--primary); text-decoration: none;">
									<span class="material-icons" style="font-size: 14px; vertical-align: middle;">email</span>
									${value}
								</a>` : '-'}
							</td>
						`;
					} else if (column.type === 'phone') {
						return `
							<td class="workflow-cell editable" onclick="editWorkflowCell(this, '${itemIndex}', '${column.id}')" style="color: #111827; font-weight: 500;">
								${value ? `<a href="tel:${value}"  style="color: var(--primary); text-decoration: none;">
									<span class="material-icons" style="font-size: 14px; vertical-align: middle;">phone</span>
									${value}
								</a>` : '-'}
							</td>
						`;
					} else if (column.type === 'select' && column.options) {
						return `
							<td class="workflow-cell" onclick="editSelectCell('${itemIndex}', '${column.id}', '${column.options.join(',')}')" style="color: #111827; font-weight: 500; cursor: pointer;">
								<div style="display: flex; align-items: center; gap: 4px;">
									${value || 'Select...'}
									<span class="material-icons" style="font-size: 14px; color: var(--text-secondary);">arrow_drop_down</span>
								</div>
							</td>
						`;
					} else if (column.type === 'number') {
						return `
							<td class="workflow-cell editable" onclick="editNumberCell('${itemIndex}', '${column.id}')" style="color: #111827; font-weight: 500;">
								${value !== undefined && value !== '' ? value : '-'}
							</td>
						`;
					} else {
						return `
							<td class="workflow-cell editable" onclick="editWorkflowCell(this, '${itemIndex}', '${column.id}')" style="color: #111827; font-weight: 500;">
								${value || '-'}
							</td>
						`;
					}
			}
		}
		// Calculate formula values
		function calculateFormula(formula, item, itemIndex) {
			try {
				// Helper functions available in formulas
				const daysUntil = (dateStr) => {
					if (!dateStr) return '-';
					const dueDate = new Date(dateStr);
					const today = new Date();
					const diffTime = dueDate - today;
					const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
					return diffDays;
				};
				const daysSince = (dateStr) => {
					if (!dateStr) return '-';
					const startDate = new Date(dateStr);
					const today = new Date();
					const diffTime = today - startDate;
					const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
					return diffDays;
				};
				const countSubitems = () => {
					return item.subitems ? item.subitems.length : 0;
				};
				const completedSubitems = () => {
					if (!item.subitems) return 0;
					return item.subitems.filter(sub => sub.status === 'Completed').length;
				};
				// Create a safe evaluation context with item properties and helper functions
				const context = {
					...item,
					daysUntil,
					daysSince,
					countSubitems,
					completedSubitems,
					// Math functions
					Math,
					// Conditional function
					if: (condition, trueValue, falseValue) => condition ? trueValue : falseValue
				};
				// Replace variable references in formula
				let evaluatedFormula = formula;
				// Replace simple property references
				Object.keys(item).forEach(key => {
					const regex = new RegExp(`\\b${key}\\b`, 'g');
					const value = item[key];
					if (typeof value === 'string') {
						evaluatedFormula = evaluatedFormula.replace(regex, `"${value}"`);
					} else {
						evaluatedFormula = evaluatedFormula.replace(regex, value || 0);
					}
				});
				// Simple formula evaluation (safe subset)
				if (formula.includes('daysUntil(')) {
					return daysUntil(item.dueDate);
				}
				if (formula.includes('daysSince(')) {
					return daysSince(item.createdDate);
				}
				if (formula.includes('countSubitems()')) {
					return countSubitems();
				}
				if (formula.includes('completedSubitems()')) {
					return completedSubitems();
				}
				// Handle simple mathematical operations
				if (/^[\d\s+\-*\/()\.]+$/.test(evaluatedFormula)) {
					return eval(evaluatedFormula);
				}
				// Handle progress calculations
				if (formula.includes('progress')) {
					const progressValue = item.progress || 0;
					if (formula === 'progress * 100') {
						return progressValue + '%';
					}
					return progressValue;
				}
				return evaluatedFormula;
			} catch (error) {
				return 'Error';
			}
		}
		// Empty state when no workflow items
		function renderEmptyWorkflowState() {
			return `
				<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
					<span class="material-icons" style="font-size: 48px; color: var(--border-color); margin-bottom: 16px;">view_list</span>
					<h3 style="margin: 0 0 8px 0; font-weight: 500;">No workflow items yet</h3>
					<p style="margin: 0 0 24px 0;">Get started by applying a project template or adding your first item</p>
					<div class="workflow-templates">
						<button class="template-btn" onclick="applyWorkflowTemplate('web-development')">
							<span class="material-icons" style="font-size: 16px; margin-right: 4px;">web</span>
							Web Development
						</button>
						<button class="template-btn" onclick="applyWorkflowTemplate('basic-project')">
							<span class="material-icons" style="font-size: 16px; margin-right: 4px;">task</span>
							Basic Project
						</button>
					</div>
				</div>
			`;
		}
		// Helper functions for workflow styling
		function getStatusClass(status) {
			const classMap = {
				'Not Started': 'not-started',
				'In Progress': 'in-progress',
				'Completed': 'completed',
				'On Hold': 'on-hold'
			};
			return classMap[status] || 'not-started';
		}
		function getStatusIcon(status) {
			const iconMap = {
				'Not Started': 'radio_button_unchecked',
				'In Progress': 'pending',
				'Completed': 'check_circle',
				'On Hold': 'pause_circle'
			};
			return iconMap[status] || 'radio_button_unchecked';
		}
		function getPriorityClass(priority) {
			const classMap = {
				'Low': 'low',
				'Medium': 'medium',
				'High': 'high',
				'Critical': 'critical'
			};
			return classMap[priority] || 'medium';
		}
		function getPriorityIcon(priority) {
			const iconMap = {
				'Low': 'keyboard_arrow_down',
				'Medium': 'remove',
				'High': 'keyboard_arrow_up',
				'Critical': 'priority_high'
			};
			return iconMap[priority] || 'remove';
		}
		// Workflow interaction functions
		function toggleWorkflowItem(itemIndex) {
			const itemId = workflowData.items[itemIndex].id || itemIndex;
			if (workflowData.expandedItems.has(itemId)) {
				workflowData.expandedItems.delete(itemId);
			} else {
				workflowData.expandedItems.add(itemId);
			}
			renderWorkflowBoard();
		}
		function addWorkflowItem() {
			const newItem = {
				id: generateWorkflowId(),
				name: 'New Task',
				status: 'Not Started',
				priority: 'Medium',
				assignee: '',
				dueDate: '',
				progress: 0,
				subitems: []
			};
			workflowData.items.push(newItem);
			renderWorkflowBoard();
			saveWorkflowData();
		}
		function addSubitem(parentIndex) {
			const newSubitem = {
				id: generateWorkflowId(),
				name: 'New Subtask',
				status: 'Not Started',
				priority: 'Medium',
				assignee: '',
				dueDate: '',
				progress: 0
			};
			if (!workflowData.items[parentIndex].subitems) {
				workflowData.items[parentIndex].subitems = [];
			}
			workflowData.items[parentIndex].subitems.push(newSubitem);
			// Expand parent item to show new subitem
			const parentId = workflowData.items[parentIndex].id || parentIndex;
			workflowData.expandedItems.add(parentId);
			renderWorkflowBoard();
			saveWorkflowData();
		}
		function deleteWorkflowItem(itemIndex) {
			const indexParts = itemIndex.toString().split('-');
			if (indexParts.length === 1) {
				// Delete main item
				const index = parseInt(indexParts[0]);
				const itemName = workflowData.items[index].name;
				if (confirm(`Delete "${itemName}" and all its subitems?`)) {
					workflowData.items.splice(index, 1);
					renderWorkflowBoard();
					saveWorkflowData();
				}
			} else {
				// Delete subitem
				const parentIndex = parseInt(indexParts[0]);
				const subIndex = parseInt(indexParts[1]);
				const subitemName = workflowData.items[parentIndex].subitems[subIndex].name;
				if (confirm(`Delete "${subitemName}"?`)) {
					workflowData.items[parentIndex].subitems.splice(subIndex, 1);
					renderWorkflowBoard();
					saveWorkflowData();
				}
			}
		}
		function duplicateWorkflowItem(itemIndex) {
			const indexParts = itemIndex.toString().split('-');
			if (indexParts.length === 1) {
				// Duplicate main item
				const index = parseInt(indexParts[0]);
				const originalItem = workflowData.items[index];
				const duplicatedItem = {
					...originalItem,
					id: generateWorkflowId(),
					name: originalItem.name + ' (Copy)',
					subitems: originalItem.subitems ? originalItem.subitems.map(sub => ({
						...sub,
						id: generateWorkflowId()
					})) : []
				};
				workflowData.items.splice(index + 1, 0, duplicatedItem);
				renderWorkflowBoard();
				saveWorkflowData();
			} else {
				// Duplicate subitem
				const parentIndex = parseInt(indexParts[0]);
				const subIndex = parseInt(indexParts[1]);
				const originalSubitem = workflowData.items[parentIndex].subitems[subIndex];
				const duplicatedSubitem = {
					...originalSubitem,
					id: generateWorkflowId(),
					name: originalSubitem.name + ' (Copy)'
				};
				workflowData.items[parentIndex].subitems.splice(subIndex + 1, 0, duplicatedSubitem);
				renderWorkflowBoard();
				saveWorkflowData();
			}
		}
		function applyWorkflowTemplate(templateKey) {
			if (!workflowTemplates[templateKey]) {
				showTemporaryMessage('❌ Template not found');
				return;
			}
			const template = workflowTemplates[templateKey];
			if (workflowData.items.length > 0) {
				if (!confirm(`This will replace your current workflow with the "${template.name}" template. Continue?`)) {
					return;
				}
			}
			// Ensure columns are set to default when applying template
			workflowData.columns = [...defaultWorkflowColumns];
			workflowData.items = template.items.map(item => ({
				...item,
				id: generateWorkflowId(),
				subitems: item.subitems ? item.subitems.map(sub => ({
					...sub,
					id: generateWorkflowId()
				})) : []
			}));
			// Expand all items by default when applying template
			workflowData.expandedItems.clear();
			workflowData.items.forEach((item, index) => {
				if (item.subitems && item.subitems.length > 0) {
					workflowData.expandedItems.add(item.id || index);
				}
			});
			renderWorkflowBoard();
			saveWorkflowData();
			showTemporaryMessage(`✅ Applied "${template.name}" template`);
		}
		// Generate unique ID for workflow items
		function generateWorkflowId() {
			return 'wf_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
		}
		// Save workflow data to server
		async function saveWorkflowData() {
			try {
				const currentLead = getCurrentLead();
				// Alternative ways to get lead ID if getCurrentLead fails
				let leadId = currentLead?._id;
				if (!leadId) {
					// Try to get from profile modal
					const profileName = document.getElementById('profileName');
					leadId = profileName?.dataset?.leadId;
				}
				if (!leadId) {
					// Try global variable
					leadId = currentLeadId || window.currentLeadId;
				}
				if (!leadId) {
					showTemporaryMessage('❌ Cannot save - no lead selected');
					return;
				}
				const payload = {
					workflowItems: workflowData.items,
					workflowColumns: workflowData.columns
				};
				const response = await fetch(`/api/leads/${leadId}/workflow`, {
					method: 'PUT',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload)
				});
				if (!response.ok) {
					throw new Error(`Save failed with status: ${response.status}`);
				}
				const result = await response.json();
			} catch (error) {
				showTemporaryMessage('❌ Failed to save workflow data');
			}
		}
		function getCurrentLead() {
			// Get current lead from profile modal or global variable
			const profileName = document.getElementById('profileName');
			const leadId = profileName ? profileName.dataset.leadId : currentLeadId;
			const lead = allLeads.find(l => l._id === leadId);
			return lead;
		}
		let currentLeadId = null;
		// Inline editing functions
		function editWorkflowCell(element, itemIndex, columnId) {
			const currentValue = element.textContent.trim();
			const input = document.createElement('input');
			input.type = 'text';
			input.value = currentValue === 'Untitled' || currentValue === '-' ? '' : currentValue;
			input.style.cssText = 'width: 100%; border: 1px solid var(--primary); border-radius: 4px; padding: 4px 8px; font-size: 14px;';
			element.textContent = '';
			element.appendChild(input);
			input.focus();
			input.select();
			const saveEdit = () => {
				const newValue = input.value.trim() || (columnId === 'name' ? 'Untitled' : '');
				updateWorkflowItemValue(itemIndex, columnId, newValue);
				element.textContent = newValue || '-';
			};
			input.addEventListener('blur', saveEdit);
			input.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') {
					e.preventDefault();
					input.blur();
				} else if (e.key === 'Escape') {
					element.textContent = currentValue;
				}
			});
		}
		function editStatusCell(itemIndex, columnId) {
			const statusOptions = ['Not Started', 'In Progress', 'Completed', 'On Hold'];
			const currentValue = getWorkflowItemValue(itemIndex, columnId) || 'Not Started';
			showDropdownEditor(itemIndex, columnId, statusOptions, currentValue, (newValue) => {
				updateWorkflowItemValue(itemIndex, columnId, newValue);
				renderWorkflowBoard();
				saveWorkflowData();
			});
		}
		function editPriorityCell(itemIndex, columnId) {
			const priorityOptions = ['Low', 'Medium', 'High', 'Critical'];
			const currentValue = getWorkflowItemValue(itemIndex, columnId) || 'Medium';
			showDropdownEditor(itemIndex, columnId, priorityOptions, currentValue, (newValue) => {
				updateWorkflowItemValue(itemIndex, columnId, newValue);
				renderWorkflowBoard();
				saveWorkflowData();
			});
		}
		function editProgressCell(itemIndex) {
			const currentValue = getWorkflowItemValue(itemIndex, 'progress') || 0;
			const newValue = prompt('Enter progress percentage (0-100):', currentValue);
			if (newValue !== null) {
				const numValue = parseInt(newValue);
				if (numValue >= 0 && numValue <= 100) {
					updateWorkflowItemValue(itemIndex, 'progress', numValue);
					renderWorkflowBoard();
					saveWorkflowData();
				} else {
					alert('Progress must be between 0 and 100');
				}
			}
		}
		
		// Edit number cell
		function editNumberCell(itemIndex, columnId) {
			const currentValue = getWorkflowItemValue(itemIndex, columnId) || 0;
			const newValue = prompt('Enter number:', currentValue);
			if (newValue !== null) {
				const numValue = parseFloat(newValue) || 0;
				updateWorkflowItemValue(itemIndex, columnId, numValue);
				renderWorkflowBoard();
				saveWorkflowData();
			}
		}
		
		// Toggle checkbox
		function toggleCheckbox(itemIndex, columnId) {
			const currentValue = getWorkflowItemValue(itemIndex, columnId) || false;
			updateWorkflowItemValue(itemIndex, columnId, !currentValue);
			renderWorkflowBoard();
			saveWorkflowData();
		}
		
		// Edit select cell with custom options
		function editSelectCell(itemIndex, columnId, optionsStr) {
			const options = optionsStr.split(',');
			const currentValue = getWorkflowItemValue(itemIndex, columnId) || '';
			showDropdownEditor(itemIndex, columnId, options, currentValue, (newValue) => {
				updateWorkflowItemValue(itemIndex, columnId, newValue);
				renderWorkflowBoard();
				saveWorkflowData();
			});
		}
		function editDateCell(itemIndex, columnId) {
			const currentValue = getWorkflowItemValue(itemIndex, columnId);
			const input = document.createElement('input');
			input.type = 'date';
			input.value = currentValue ? new Date(currentValue).toISOString().split('T')[0] : '';
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; right: 0; bottom: 0;
				background: rgba(0,0,0,0.5); display: flex; align-items: center; 
				justify-content: center; z-index: 10000;
			`;
			const dialog = document.createElement('div');
			dialog.style.cssText = `
				background: white; padding: 20px; border-radius: 8px;
				box-shadow: 0 4px 20px rgba(0,0,0,0.2);
			`;
			// Get column name for title
			const column = workflowData.columns.find(c => c.id === columnId);
			const dateTitle = column ? column.name : 'Date';
			dialog.innerHTML = `
				<h4 style="margin: 0 0 15px 0;">Set ${dateTitle}</h4>
				<div style="margin-bottom: 15px;"></div>
				<div style="display: flex; gap: 10px; justify-content: flex-end;">
					<button class="workflow-btn secondary" id="cancel-date">Cancel</button>
					<button class="workflow-btn primary" id="save-date">Save</button>
					<button class="workflow-btn danger" id="clear-date">Clear</button>
				</div>
			`;
			dialog.children[1].appendChild(input);
			modal.appendChild(dialog);
			document.body.appendChild(modal);
			input.focus();
			dialog.querySelector('#save-date').onclick = () => {
				updateWorkflowItemValue(itemIndex, columnId, input.value);
				renderWorkflowBoard();
				saveWorkflowData();
				document.body.removeChild(modal);
			};
			dialog.querySelector('#clear-date').onclick = () => {
				updateWorkflowItemValue(itemIndex, columnId, '');
				renderWorkflowBoard();
				saveWorkflowData();
				document.body.removeChild(modal);
			};
			dialog.querySelector('#cancel-date').onclick = () => {
				document.body.removeChild(modal);
			};
			modal.onclick = (e) => {
				if (e.target === modal) {
					document.body.removeChild(modal);
				}
			};
		}
		function showDropdownEditor(itemIndex, columnId, options, currentValue, onSave) {
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; right: 0; bottom: 0;
				background: rgba(0,0,0,0.5); display: flex; align-items: center; 
				justify-content: center; z-index: 10000;
			`;
			const dialog = document.createElement('div');
			dialog.style.cssText = `
				background: white; padding: 20px; border-radius: 8px;
				box-shadow: 0 4px 20px rgba(0,0,0,0.2); min-width: 200px;
			`;
			dialog.innerHTML = `
				<h4 style="margin: 0 0 15px 0;">Select ${columnId}</h4>
				<div class="dropdown-options" style="display: flex; flex-direction: column; gap: 8px;">
					${options.map(option => `
						<button class="workflow-btn ${option === currentValue ? 'primary' : ''}" 
								onclick="selectOption('${option}')" 
								style="text-align: left; width: 100%;">
							${option}
						</button>
					`).join('')}
				</div>
				<div style="margin-top: 15px; display: flex; justify-content: flex-end;">
					<button class="workflow-btn secondary" onclick="closeDropdown()">Cancel</button>
				</div>
			`;
			modal.appendChild(dialog);
			document.body.appendChild(modal);
			window.selectOption = (value) => {
				onSave(value);
				document.body.removeChild(modal);
				delete window.selectOption;
				delete window.closeDropdown;
			};
			window.closeDropdown = () => {
				document.body.removeChild(modal);
				delete window.selectOption;
				delete window.closeDropdown;
			};
			modal.onclick = (e) => {
				if (e.target === modal) {
					window.closeDropdown();
				}
			};
		}
		function getWorkflowItemValue(itemIndex, columnId) {
			const indexParts = itemIndex.toString().split('-');
			if (indexParts.length === 1) {
				// Main item
				const index = parseInt(indexParts[0]);
				return workflowData.items[index] ? workflowData.items[index][columnId] : null;
			} else {
				// Subitem
				const parentIndex = parseInt(indexParts[0]);
				const subIndex = parseInt(indexParts[1]);
				const parent = workflowData.items[parentIndex];
				return parent && parent.subitems && parent.subitems[subIndex] 
					? parent.subitems[subIndex][columnId] : null;
			}
		}
		function updateWorkflowItemValue(itemIndex, columnId, value) {
			const indexParts = itemIndex.toString().split('-');
			
			// Check if this column is a date type
			const column = workflowData.columns.find(c => c.id === columnId);
			const isDateColumn = column && column.type === 'date';
			
			if (indexParts.length === 1) {
				// Main item
				const index = parseInt(indexParts[0]);
				if (workflowData.items[index]) {
					workflowData.items[index][columnId] = value;
					// Sync with calendar if it's a date column (including custom date columns)
					if (isDateColumn || columnId === 'dueDate' || columnId === 'startDate') {
						// Get the current lead properly
						const lead = currentLead || window.currentSelectedLead || getCurrentLead();
						if (lead && lead._id) {
							console.log(`[updateWorkflowItemValue] Triggering calendar sync for date column: ${columnId}`);
							//syncWorkflowDateToCalendar(index, workflowData.items[index], columnId);
							// Show visual feedback
							showTemporaryMessage('📅 Syncing to calendar...', 2000);
						} else {
							console.warn('[updateWorkflowItemValue] No lead found for calendar sync');
						}
					}
				}
			} else {
				// Subitem
				const parentIndex = parseInt(indexParts[0]);
				const subIndex = parseInt(indexParts[1]);
				if (workflowData.items[parentIndex] && 
					workflowData.items[parentIndex].subitems && 
					workflowData.items[parentIndex].subitems[subIndex]) {
					workflowData.items[parentIndex].subitems[subIndex][columnId] = value;
					// Sync with calendar if it's a date column for subitem
					if (isDateColumn || columnId === 'dueDate' || columnId === 'startDate') {
						// Get the current lead properly
						const lead = currentLead || window.currentSelectedLead || getCurrentLead();
						if (lead && lead._id) {
							const subitem = workflowData.items[parentIndex].subitems[subIndex];
							console.log(`[updateWorkflowItemValue] Triggering calendar sync for subitem date column: ${columnId}`);
							//syncWorkflowDateToCalendar(`${parentIndex}-${subIndex}`, subitem, columnId, workflowData.items[parentIndex].name);
							// Show visual feedback
							showTemporaryMessage('📅 Syncing to calendar...', 2000);
						} else {
							console.warn('[updateWorkflowItemValue] No lead found for calendar sync');
						}
					}
				}
			}
			saveWorkflowData();
		}
		// Bulk operations functions
		function toggleAllWorkflowItems(checked) {
			const checkboxes = document.querySelectorAll('.workflow-checkbox[data-item-index]');
			checkboxes.forEach(cb => cb.checked = checked);
		}
		// Column management functions
		function manageWorkflowColumns() {
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; right: 0; bottom: 0;
				background: rgba(0,0,0,0.5); display: flex; align-items: center; 
				justify-content: center; z-index: 10000;
			`;
			const dialog = document.createElement('div');
			dialog.style.cssText = `
				background: white; padding: 24px; border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 600px; width: 90%;
				max-height: 80vh; overflow-y: auto;
			`;
			const availableColumnTypes = [
				{ id: 'text', name: 'Text', icon: 'text_fields' },
				{ id: 'status', name: 'Status', icon: 'radio_button_checked' },
				{ id: 'priority', name: 'Priority', icon: 'priority_high' },
				{ id: 'person', name: 'Person/Assignee', icon: 'person' },
				{ id: 'date', name: 'Date', icon: 'calendar_today' },
				{ id: 'progress', name: 'Progress', icon: 'pie_chart' },
				{ id: 'number', name: 'Number', icon: 'tag' },
				{ id: 'formula', name: 'Formula', icon: 'functions' }
			];
			dialog.innerHTML = `
				<h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">Manage Columns</h3>
				<p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">
					Drag to reorder, click to edit, or add new columns.
				</p>
				<div style="margin-bottom: 20px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
						<h4 style="margin: 0; font-size: 16px; font-weight: 600;">Current Columns</h4>
						<span style="font-size: 12px; color: var(--text-secondary);">${workflowData.columns.length} columns</span>
					</div>
					<div id="currentColumns" style="display: flex; flex-direction: column; gap: 8px;">
						${workflowData.columns.map((col, index) => `
							<div class="column-item" data-column-id="${col.id}" data-column-index="${index}" 
								draggable="${!col.fixed}" 
								ondragstart="dragStartColumn(event, ${index})"
								ondragover="dragOverColumn(event)"
								ondrop="dropColumn(event, ${index})"
								style="
								display: flex; align-items: center; gap: 12px; padding: 12px; 
								border: 1px solid var(--border-color); border-radius: 8px; background: white;
								cursor: ${col.fixed ? 'default' : 'move'}; transition: all 0.2s;
							">
								<span class="material-icons" style="color: var(--text-secondary); ${col.fixed ? 'opacity: 0.3;' : ''}">${col.fixed ? 'lock' : 'drag_indicator'}</span>
								<span class="material-icons" style="color: var(--primary);">${getColumnIcon(col.type)}</span>
								<div style="flex: 1;">
									<div style="font-weight: 600; font-size: 14px;">${col.name}</div>
									<div style="color: var(--text-secondary); font-size: 12px;">${col.type} • Width: ${col.width}px</div>
								</div>
								<div style="display: flex; gap: 8px; align-items: center;">
									${!col.fixed ? `
										<button onclick="editColumnWidth('${col.id}')" style="background: transparent; border: none; cursor: pointer; color: var(--text-secondary);" title="Edit Width">
											<span class="material-icons" style="font-size: 18px;">settings</span>
										</button>
										<button class="workflow-btn danger" onclick="removeColumn('${col.id}')" style="padding: 4px 8px; font-size: 12px;">Remove</button>
									` : '<span style="color: var(--success); font-size: 12px;">Required</span>'}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
				<div style="margin-bottom: 20px;">
					<h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Add New Column</h4>
					<div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; align-items: end;">
						<div>
							<label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Column Name</label>
							<input type="text" id="newColumnName" placeholder="Enter column name" style="
								width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); 
								border-radius: 4px; font-size: 14px;
							">
						</div>
						<div>
							<label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Type</label>
							<select id="newColumnType" onchange="toggleFormulaInput()" style="
								width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); 
								border-radius: 4px; font-size: 14px;
							">
								${availableColumnTypes.map(type => 
									`<option value="${type.id}">${type.name}</option>`
								).join('')}
							</select>
						</div>
						<div>
							<label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Width (px)</label>
							<input type="number" id="newColumnWidth" value="120" min="80" max="400" style="
								width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); 
								border-radius: 4px; font-size: 14px;
							">
						</div>
						<button class="workflow-btn primary" onclick="addNewColumn()" style="padding: 8px 16px;">Add</button>
					</div>
					<div id="formulaInputContainer" style="display: none; margin-top: 12px;">
						<label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Formula</label>
						<input type="text" id="formulaInput" placeholder="e.g., progress * 100, daysRemaining(dueDate)" style="
							width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); 
							border-radius: 4px; font-size: 14px; margin-bottom: 8px;
						">
						<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
							<strong>Available functions:</strong><br>
							• <code>progress * 100</code> - Mathematical operations<br>
							• <code>daysUntil(dueDate)</code> - Days until due date<br>
							• <code>daysSince(createdDate)</code> - Days since creation<br>
							• <code>if(status === 'Completed', 100, progress)</code> - Conditional logic<br>
							• <code>countSubitems()</code> - Count of subitems<br>
							• <code>completedSubitems()</code> - Count of completed subitems
						</div>
					</div>
				</div>
				<div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
					<button class="workflow-btn secondary" onclick="closeColumnManager()">Close</button>
					<button class="workflow-btn primary" onclick="saveColumnChanges()">Save Changes</button>
				</div>
			`;
			modal.appendChild(dialog);
			document.body.appendChild(modal);
			// Add event handlers
			window.toggleFormulaInput = () => {
				const type = document.getElementById('newColumnType').value;
				const container = document.getElementById('formulaInputContainer');
				container.style.display = type === 'formula' ? 'block' : 'none';
			};
			window.addNewColumn = () => {
				const name = document.getElementById('newColumnName').value.trim();
				const type = document.getElementById('newColumnType').value;
				const width = parseInt(document.getElementById('newColumnWidth').value);
				const formula = document.getElementById('formulaInput')?.value.trim();
				if (!name) {
					showTemporaryMessage('❌ Please enter a column name');
					return;
				}
				if (type === 'formula' && !formula) {
					showTemporaryMessage('❌ Please enter a formula');
					return;
				}
				const newColumn = {
					id: name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
					name: name,
					type: type,
					width: width || 120,
					fixed: false,
					required: false
				};
				// Add type-specific options
				if (type === 'status') {
					newColumn.options = ['Not Started', 'In Progress', 'Completed', 'On Hold'];
				} else if (type === 'priority') {
					newColumn.options = ['Low', 'Medium', 'High', 'Critical'];
				} else if (type === 'formula') {
					newColumn.formula = formula;
				}
				workflowData.columns.push(newColumn);
				document.getElementById('newColumnName').value = '';
				document.getElementById('newColumnWidth').value = '120';
				if (document.getElementById('formulaInput')) {
					document.getElementById('formulaInput').value = '';
				}
				// Refresh the current columns display
				refreshColumnsList();
				showTemporaryMessage('✅ Column added successfully');
			};
			window.removeColumn = (columnId) => {
				if (confirm('Remove this column? This action cannot be undone.')) {
					workflowData.columns = workflowData.columns.filter(col => col.id !== columnId);
					refreshColumnsList();
					showTemporaryMessage('✅ Column removed');
				}
			};
			window.refreshColumnsList = () => {
				const container = document.getElementById('currentColumns');
				container.innerHTML = workflowData.columns.map((col, index) => `
					<div class="column-item" data-column-id="${col.id}" style="
						display: flex; align-items: center; gap: 12px; padding: 12px; 
						border: 1px solid var(--border-color); border-radius: 8px; background: white;
					">
						<span class="material-icons" style="color: var(--text-secondary);">drag_indicator</span>
						<span class="material-icons" style="color: var(--primary);">${getColumnIcon(col.type)}</span>
						<div style="flex: 1;">
							<div style="font-weight: 600; font-size: 14px;">${col.name}</div>
							<div style="color: var(--text-secondary); font-size: 12px;">${col.type} • Width: ${col.width}px</div>
						</div>
						${col.fixed ? '<span style="color: var(--success); font-size: 12px;">Fixed</span>' : 
							`<button class="workflow-btn danger" onclick="removeColumn('${col.id}')" style="padding: 4px 8px; font-size: 12px;">Remove</button>`}
					</div>
				`).join('');
			};
			window.saveColumnChanges = () => {
				renderWorkflowBoard();
				saveWorkflowData();
				showTemporaryMessage('✅ Column changes saved');
				closeColumnManager();
			};
			window.closeColumnManager = () => {
				document.body.removeChild(modal);
				delete window.addNewColumn;
				delete window.removeColumn;
				delete window.refreshColumnsList;
				delete window.saveColumnChanges;
				delete window.closeColumnManager;
			};
			modal.onclick = (e) => {
				if (e.target === modal) {
					closeColumnManager();
				}
			};
		}
		function getColumnIcon(type) {
			const icons = {
				'text': 'text_fields',
				'status': 'radio_button_checked',
				'priority': 'priority_high',
				'person': 'person',
				'date': 'calendar_today',
				'progress': 'pie_chart',
				'number': 'tag',
				'formula': 'functions'
			};
			return icons[type] || 'view_column';
		}
		function showTemplateSelector() {
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; right: 0; bottom: 0;
				background: rgba(0,0,0,0.5); display: flex; align-items: center; 
				justify-content: center; z-index: 10000;
			`;
			const dialog = document.createElement('div');
			dialog.style.cssText = `
				background: white; padding: 24px; border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 500px; width: 90%;
			`;
			try {
				const templateButtons = Object.entries(workflowTemplates).map(([key, template]) => {
					const itemCount = template.items ? template.items.length : 0;
					const subitemCount = template.items ? template.items.reduce((total, item) => total + (item.subitems?.length || 0), 0) : 0;
					return `
						<button class="template-btn" onclick="selectTemplate('${key}')" style="
							text-align: left; padding: 16px; border: 2px solid var(--border-color);
							border-radius: 8px; background: white; transition: all 0.2s ease;
						" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='rgba(99,102,241,0.05)';"
						   onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white';">
							<div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${template.name || 'Unnamed Template'}</div>
							<div style="color: var(--text-secondary); font-size: 14px;">${template.description || 'No description'}</div>
							<div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">
								${itemCount} main tasks • ${subitemCount} subtasks
							</div>
						</button>
					`;
				}).join('');
				dialog.innerHTML = `
					<h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">Choose Project Template</h3>
					<p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">
						Select a template to get started with pre-configured tasks and workflow structure.
					</p>
					<div style="display: flex; flex-direction: column; gap: 12px;">
						${templateButtons}
					<button class="template-btn" onclick="selectTemplate('empty')" style="
						text-align: left; padding: 16px; border: 2px solid var(--border-color);
						border-radius: 8px; background: white; transition: all 0.2s ease;
					" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='rgba(99,102,241,0.05)';"
					   onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='white';">
						<div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Empty Workflow</div>
						<div style="color: var(--text-secondary); font-size: 14px;">Start with a blank workflow board</div>
					</button>
				</div>
				<div style="margin-top: 20px; display: flex; justify-content: flex-end;">
					<button class="workflow-btn secondary" onclick="closeTemplateSelector()">Cancel</button>
				</div>
			`;
			} catch (error) {
				dialog.innerHTML = `
					<h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: red;">Template Error</h3>
					<p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">
						There was an error loading the templates. Please refresh and try again.
					</p>
					<div style="margin-top: 20px; display: flex; justify-content: flex-end;">
						<button class="workflow-btn secondary" onclick="closeTemplateSelector()">Close</button>
					</div>
				`;
			}
			modal.appendChild(dialog);
			document.body.appendChild(modal);
			window.selectTemplate = (templateKey) => {
				if (templateKey === 'empty') {
					workflowData.items = [];
					renderWorkflowBoard();
					saveWorkflowData();
				} else {
					applyWorkflowTemplate(templateKey);
				}
				closeTemplateSelector();
			};
			window.closeTemplateSelector = () => {
				document.body.removeChild(modal);
				delete window.selectTemplate;
				delete window.closeTemplateSelector;
			};
			modal.onclick = (e) => {
				if (e.target === modal) {
					window.closeTemplateSelector();
				}
			};
		}
		// Populate notes tab with real data
		async function populateNotesTab(lead) {
			const notesList = document.getElementById('notesList');
			try {
				// Fetch real notes from server
				const response = await fetch(`/api/leads/${lead._id}/notes`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						displayNotes(result.data);
						return;
					}
				}
				// Fallback to mock data if API fails
				const notes = getCustomerNotes(lead);
				displayNotes(notes);
			} catch (error) {
				// Fallback to mock data
				const notes = getCustomerNotes(lead);
				displayNotes(notes);
			}
		}
		// Display notes in the UI
		function displayNotes(notes) {
			const notesList = document.getElementById('notesList');
			if (notes.length === 0) {
				notesList.innerHTML = `
					<div style="text-align: center; padding: 20px; color: var(--text-secondary);">
						<span class="material-icons" style="font-size: 48px; opacity: 0.5;">note</span>
						<p>No notes found</p>
					</div>
				`;
				return;
			}
			notesList.innerHTML = notes.map(note => {
				const noteDate = note.createdAt ? new Date(note.createdAt) : new Date(note.date);
				return `
					<div class="note-item">
						<div class="note-header">
							<span class="note-author">${note.author || 'Admin'}</span>
							<span class="note-date">${noteDate.toLocaleDateString()}</span>
						</div>
						<div class="note-content">${note.content}</div>
						${note.priority && note.priority !== 'low' ? `<span class="tag priority-${note.priority}" style="margin-top: 10px; display: inline-block;">${note.priority} priority</span>` : ''}
					</div>
				`;
			}).join('');
		}
		// Populate communication tab
		function populateCommunicationTab(lead) {
			// Clear iMessage-style compose form (check if elements exist)
			const emailSubject = document.getElementById('emailSubject');
			const emailBody = document.getElementById('emailBody');
			if (emailSubject) emailSubject.value = '';
			if (emailBody) emailBody.value = '';
			// Reset compose textarea height
			if (emailBody) {
				emailBody.style.height = 'auto';
				// Disable send button
				const sendButton = document.querySelector('.compose-btn-send');
				if (sendButton) {
					sendButton.disabled = true;
					sendButton.style.background = '#f2f2f7';
					sendButton.style.color = '#8e8e93';
				}
			}
			// Populate email history with tracking data
			populateEmailHistory(lead);
			// Fetch real email tracking data
			fetchEmailTrackingData(lead._id);
		}
		// Fetch email tracking data from server
		async function fetchEmailTrackingData(leadId) {
			try {
				const response = await fetch(`/api/leads/${leadId}/email-tracking`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						updateEmailTrackingUI(result.data);
					}
				}
			} catch (error) {
			}
		}
		// Update UI with email tracking data
		function updateEmailTrackingUI(trackingData) {
			// Update profile stats if tracking data shows email activity
			if (trackingData.lastEmailOpened) {
				const openedDate = new Date(trackingData.lastEmailOpened);
				const now = new Date();
				const hoursSinceOpen = Math.floor((now - openedDate) / (1000 * 60 * 60));
				if (hoursSinceOpen < 24) {
					document.getElementById('responseTime').textContent = 
						hoursSinceOpen < 1 ? 'Recently active' : `${hoursSinceOpen}h ago`;
				}
			}
			// Add email activity to timeline instead of showing notifications
			addEmailActivityToTimeline(trackingData);
			// Add tracking info to communication tab header
			const communicationSection = document.querySelector('.communication-section h4:not([style*="notifications"])');
			if (communicationSection && trackingData.emailCount > 0) {
				const trackingInfo = document.createElement('div');
				trackingInfo.style.cssText = 'font-size: 14px; font-weight: normal; color: var(--text-secondary); margin-top: 5px;';
				trackingInfo.innerHTML = `
					📧 ${trackingData.emailCount} emails sent • 
					👁️ ${trackingData.emailOpens.length} opens • 
					📈 ${trackingData.openRate}% open rate
					${trackingData.lastEmailOpened ? `<br>Last opened: ${new Date(trackingData.lastEmailOpened).toLocaleString()}` : ''}
				`;
				// Remove existing tracking info
				const existing = communicationSection.parentNode.querySelector('[style*="font-size: 14px"]');
				if (existing) existing.remove();
				communicationSection.parentNode.insertBefore(trackingInfo, communicationSection.nextSibling);
			}
		}
		// Add email activity to timeline
		function addEmailActivityToTimeline(trackingData) {
			if (!trackingData || !trackingData.emailOpens || trackingData.emailOpens.length === 0) {
				return;
			}
			// Add recent email opens to timeline
			const timeline = document.getElementById('interactionTimeline');
			if (!timeline) return;
			// Show notifications for opens in the last 24 hours
			const now = new Date();
			const last24Hours = new Date(now.getTime() - 24 * 60 * 60 * 1000);
			const recentOpens = trackingData.emailOpens.filter(open => 
				new Date(open.timestamp) > last24Hours
			).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
			if (recentOpens.length === 0) return;
			// Add email activity entries to timeline
			recentOpens.forEach(open => {
				const openTime = new Date(open.timestamp);
				const timeAgo = getTimeAgo(openTime);
				const deviceInfo = getDeviceInfo(open.userAgent);
				const timelineItem = document.createElement('div');
				timelineItem.className = 'timeline-item';
				timelineItem.innerHTML = `
					<div class="timeline-icon email-activity">
						<span class="material-icons">email_open</span>
					</div>
					<div class="timeline-content">
						<h4>Email Opened</h4>
						<p>Customer opened email ${timeAgo}</p>
						<div class="timeline-time">
							📱 ${deviceInfo} • 🕒 ${openTime.toLocaleString()}
						</div>
					</div>
				`;
				// Add to timeline and then re-sort the entire timeline
				timeline.appendChild(timelineItem);
				// Re-sort all timeline items by timestamp
				const timelineItems = Array.from(timeline.children);
				timelineItems.sort((a, b) => {
					// Extract timestamp from timeline-time element
					const timeA = a.querySelector('.timeline-time')?.textContent || '';
					const timeB = b.querySelector('.timeline-time')?.textContent || '';
					// For "Just now" entries, prioritize them at top
					if (timeA.includes('Just now')) return -1;
					if (timeB.includes('Just now')) return 1;
					// Parse dates and sort newest first
					const dateA = new Date(timeA.replace(/📱.*?•\s*🕒\s*/, ''));
					const dateB = new Date(timeB.replace(/📱.*?•\s*🕒\s*/, ''));
					return dateB - dateA;
				});
				// Clear timeline and re-append sorted items
				timeline.innerHTML = '';
				timelineItems.forEach(item => timeline.appendChild(item));
			});
		}
		// Get time ago string
		function getTimeAgo(date) {
			const now = new Date();
			const diffMs = now - date;
			const diffMins = Math.floor(diffMs / (1000 * 60));
			const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
			if (diffMins < 1) return 'just now';
			if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
			if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
			return date.toLocaleDateString();
		}
		// Get device info from user agent
		function getDeviceInfo(userAgent) {
			if (!userAgent) return 'Unknown device';
			if (userAgent.includes('Mobile') || userAgent.includes('Android')) return 'Mobile device';
			if (userAgent.includes('iPad') || userAgent.includes('Tablet')) return 'Tablet';
			if (userAgent.includes('iPhone')) return 'iPhone';
			if (userAgent.includes('Mac')) return 'Mac';
			if (userAgent.includes('Windows')) return 'Windows PC';
			if (userAgent.includes('Linux')) return 'Linux';
			return 'Desktop';
		}
		// Refresh notifications periodically
		let notificationInterval;
		function startNotificationPolling() {
			if (notificationInterval) clearInterval(notificationInterval);
			notificationInterval = setInterval(async () => {
				if (currentLead && document.getElementById('tab-communication').classList.contains('active')) {
					await fetchEmailTrackingData(currentLead._id);
					// Also refresh email history to show updated open counts
					await populateEmailHistory(currentLead);
				}
			}, 30000); // Check every 30 seconds when communication tab is active
		}
		function stopNotificationPolling() {
			if (notificationInterval) {
				clearInterval(notificationInterval);
				notificationInterval = null;
			}
		}
		// Populate email history with real data (SMS kept separate)
		async function populateEmailHistory(lead) {
			const messagesArea = document.getElementById('messagesArea');
			try {
				// Fetch real email history from server
				const response = await fetch(`/api/leads/${lead._id}/email-history`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						displayEmailConversation(result.data);
						return;
					}
				} else {
				}
				// Fallback to mock data if API fails
				const emails = getEmailHistory(lead);
				displayEmailConversation(emails);
			} catch (error) {
				// Fallback to mock data
				const emails = getEmailHistory(lead);
				displayEmailConversation(emails);
			}
		}
		// Extract only new content from email reply (remove quoted text)
		function extractNewEmailContent(emailBody, emailSubject) {
			if (!emailBody) return 'No content';
			// Common patterns for quoted text
			const quotedPatterns = [
				// Gmail style: "On [date], [email] wrote:"
				/^On .+?, .+? wrote:[\s\S]*$/gmi,
				// Outlook style: "From: [email]" or "-----Original Message-----"
				/^(From:|-----Original Message-----|\[.*?\])[\s\S]*$/gmi,
				// Generic ">" quoted lines
				/^>.*$/gm,
				// Multiple line breaks followed by quoted content
				/\n\s*\n.*?wrote:[\s\S]*$/gmi,
				// Date patterns like "Sun, Aug 17, 2025 at 11:53 PM"
				/\n.*?at \d{1,2}:\d{2}\s?(AM|PM).*?wrote:[\s\S]*$/gmi
			];
			let cleanContent = emailBody.trim();
			// Remove quoted sections
			quotedPatterns.forEach(pattern => {
				cleanContent = cleanContent.replace(pattern, '').trim();
			});
			// Split by common reply separators and take the first part
			const replyMarkers = [
				'On ',
				'From:',
				'-----Original Message-----',
				'wrote:',
				'________________________________'  // Outlook separator
			];
			for (const marker of replyMarkers) {
				const index = cleanContent.indexOf(marker);
				if (index > 0) {
					cleanContent = cleanContent.substring(0, index).trim();
					break;
				}
			}
			// Remove excessive whitespace
			cleanContent = cleanContent.replace(/\n{3,}/g, '\n\n').trim();
			// If content is too short or empty after cleaning, return original
			if (cleanContent.length < 5) {
				return emailBody.split('\n')[0] || 'No content';
			}
			return cleanContent;
		}
		// Display email conversation in iPhone-style UI
		function displayEmailConversation(emails) {
			const messagesArea = document.getElementById('messagesArea');
			if (emails.length === 0) {
				messagesArea.innerHTML = `
					<div style="text-align: center; padding: 40px; color: #8e8e93;">
						<span class="material-icons" style="font-size: 48px; opacity: 0.5; margin-bottom: 10px; display: block;">chat_bubble_outline</span>
						<p style="margin: 0; font-size: 16px;">No conversation yet</p>
						<p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.7;">Send your first email to start the conversation</p>
					</div>
				`;
				return;
			}
			// Sort emails by date to show conversation chronologically
			const sortedEmails = [...emails].sort((a, b) => {
				const dateA = new Date(a.sentAt || a.date);
				const dateB = new Date(b.sentAt || b.date);
				return dateA - dateB;
			});
			messagesArea.innerHTML = sortedEmails.map(email => {
				const sentDate = email.sentAt ? new Date(email.sentAt) : new Date(email.date);
				const isReceived = email.type === 'received' || email.direction === 'incoming' || email.status === 'received';
				const messageType = isReceived ? 'received' : 'sent';
				const timeStr = sentDate.toLocaleTimeString([], { 
					hour: '2-digit', 
					minute: '2-digit' 
				});
				const dateStr = sentDate.toLocaleDateString([], { 
					month: 'short', 
					day: 'numeric' 
				});
				let statusIndicator = '';
				if (!isReceived) {
					if (email.openCount > 0) {
						statusIndicator = `
							<div class="message-status">
								<div class="read-receipt" title="Read ${email.openCount} time${email.openCount !== 1 ? 's' : ''}">✓</div>
							</div>
						`;
					} else {
						statusIndicator = `
							<div class="message-status">
								<span style="color: #8e8e93;">✓</span>
							</div>
						`;
					}
				}
				// Extract clean content from email
				const cleanContent = extractNewEmailContent(email.body || email.preview || '', email.subject);
				return `
					<div class="message-bubble message-${messageType}">
						<div class="message-content">
							<div class="message-text">${cleanContent}</div>
						</div>
						${statusIndicator}
					</div>
					<div class="message-timestamp message-timestamp-${messageType}">
						${timeStr} • ${dateStr}
					</div>
				`;
			}).join('');
			// Enhanced auto-scroll to bottom (like in the screenshot)
			scrollConversationToBottom();
			// Additional scroll attempts to ensure we reach the bottom
			setTimeout(() => {
				scrollConversationToBottom();
			}, 100);
			setTimeout(() => {
				scrollConversationToBottom();
			}, 300);
			// Auto-populate subject line for reply
			autoPopulateSubject(sortedEmails);
		}

		// Auto-populate subject line with latest email subject
		function autoPopulateSubject(emails) {
			if (!emails || emails.length === 0) return;
			// Find the most recent email to get subject for reply
			const latestEmail = emails[emails.length - 1];
			const emailSubject = document.getElementById('emailSubject');
			if (emailSubject && latestEmail.subject) {
				let replySubject = latestEmail.subject;
				// Add "Re: " prefix if not already present
				if (!replySubject.toLowerCase().startsWith('re:')) {
					replySubject = 'Re: ' + replySubject;
				}
				emailSubject.value = replySubject;
			}
		}
		// iMessage-style compose interface functions
		function toggleComposeOptions() {
			const quickReplies = document.getElementById('quickReplies');
			const composeSubject = document.getElementById('composeSubject');
			if (quickReplies.style.display === 'none') {
				quickReplies.style.display = 'block';
				composeSubject.style.display = 'block';
			} else {
				quickReplies.style.display = 'none';
				composeSubject.style.display = 'none';
			}
		}
		function autoResizeTextarea(textarea) {
			textarea.style.height = 'auto';
			textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
			// Enable/disable send button based on content
			const sendButton = document.querySelector('.compose-btn-send');
			const hasContent = textarea.value.trim().length > 0;
			sendButton.disabled = !hasContent;
			if (hasContent) {
				sendButton.style.background = '#007aff';
				sendButton.style.color = 'white';
			} else {
				sendButton.style.background = '#f2f2f7';
				sendButton.style.color = '#8e8e93';
			}
		}
		function handleComposeKeydown(event) {
			if (event.key === 'Enter' && !event.shiftKey) {
				event.preventDefault();
				const textarea = event.target;
				if (textarea.value.trim().length > 0) {
					sendEmail();
				}
			}
		}
		function insertQuickReply(text) {
			const textarea = document.getElementById('emailBody');
			textarea.value = text;
			autoResizeTextarea(textarea);
			textarea.focus();
			// Hide quick replies after selection
			document.getElementById('quickReplies').style.display = 'none';
		}
		// Get email history (mock data for now)
		function getEmailHistory(lead) {
			const baseEmails = [];
			// Add emails based on lead status
			if (lead.status !== 'new') {
				baseEmails.push({
					subject: `Welcome to TownRanker - ${lead.name}`,
					preview: 'Thank you for your interest in our services. We\'re excited to work with you on your project...',
					date: new Date(new Date(lead.createdAt).getTime() + 2 * 60 * 60 * 1000).toLocaleDateString(),
					status: 'sent'
				});
			}
			if (['qualified', 'proposal', 'closed-won', 'closed-lost'].includes(lead.status)) {
				baseEmails.push({
					subject: `Project Brief for ${formatProjectType(lead.projectType)}`,
					preview: 'Following our discussion, here\'s a detailed brief for your project requirements...',
					date: new Date(new Date(lead.createdAt).getTime() + 24 * 60 * 60 * 1000).toLocaleDateString(),
					status: 'sent'
				});
			}
			if (['proposal', 'closed-won', 'closed-lost'].includes(lead.status)) {
				baseEmails.push({
					subject: `Proposal: ${formatProjectType(lead.projectType)} - $${lead.budget?.toLocaleString()}`,
					preview: 'Please find attached our detailed proposal for your project. We\'ve included timeline, pricing...',
					date: new Date(new Date(lead.createdAt).getTime() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString(),
					status: 'sent'
				});
			}
			return baseEmails.reverse(); // Show newest first
		}
		// Load email template - DEPRECATED: No longer used in iMessage interface
		function loadEmailTemplate() {
			// This function is no longer used since we removed the template dropdown
			return;
			const lead = currentLead;
			if (!template || !lead) return;
			const templates = {
				welcome: {
					subject: `Welcome to TownRanker - ${lead.name}`,
					body: `Hi ${lead.name?.split(' ')[0] || 'there'},
Thank you for reaching out to TownRanker about your ${formatProjectType(lead.projectType)} project.
We're excited to learn more about your vision and help bring it to life. Based on your initial inquiry, I understand you're looking for:
• Project Type: ${formatProjectType(lead.projectType)}
• Budget Range: $${(lead.budget || 0).toLocaleString()}
• Timeline: ${formatTimeline(lead.timeline)}
I'll be your dedicated project manager throughout this process. Let's schedule a quick 15-minute discovery call to discuss your specific requirements and answer any questions you might have.
You can book a time that works for you here: [Calendar Link]
Looking forward to working with you!
Best regards,
TownRanker Team`
				},
				followup: {
					subject: `Following up on your ${formatProjectType(lead.projectType)} project`,
					body: `Hi ${lead.name?.split(' ')[0] || 'there'},
I wanted to follow up on your ${formatProjectType(lead.projectType)} project inquiry.
We've been working on some initial concepts based on your requirements and would love to share them with you. 
Are you available for a brief call this week to discuss next steps?
Best regards,
TownRanker Team`
				},
				proposal: {
					subject: `Proposal: ${formatProjectType(lead.projectType)} - $${(lead.budget || 0).toLocaleString()}`,
					body: `Hi ${lead.name?.split(' ')[0] || 'there'},
Thank you for the detailed discussion about your ${formatProjectType(lead.projectType)} project.
Please find attached our comprehensive proposal including:
• Detailed project scope and deliverables
• Timeline and milestones
• Investment: $${(lead.budget || 0).toLocaleString()}
• Next steps
This proposal is valid for 14 days. I'm happy to schedule a call to discuss any questions or adjustments.
Looking forward to your feedback!
Best regards,
TownRanker Team`
				},
				'project-update': {
					subject: `Project Update - ${formatProjectType(lead.projectType)}`,
					body: `Hi ${lead.name?.split(' ')[0] || 'there'},
Here's your weekly project update:
Progress This Week:
• [Update on completed tasks]
• [Milestones achieved]
Coming Up Next Week:
• [Upcoming deliverables]
• [Any input needed from you]
Please let me know if you have any questions or feedback.
Best regards,
TownRanker Team`
				},
				completion: {
					subject: `Project Complete - ${formatProjectType(lead.projectType)}`,
					body: `Hi ${lead.name?.split(' ')[0] || 'there'},
Congratulations! Your ${formatProjectType(lead.projectType)} project is now complete and ready for launch.
Final deliverables include:
• [List of deliverables]
• Training materials
• Support documentation
We'll continue to provide 30 days of post-launch support. Thank you for choosing TownRanker!
Best regards,
TownRanker Team`
				}
			};
			if (templates[template]) {
				document.getElementById('emailSubject').value = templates[template].subject;
				document.getElementById('emailBody').value = templates[template].body;
			}
		}
		// Send email
		async function sendEmail(event) {
			const subject = document.getElementById('emailSubject').value || '';
			const body = document.getElementById('emailBody').value;
			const template = ''; // No template in iMessage-style interface
			if (!body) {
				alert('Please enter a message');
				return;
			}
			if (!currentLead || !currentLead.email) {
				alert('Customer email not available');
				return;
			}
			// Show sending indicator
			const sendButton = event ? event.target : document.querySelector('.compose-btn-send');
			const originalText = sendButton.innerHTML;
			sendButton.innerHTML = '<span class="material-icons" style="font-size: 16px; margin-right: 5px;">hourglass_empty</span>Sending...';
			sendButton.disabled = true;
			try {
				// Send via the real API
				const response = await fetch('/api/send-customer-email', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						leadId: currentLead._id,
						subject: subject,
						body: body,
						template: template
					})
				});
				const result = await response.json();
				if (result.success) {
					// Clear iMessage-style form
					const emailSubject = document.getElementById('emailSubject');
					const emailBody = document.getElementById('emailBody');
					if (emailSubject) emailSubject.value = '';
					if (emailBody) {
						emailBody.value = '';
						emailBody.style.height = 'auto';
						// Reset send button
						const sendButton = document.querySelector('.compose-btn-send');
						if (sendButton) {
							sendButton.disabled = true;
							sendButton.style.background = '#f2f2f7';
							sendButton.style.color = '#8e8e93';
						}
					}
					// Refresh email history to show the new email
					await populateEmailHistory(currentLead);
					// Add to timeline
					addEmailToTimeline(subject);
					// Update email count stat
					const currentCount = parseInt(document.getElementById('totalInteractions').textContent) || 0;
					document.getElementById('totalInteractions').textContent = currentCount + 1;
					alert(`Email sent successfully to ${result.recipient}!`);
				} else {
					throw new Error(result.message || 'Failed to send email');
				}
			} catch (error) {
				alert('Failed to send email: ' + error.message);
			} finally {
				// Restore button
				sendButton.innerHTML = originalText;
				sendButton.disabled = false;
			}
		}
		// Save email draft
		function saveEmailDraft() {
			const subject = document.getElementById('emailSubject').value;
			const body = document.getElementById('emailBody').value;
			if (!subject && !body) {
				alert('Please enter some content to save as draft');
				return;
			}
			// Add to email history as draft
			const emailHistoryList = document.getElementById('emailHistoryList');
			const newEmail = document.createElement('div');
			newEmail.className = 'email-item';
			newEmail.innerHTML = `
				<div class="email-header">
					<div class="email-subject">${subject || 'Untitled Draft'}</div>
					<div style="display: flex; align-items: center; gap: 10px;">
						<span class="email-status draft">draft</span>
						<span class="email-date">Just now</span>
					</div>
				</div>
				<div class="email-preview">${body.substring(0, 100)}${body.length > 100 ? '...' : ''}</div>
			`;
			if (emailHistoryList.querySelector('[style*="text-align: center"]')) {
				// Replace empty state
				emailHistoryList.innerHTML = '';
			}
			emailHistoryList.insertBefore(newEmail, emailHistoryList.firstChild);
			alert('Draft saved successfully!');
		}
		// Add email to timeline
		function addEmailToTimeline(subject) {
			const timeline = document.getElementById('interactionTimeline');
			const newInteraction = document.createElement('div');
			newInteraction.className = 'timeline-item';
			newInteraction.innerHTML = `
				<div class="timeline-icon email">
					<span class="material-icons">email</span>
				</div>
				<div class="timeline-content">
					<h4>Email Sent</h4>
					<p>${subject}</p>
					<div class="timeline-time">Just now</div>
				</div>
			`;
			timeline.insertBefore(newInteraction, timeline.firstChild);
			// Update interaction count
			const currentCount = parseInt(document.getElementById('totalInteractions').textContent) || 0;
			document.getElementById('totalInteractions').textContent = currentCount + 1;
		}
		// Get customer notes (mock for now)
		function getCustomerNotes(lead) {
			return [
				{
					author: 'Admin',
					date: 'Today',
					content: `Initial lead from ${formatProjectType(lead.projectType)} inquiry. Budget range: $${(lead.budget || 0).toLocaleString()}`,
					priority: 'medium'
				},
				{
					author: 'System',
					date: new Date(lead.createdAt).toLocaleDateString(),
					content: 'Lead automatically captured from website form submission.',
					priority: 'low'
				}
			];
		}
		// Show modern status selector modal
		function showStatusSelector(lead) {
			return new Promise((resolve) => {
				const statusOptions = [
					{ value: 'new', label: 'New Lead', description: 'Initial contact stage', icon: 'person_add', color: '#6b7280' },
					{ value: 'contacted', label: 'Contacted', description: 'Initial contact made', icon: 'call', color: '#3b82f6' },
					{ value: 'qualified', label: 'Qualified', description: 'Requirements understood', icon: 'verified', color: '#8b5cf6' },
					{ value: 'proposal', label: 'Proposal Sent', description: 'Proposal and pricing sent', icon: 'description', color: '#f59e0b' },
					{ value: 'closed-won', label: 'Closed Won', description: 'Project started', icon: 'check_circle', color: '#10b981' },
					{ value: 'closed-lost', label: 'Closed Lost', description: 'Did not convert', icon: 'cancel', color: '#ef4444' }
				];
				// Create modal overlay
				const overlay = document.createElement('div');
				overlay.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					right: 0;
					bottom: 0;
					background: rgba(0, 0, 0, 0.5);
					display: flex;
					align-items: center;
					justify-content: center;
					z-index: 10001;
					opacity: 0;
					transition: opacity 0.3s ease;
				`;
				// Create modal content
				const modal = document.createElement('div');
				modal.style.cssText = `
					background: white;
					border-radius: 12px;
					padding: 24px;
					max-width: 400px;
					width: 90%;
					max-height: 80vh;
					overflow-y: auto;
					box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
					transform: scale(0.9);
					transition: transform 0.3s ease;
				`;
				modal.innerHTML = `
					<div style="margin-bottom: 20px;">
						<h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">Update Lead Status</h3>
						<p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
							Current status: <strong>${lead.status}</strong> • ${lead.name || lead.company || 'Lead'}
						</p>
					</div>
					<div style="display: flex; flex-direction: column; gap: 8px;">
						${statusOptions.map(option => `
							<button class="status-option" data-status="${option.value}" style="
								display: flex;
								align-items: center;
								gap: 12px;
								padding: 12px 16px;
								border: 2px solid ${option.value === lead.status ? option.color : '#e5e7eb'};
								border-radius: 8px;
								background: ${option.value === lead.status ? option.color + '10' : 'white'};
								cursor: pointer;
								text-align: left;
								transition: all 0.2s ease;
								width: 100%;
							" onmouseover="this.style.borderColor='${option.color}'; this.style.background='${option.color}10';" 
							   onmouseout="this.style.borderColor='${option.value === lead.status ? option.color : '#e5e7eb'}'; this.style.background='${option.value === lead.status ? option.color + '10' : 'white'}';">
								<span class="material-icons" style="color: ${option.color}; font-size: 20px;">${option.icon}</span>
								<div style="flex: 1;">
									<div style="font-weight: 500; margin-bottom: 2px;">${option.label}</div>
									<div style="font-size: 12px; color: var(--text-secondary);">${option.description}</div>
								</div>
								${option.value === lead.status ? '<span class="material-icons" style="color: ' + option.color + ';">check</span>' : ''}
							</button>
						`).join('')}
					</div>
					<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
						<button id="cancel-status" style="
							padding: 8px 16px;
							border: 1px solid #d1d5db;
							border-radius: 6px;
							background: white;
							cursor: pointer;
							font-size: 14px;
						">Cancel</button>
					</div>
				`;
				overlay.appendChild(modal);
				document.body.appendChild(overlay);
				// Show modal with animation
				setTimeout(() => {
					overlay.style.opacity = '1';
					modal.style.transform = 'scale(1)';
				}, 10);
				// Handle status selection
				modal.addEventListener('click', (e) => {
					const statusButton = e.target.closest('.status-option');
					if (statusButton) {
						const selectedStatus = statusButton.dataset.status;
						closeModal();
						resolve(selectedStatus);
					}
				});
				// Handle cancel
				modal.querySelector('#cancel-status').addEventListener('click', () => {
					closeModal();
					resolve(null);
				});
				// Handle overlay click
				overlay.addEventListener('click', (e) => {
					if (e.target === overlay) {
						closeModal();
						resolve(null);
					}
				});
				// Handle escape key
				const handleEscape = (e) => {
					if (e.key === 'Escape') {
						closeModal();
						resolve(null);
					}
				};
				document.addEventListener('keydown', handleEscape);
				function closeModal() {
					document.removeEventListener('keydown', handleEscape);
					overlay.style.opacity = '0';
					modal.style.transform = 'scale(0.9)';
					setTimeout(() => {
						if (overlay.parentNode) {
							overlay.parentNode.removeChild(overlay);
						}
					}, 300);
				}
			});
		}
		// Update lead status with modern dropdown
		async function updateStatus(leadId) {
			const lead = allLeads.find(l => l._id === leadId);
			if (!lead) return;
			const newStatus = await showStatusSelector(lead);
			if (!newStatus || newStatus === lead.status) return;
			try {
				const response = await fetch(`/api/leads/${leadId}`, {
					method: 'PATCH',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ status: newStatus })
				});
				const data = await response.json();
				if (data.success) {
					// Update local data
					lead.status = newStatus;
					renderLeads();
					updateStats();
					alert('Status updated successfully');
				} else {
					throw new Error('Failed to update status');
				}
			} catch (error) {
				alert('Failed to update status');
			}
		}
		// Contact lead
		function contactLead(leadId) {
			const lead = allLeads.find(l => l._id === leadId);
			if (!lead) return;
			// Open email client
			window.location.href = `mailto:${lead.email}?subject=Re: Your ${lead.projectType} Project Inquiry&body=Hi ${lead.name},%0D%0A%0D%0AThank you for your interest in our services...`;
		}
		// Enhanced scroll function to ensure conversation loads at bottom (like in screenshot)
		function scrollConversationToBottom() {
			const messagesArea = document.getElementById('messagesArea');
			if (messagesArea) {
				// Force scroll to bottom immediately
				messagesArea.scrollTop = messagesArea.scrollHeight;
				// Also try smooth scroll as backup
				setTimeout(() => {
					messagesArea.scrollTo({
						top: messagesArea.scrollHeight,
						behavior: 'smooth'
					});
				}, 50);
			}
		}
		// Enhanced function to ensure conversation loads at bottom on tab switch
		function ensureConversationAtBottom() {
			const messagesArea = document.getElementById('messagesArea');
			if (messagesArea) {
				// Multiple attempts to ensure we get to the bottom
				const scrollToBottom = () => {
					messagesArea.scrollTop = messagesArea.scrollHeight;
				};
				// Immediate scroll
				scrollToBottom();
				// Additional attempts with delays to handle dynamic content loading
				setTimeout(scrollToBottom, 10);
				setTimeout(scrollToBottom, 50);
				setTimeout(scrollToBottom, 100);
				setTimeout(scrollToBottom, 200);
			}
		}
		// Close modal
		function closeModal() {
			document.getElementById('leadModal').classList.remove('active');
			stopNotificationPolling(); // Stop polling when modal is closed
			// Clear current lead references to prevent stale data issues
			currentLead = null;
			window.currentLeadId = null;
			currentLeadId = null;
		}
		// Settings modal functions
		function openSettings() {
			// Load current settings from localStorage
			loadSettings();
			document.getElementById('settingsModal').classList.add('active');
		}
		function closeSettings() {
			document.getElementById('settingsModal').classList.remove('active');
		}
		function loadSettings() {
			// Load settings from localStorage or use defaults
			const emailNotifications = localStorage.getItem('emailNotifications') !== 'false'; // default true
			const replyNotifications = localStorage.getItem('replyNotifications') !== 'false'; // default true
			const autoRefresh = localStorage.getItem('autoRefresh') === 'true'; // default false
			document.getElementById('emailNotificationsToggle').checked = emailNotifications;
			document.getElementById('replyNotificationsToggle').checked = replyNotifications;
			document.getElementById('autoRefreshToggle').checked = autoRefresh;
		}
		async function saveSettings() {
			// Get toggle values
			const emailNotifications = document.getElementById('emailNotificationsToggle').checked;
			const replyNotifications = document.getElementById('replyNotificationsToggle').checked;
			const autoRefresh = document.getElementById('autoRefreshToggle').checked;
			try {
				// Save to backend
				const response = await fetch('/api/settings/notifications', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						emailNotifications,
						replyNotifications,
						autoRefresh
					})
				});
				const result = await response.json();
				if (result.success) {
					// Save to localStorage
					localStorage.setItem('emailNotifications', emailNotifications);
					localStorage.setItem('replyNotifications', replyNotifications);
					localStorage.setItem('autoRefresh', autoRefresh);
					// Apply settings immediately
					applySettings();
					// Show success message
					alert('✅ Settings saved successfully!');
				} else {
					throw new Error(result.message || 'Failed to save settings');
				}
			} catch (error) {
				alert('❌ Failed to save settings. Please try again.');
				return;
			}
			// Close modal
			closeSettings();
		}
		function applySettings() {
			const autoRefresh = localStorage.getItem('autoRefresh') === 'true';
			// Handle auto-refresh
			if (autoRefresh) {
				startAutoRefresh();
			} else {
				stopAutoRefresh();
			}
		}
		// Auto-refresh functionality
		let autoRefreshInterval = null;
		function startAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			autoRefreshInterval = setInterval(() => {
				refreshData();
			}, 5 * 60 * 1000); // 5 minutes
		}
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		// Check if notifications should be sent (for backend integration)
		function shouldSendEmailNotifications() {
			return localStorage.getItem('emailNotifications') !== 'false';
		}
		function shouldSendReplyNotifications() {
			return localStorage.getItem('replyNotifications') !== 'false';
		}
		// Calendar Functions
		async function //refreshCalendar() {
			//renderCustomCalendar();
			// Also refresh Google Calendar events if connected
			if (typeof window.googleCalendarManager !== 'undefined' && window.googleCalendarManager.isAuthenticated) {
				await loadAndDisplayGoogleEvents();
			}
		}
		
		function openGoogleCalendar() {
			window.open('https://calendar.google.com/', '_blank');
		}
		
		function scheduleAppointment() {
			const currentLead = window.currentSelectedLead;
			let calendarUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
			
			if (currentLead) {
				const title = `Appointment with ${currentLead.name || 'Client'}`;
				const details = `Scheduled appointment for ${currentLead.projectType || 'project discussion'}.\n\nContact: ${currentLead.email || ''}\nPhone: ${currentLead.phone || ''}`;
				
				calendarUrl += `&text=${encodeURIComponent(title)}`;
				calendarUrl += `&details=${encodeURIComponent(details)}`;
				
				if (currentLead.email) {
					calendarUrl += `&add=${encodeURIComponent(currentLead.email)}`;
				}
			} else {
				calendarUrl += `&text=${encodeURIComponent('Client Appointment')}`;
			}
			
			window.open(calendarUrl, '_blank');
		}

		// Event Creation Modal Functions
		function showCreateEventModal(selectedDate = null) {
			const modal = document.getElementById('createEventModal');
			modal.classList.add('active');
			
			// Set date (either selected date or today)
			const dateToUse = selectedDate || new Date();
			const dateString = dateToUse.toISOString().split('T')[0];
			document.getElementById('eventDate').value = dateString;
			
			// Set default time to next hour
			const now = new Date();
			now.setHours(now.getHours() + 1, 0, 0, 0);
			const timeString = now.toTimeString().slice(0, 5);
			document.getElementById('eventTime').value = timeString;
			
			// Populate client dropdown
			populateClientDropdown();
		}

		function closeCreateEventModal() {
			const modal = document.getElementById('createEventModal');
			modal.classList.remove('active');
			clearEventForm();
		}

		function clearEventForm() {
			document.getElementById('createEventForm').reset();
			document.getElementById('customDurationSection').style.display = 'none';
		}

		function populateClientDropdown() {
			const clientSelect = document.getElementById('eventClient');
			clientSelect.innerHTML = '<option value="">Select a client (optional)</option>';
			
			if (allLeads && allLeads.length > 0) {
				allLeads.forEach(lead => {
					const option = document.createElement('option');
					option.value = lead._id;
					option.textContent = `${lead.name || 'Unnamed'} - ${lead.email || 'No email'}`;
					clientSelect.appendChild(option);
				});
			}
		}

		// Duration dropdown change handler
		document.addEventListener('DOMContentLoaded', function() {
			const durationSelect = document.getElementById('eventDuration');
			const customSection = document.getElementById('customDurationSection');
			
			if (durationSelect) {
				durationSelect.addEventListener('change', function() {
					if (this.value === 'custom') {
						customSection.style.display = 'block';
					} else {
						customSection.style.display = 'none';
					}
				});
			}

			// Form submission handler
			const form = document.getElementById('createEventForm');
			if (form) {
				form.addEventListener('submit', handleCreateEvent);
			}
		});

		async function handleCreateEvent(e) {
			e.preventDefault();
			
			try {
				// Get form data
				const title = document.getElementById('eventTitle').value;
				const date = document.getElementById('eventDate').value;
				const time = document.getElementById('eventTime').value;
				const durationSelect = document.getElementById('eventDuration').value;
				const customDuration = document.getElementById('customDuration').value;
				const clientId = document.getElementById('eventClient').value;
				const description = document.getElementById('eventDescription').value;
				const location = document.getElementById('eventLocation').value;
				const reminder = document.getElementById('eventReminder').value;

				// Calculate duration in minutes
				let duration;
				if (durationSelect === 'custom') {
					duration = parseInt(customDuration) || 60;
				} else {
					duration = parseInt(durationSelect);
				}

				// Create datetime objects
				const startDateTime = new Date(`${date}T${time}`);
				const endDateTime = new Date(startDateTime.getTime() + (duration * 60000));

				// Get client information if selected
				let clientInfo = null;
				if (clientId && allLeads) {
					clientInfo = allLeads.find(lead => lead._id === clientId);
				}

				// Build event data
				const eventData = {
					title,
					start: startDateTime.toISOString(),
					end: endDateTime.toISOString(),
					description,
					location,
					reminder: parseInt(reminder),
					clientId: clientId || null,
					clientName: clientInfo ? clientInfo.name : null,
					clientEmail: clientInfo ? clientInfo.email : null
				};

				// Save to backend
				await saveEventToDatabase(eventData);

				// Create event in Google Calendar if connected
				if (googleCalendarConnected) {
					try {
						const googleEventId = await createGoogleCalendarEventAPI(eventData);
						if (googleEventId) {
							eventData.googleEventId = googleEventId;
							eventData.isGoogleEvent = true;
							showSuccess('Event created in Google Calendar!');
						}
					} catch (error) {
						console.error('Google Calendar API error:', error);
						showError('Event saved locally but failed to sync with Google Calendar');
					}
				} else {
					// Fallback to opening Google Calendar URL
					createGoogleCalendarEvent(eventData);
				}

				// Save to local storage for calendar indicators
				saveEventLocally(eventData);

				// Close modal and show success
				closeCreateEventModal();
				if (!googleCalendarConnected) {
					showSuccess('Event created successfully!');
				}

			} catch (error) {
				console.error('Error creating event:', error);
				showError('Failed to create event. Please try again.');
			}
		}

		async function saveEventToDatabase(eventData) {
			try {
				const response = await fetch('/api/events', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${authToken}`
					},
					body: JSON.stringify(eventData)
				});

				if (!response.ok) {
					throw new Error('Failed to save event to database');
				}

				return await response.json();
			} catch (error) {
				console.error('Database save error:', error);
				// Don't throw - we'll still create the Google Calendar event
			}
		}

		function createGoogleCalendarEvent(eventData) {
			// Format dates for Google Calendar
			const formatDateForGoogle = (date) => {
				return new Date(date).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
			};

			const startDate = formatDateForGoogle(eventData.start);
			const endDate = formatDateForGoogle(eventData.end);

			// Build Google Calendar URL
			let calendarUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
			calendarUrl += `&text=${encodeURIComponent(eventData.title)}`;
			calendarUrl += `&dates=${startDate}/${endDate}`;
			
			if (eventData.description) {
				let details = eventData.description;
				if (eventData.clientName) {
					details += `\n\nClient: ${eventData.clientName}`;
				}
				if (eventData.clientEmail) {
					details += `\nEmail: ${eventData.clientEmail}`;
				}
				calendarUrl += `&details=${encodeURIComponent(details)}`;
			}

			if (eventData.location) {
				calendarUrl += `&location=${encodeURIComponent(eventData.location)}`;
			}

			if (eventData.clientEmail) {
				calendarUrl += `&add=${encodeURIComponent(eventData.clientEmail)}`;
			}

			// Open Google Calendar in new tab
			window.open(calendarUrl, '_blank');
		}

		// Local Event Storage
		let localEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
		let currentCalendarDate = new Date();

		// Custom Calendar Functions
		function //renderCustomCalendar() {
			const now = new Date();
			const year = currentCalendarDate.getFullYear();
			const month = currentCalendarDate.getMonth();
			
			// Update header
			const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
				'July', 'August', 'September', 'October', 'November', 'December'];
			document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
			
			// Get first day of month and number of days
			const firstDay = new Date(year, month, 1);
			const lastDay = new Date(year, month + 1, 0);
			const daysInMonth = lastDay.getDate();
			const startingDayOfWeek = firstDay.getDay();
			
			// Get days from previous month to fill the grid
			const prevMonth = new Date(year, month, 0);
			const daysInPrevMonth = prevMonth.getDate();
			
			// Clear calendar grid
			const calendarGrid = document.getElementById('calendarGrid');
			calendarGrid.innerHTML = '';
			
			// Add days from previous month
			for (let i = startingDayOfWeek - 1; i >= 0; i--) {
				const day = daysInPrevMonth - i;
				const dayElement = createDayElement(day, true, new Date(year, month - 1, day));
				calendarGrid.appendChild(dayElement);
			}
			
			// Add days of current month
			for (let day = 1; day <= daysInMonth; day++) {
				const date = new Date(year, month, day);
				const isToday = date.toDateString() === now.toDateString();
				const dayElement = createDayElement(day, false, date, isToday);
				calendarGrid.appendChild(dayElement);
			}
			
			// Add days from next month to fill remaining slots
			const totalCells = calendarGrid.children.length;
			const remainingCells = 42 - totalCells; // 6 weeks × 7 days
			for (let day = 1; day <= remainingCells; day++) {
				const dayElement = createDayElement(day, true, new Date(year, month + 1, day));
				calendarGrid.appendChild(dayElement);
			}
		}

		function createDayElement(dayNumber, isOtherMonth, date, isToday = false) {
			const dayElement = document.createElement('div');
			dayElement.className = 'calendar-day';
			
			if (isOtherMonth) {
				dayElement.classList.add('other-month');
			}
			if (isToday) {
				dayElement.classList.add('today');
			}
			
			// Add day number
			const dayNumberElement = document.createElement('div');
			dayNumberElement.className = 'day-number';
			dayNumberElement.textContent = dayNumber;
			dayElement.appendChild(dayNumberElement);
			
			// Check for events on this date
			const dateString = date.toISOString().split('T')[0];
			const dayEvents = localEvents.filter(event => {
				const eventDate = new Date(event.start).toISOString().split('T')[0];
				return eventDate === dateString;
			});
			
			// Add event indicators
			if (dayEvents.length > 0) {
				dayElement.classList.add('has-events');
				
				// Check if any events are from Google Calendar
				const hasGoogleEvents = dayEvents.some(event => event.isGoogleEvent);
				if (hasGoogleEvents) {
					dayElement.classList.add('has-google-events');
				}
				
				if (dayEvents.length === 1) {
					const indicator = document.createElement('div');
					indicator.className = dayEvents[0].isGoogleEvent ? 'event-indicator google-event' : 'event-indicator';
					dayElement.appendChild(indicator);
				} else {
					const count = document.createElement('div');
					count.className = hasGoogleEvents ? 'event-count google-events' : 'event-count';
					count.textContent = dayEvents.length;
					dayElement.appendChild(count);
				}
			}
			
			// Add click handler
			dayElement.addEventListener('click', () => showDayEvents(date, dayEvents));
			
			return dayElement;
		}

		function showDayEvents(date, events) {
			const popup = document.getElementById('eventDetailsPopup');
			const popupDate = document.getElementById('popupDate');
			const popupEvents = document.getElementById('popupEvents');
			
			// Store selected date for event creation
			window.selectedPopupDate = date;
			
			// Format date
			const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
			popupDate.textContent = date.toLocaleDateString('en-US', options);
			
			// Show events
			if (events.length > 0) {
				popupEvents.innerHTML = events.map(event => {
					const startTime = new Date(event.start).toLocaleTimeString('en-US', {
						hour: 'numeric',
						minute: '2-digit',
						hour12: true
					});
					const borderColor = event.isGoogleEvent ? '#4285f4' : 'var(--primary)';
					const source = event.isGoogleEvent ? '<div style="font-size: 11px; color: #4285f4; font-weight: 500;">📅 Google Calendar</div>' : '';
					return `
						<div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ${borderColor};">
							<div style="font-weight: 500; color: #333;">${event.title}</div>
							<div style="font-size: 12px; color: #666;">${startTime}</div>
							${event.clientName ? `<div style="font-size: 12px; color: var(--primary);">Client: ${event.clientName}</div>` : ''}
							${event.location ? `<div style="font-size: 12px; color: #666;">📍 ${event.location}</div>` : ''}
							${source}
						</div>
					`;
				}).join('');
			} else {
				popupEvents.innerHTML = '<div style="color: #666; font-style: italic;">No events scheduled</div>';
			}
			
			// Position and show popup
			popup.style.display = 'block';
			popup.style.left = '50%';
			popup.style.top = '50%';
			popup.style.transform = 'translate(-50%, -50%)';
		}

		// Navigation functions
		async function navigateMonth(direction) {
			currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
			if (googleCalendarConnected) {
				//await loadGoogleCalendarEvents();
			}
			//renderCustomCalendar();
		}

		// Initialize calendar navigation
		document.addEventListener('DOMContentLoaded', function() {
			// Calendar navigation
			document.getElementById('prevMonth').addEventListener('click', () => navigateMonth(-1));
			document.getElementById('nextMonth').addEventListener('click', () => navigateMonth(1));
			
			// Close popup when clicking outside
			document.addEventListener('click', function(event) {
				const popup = document.getElementById('eventDetailsPopup');
			});
			
			// Initial render
			//renderCustomCalendar();
			
			// Initialize Google Calendar API
			if (typeof gapi !== 'undefined') {
				//initializeGoogleCalendar();
			} else {
				console.warn('Google APIs not loaded');
			}
		});

		// Save event to local storage
		function saveEventLocally(eventData) {
			localEvents.push(eventData);
			localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
			//renderCustomCalendar(); // Refresh calendar to show new event
		}

		// Google Calendar API Integration
		let GOOGLE_CLIENT_ID = '';
		let GOOGLE_API_KEY = '';
		const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
		const SCOPES = 'https://www.googleapis.com/auth/calendar';

		let gapi;
		let googleCalendarConnected = false;
		let googleAuthInstance;

		// Load Google Calendar API credentials
		async function loadGoogleCredentials() {
			try {
				const response = await fetch('/api/google-calendar-config', {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				if (response.ok) {
					const config = await response.json();
					GOOGLE_CLIENT_ID = config.clientId;
					GOOGLE_API_KEY = config.apiKey;
					return true;
				}
			} catch (error) {
				console.log('Google Calendar API credentials not configured');
			}
			return false;
		}

		// Initialize Google Calendar API
		async function //initializeGoogleCalendar() {
			console.log('Initializing Google Calendar API...');
			
			// Load credentials from server
			const hasCredentials = await loadGoogleCredentials();
			if (!hasCredentials || !GOOGLE_CLIENT_ID || !GOOGLE_API_KEY) {
				console.log('Google Calendar API credentials not available - using fallback mode');
				updateGoogleCalendarButton('unavailable');
				return;
			}

			try {
				await new Promise((resolve) => {
					gapi.load('auth2:client', resolve);
				});

				await gapi.client.init({
					apiKey: GOOGLE_API_KEY,
					clientId: GOOGLE_CLIENT_ID,
					discoveryDocs: [DISCOVERY_DOC],
					scope: SCOPES
				});

				googleAuthInstance = gapi.auth2.getAuthInstance();
				const isSignedIn = googleAuthInstance.isSignedIn.get();
				
				if (isSignedIn) {
					googleCalendarConnected = true;
					updateGoogleCalendarButton('connected');
					//await loadGoogleCalendarEvents();
				}

				console.log('Google Calendar API initialized');
			} catch (error) {
				console.error('Error initializing Google Calendar API:', error);
				updateGoogleCalendarButton('error');
			}
		}

		// Handle Google Calendar connection button click
		async function handleGoogleCalendarConnection() {
			// For now, open Google Calendar directly with pre-filled event
			// This works without needing full OAuth setup
			if (currentLead) {
				// Create a pre-filled Google Calendar event URL
				const title = `Meeting with ${currentLead.name}`;
				const details = `Client: ${currentLead.name}\nEmail: ${currentLead.email}\nPhone: ${currentLead.phone}\nProject: ${currentLead.projectType || 'TBD'}\nBudget: $${(currentLead.budget || 0).toLocaleString()}`;
				
				let calendarUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
				calendarUrl += `&text=${encodeURIComponent(title)}`;
				calendarUrl += `&details=${encodeURIComponent(details)}`;
				
				if (currentLead.email) {
					calendarUrl += `&add=${encodeURIComponent(currentLead.email)}`;
				}
				
				// Set default time (tomorrow at 10 AM for 1 hour)
				const tomorrow = new Date();
				tomorrow.setDate(tomorrow.getDate() + 1);
				tomorrow.setHours(10, 0, 0, 0);
				
				const endTime = new Date(tomorrow);
				endTime.setHours(11, 0, 0, 0);
				
				const formatDateForGoogle = (date) => {
					return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
				};
				
				calendarUrl += `&dates=${formatDateForGoogle(tomorrow)}/${formatDateForGoogle(endTime)}`;
				
				window.open(calendarUrl, '_blank');
				return;
			}
			
			// If no customer selected, just open Google Calendar
			window.open('https://calendar.google.com/', '_blank');
			return;
			
			// Original OAuth code (keeping for future when properly configured)
			/*
			// Check if we're using the new googleCalendarManager
			if (typeof window.googleCalendarManager !== 'undefined') {
				const authStatus = window.googleCalendarManager.getAuthStatus();
				
				if (!authStatus.hasCredentials) {
					alert('Google Calendar API credentials are not configured.\n\nPlease contact your administrator to set up Google Calendar integration.');
					return;
				}
				
				if (!authStatus.initialized) {
					// Try to initialize
					const btn = document.getElementById('googleCalendarBtn');
					const btnText = document.getElementById('googleCalendarBtnText');
					btnText.textContent = 'Initializing...';
					btn.disabled = true;
					
					const success = await window.googleCalendarManager.init();
					if (!success) {
						alert('Failed to initialize Google Calendar. Please try again.');
						btnText.textContent = 'Connect Google Calendar';
						btn.disabled = false;
						return;
					}
				}
				
				if (authStatus.authenticated) {
					// Already connected, disconnect
					if (confirm('Disconnect from Google Calendar?')) {
						await window.googleCalendarManager.signOut();
						updateGoogleCalendarButton('disconnected');
						// Clear any Google events from calendar
					}
				} else {
					// Not connected, connect
					try {
						await window.googleCalendarManager.authenticate();
						updateGoogleCalendarButton('connected');
						// Load and display events
						await loadAndDisplayGoogleEvents();
					} catch (error) {
						console.error('Authentication failed:', error);
						alert('Failed to connect to Google Calendar. Please try again.');
					}
				}
			} else {
				// Fallback to old method
				await handleGoogleCalendarAuth();
			}
			*/
		}
		
		// Load and display Google Calendar events
		async function loadAndDisplayGoogleEvents() {
			if (typeof window.googleCalendarManager !== 'undefined' && window.googleCalendarManager.isAuthenticated) {
				try {
					// Get current month's date range
					const startOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
					const endOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0, 23, 59, 59);
					
					// Load events
					const events = await window.googleCalendarManager.listEvents(startOfMonth, endOfMonth);
					
					// Display events on calendar
					events.forEach(event => {
						const eventDate = new Date(event.start.dateTime || event.start.date);
						const dayElement = document.querySelector(`[data-date="${eventDate.toISOString().split('T')[0]}"]`);
						if (dayElement) {
							dayElement.classList.add('has-google-events');
							// Add event indicator or tooltip
							const eventIndicator = document.createElement('div');
							eventIndicator.style.cssText = 'width: 6px; height: 6px; background: #4285f4; border-radius: 50%; margin: 2px auto;';
							eventIndicator.title = event.summary;
						}
					});
					
					console.log(`Loaded ${events.length} Google Calendar events`);
				} catch (error) {
					console.error('Failed to load Google Calendar events:', error);
				}
			}
		}

		// Handle Google Calendar authentication (old method)
		async function handleGoogleCalendarAuth() {
			if (!googleAuthInstance) {
				showError('Google Calendar API not initialized');
				return;
			}

			try {
				if (googleCalendarConnected) {
					// Disconnect
					await googleAuthInstance.signOut();
					googleCalendarConnected = false;
					updateGoogleCalendarButton('disconnected');
					localEvents = localEvents.filter(event => !event.googleEventId);
					localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
					//renderCustomCalendar();
					showSuccess('Google Calendar disconnected');
				} else {
					// Connect
					await googleAuthInstance.signIn();
					googleCalendarConnected = true;
					updateGoogleCalendarButton('connected');
					//await loadGoogleCalendarEvents();
					showSuccess('Google Calendar connected successfully!');
				}
			} catch (error) {
				console.error('Google Calendar auth error:', error);
				showError('Failed to connect to Google Calendar. Please try again.');
			}
		}

		// Update the Google Calendar button appearance
		function updateGoogleCalendarButton(status) {
			const btn = document.getElementById('googleCalendarBtn');
			const btnText = document.getElementById('googleCalendarBtnText');
			
			// Also check for old button ID for backward compatibility
			const oldBtn = document.getElementById('googleCalendarAuthBtn');
			
			if (btn && btnText) {
				if (status === 'connected') {
					btnText.textContent = 'Google Calendar Connected';
					btn.style.background = '#34a853';
					btn.disabled = false;
				} else if (status === 'disconnected' || !status) {
					btnText.textContent = 'Connect Google Calendar';
					btn.style.background = '#4285f4';
					btn.disabled = false;
				} else if (status === 'unavailable') {
					btnText.textContent = 'Setup Required';
					btn.style.background = '#ff9800';
					btn.onclick = showGoogleCalendarSetupInfo;
					btn.disabled = false;
				} else if (status === 'error') {
					btnText.textContent = 'Connection Error';
					btn.style.background = '#f44336';
					btn.disabled = false;
				}
			}
			
			// Update old button if it exists
			if (oldBtn) {
				if (status === 'connected') {
					oldBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">sync</span>Disconnect Google Calendar';
					oldBtn.style.background = '#34a853';
					oldBtn.disabled = false;
				} else if (status === 'unavailable') {
					oldBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">info</span>Setup Required';
					oldBtn.style.background = '#ff9800';
					oldBtn.onclick = showGoogleCalendarSetupInfo;
					oldBtn.disabled = false;
				} else if (status === 'error') {
					oldBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">error</span>API Error';
					oldBtn.style.background = '#f44336';
					oldBtn.disabled = true;
				} else {
					oldBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">sync</span>Connect Google Calendar';
					oldBtn.style.background = '#4285f4';
					oldBtn.disabled = false;
				}
			}
		}

		// Show setup information
		function showGoogleCalendarSetupInfo() {
			alert(`Google Calendar API Setup Required:

1. Go to Google Cloud Console (console.cloud.google.com)
2. Create a project or select existing one
3. Enable Google Calendar API
4. Create credentials (OAuth 2.0 + API Key)
5. Add your domain to authorized origins
6. Contact your admin to add the credentials to the system

For now, events will open Google Calendar in your browser for manual creation.`);
		}

		// Load events from Google Calendar
		async function loadGoogleCalendarEvents() {
			if (!googleCalendarConnected || !gapi.client.calendar) {
				return;
			}

			try {
				// Get current month's date range
				const now = new Date();
				const startOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
				const endOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0, 23, 59, 59);

				const response = await gapi.client.calendar.events.list({
					calendarId: 'primary',
					timeMin: startOfMonth.toISOString(),
					timeMax: endOfMonth.toISOString(),
					showDeleted: false,
					singleEvents: true,
					orderBy: 'startTime'
				});

				const googleEvents = response.result.items || [];
				
				// Remove existing Google events from local storage
				localEvents = localEvents.filter(event => !event.googleEventId);

				// Add Google events to local events
				googleEvents.forEach(event => {
					const startTime = event.start.dateTime || event.start.date;
					const endTime = event.end.dateTime || event.end.date;
					
					localEvents.push({
						title: event.summary || 'Untitled Event',
						start: startTime,
						end: endTime,
						description: event.description || '',
						location: event.location || '',
						googleEventId: event.id,
						isGoogleEvent: true
					});
				});

				localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
				//renderCustomCalendar();

				console.log(`Loaded ${googleEvents.length} events from Google Calendar`);
			} catch (error) {
				console.error('Error loading Google Calendar events:', error);
				showError('Failed to load Google Calendar events');
			}
		}

		// Create event in Google Calendar
		async function createGoogleCalendarEventAPI(eventData) {
			if (!googleCalendarConnected || !gapi.client.calendar) {
				return null;
			}

			try {
				const event = {
					summary: eventData.title,
					start: {
						dateTime: eventData.start,
						timeZone: 'America/New_York'
					},
					end: {
						dateTime: eventData.end,
						timeZone: 'America/New_York'
					},
					description: eventData.description || '',
					location: eventData.location || ''
				};

				if (eventData.clientEmail) {
					event.attendees = [{ email: eventData.clientEmail }];
				}

				const response = await gapi.client.calendar.events.insert({
					calendarId: 'primary',
					resource: event
				});

				return response.result.id;
			} catch (error) {
				console.error('Error creating Google Calendar event:', error);
				throw error;
			}
		}
		// Delete customer function
		async function deleteCustomer() {
			// Use the global currentLeadId or window.currentLeadId as fallback
			const leadIdToDelete = currentLeadId || window.currentLeadId || (currentLead && currentLead._id);
			if (!leadIdToDelete) {
				alert('No customer selected. Please open a customer profile first.');
				return;
			}
			// Get customer name for confirmation
			const customerName = document.getElementById('profileName').textContent || 'this customer';
			// Confirm deletion
			if (!confirm(`Are you sure you want to permanently delete ${customerName}?\n\nThis action cannot be undone and will remove:\n• Customer profile\n• Email history\n• Notes and interactions\n• All associated data`)) {
				return;
			}
			// Show loading state
			const deleteBtn = document.getElementById('deleteCustomerBtn');
			const originalContent = deleteBtn.innerHTML;
			deleteBtn.innerHTML = '<span style="font-size: 12px;">⏳</span>';
			deleteBtn.disabled = true;
			try {
				const response = await fetch(`/api/leads/${leadIdToDelete}`, {
					method: 'DELETE',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					}
				});
				
				// Check if response is ok first
				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(`Server error: ${response.status} - ${errorText}`);
				}
				
				// Try to parse JSON response
				let result;
				try {
					result = await response.json();
				} catch (jsonError) {
					// If JSON parsing fails but response was ok, treat as success
					console.log('Delete response was not JSON, but status was OK');
					result = { success: true };
				}
				
				if (result.success) {
					// Show success message
					alert(`✅ ${customerName} has been permanently deleted`);
					// Clear current lead references before closing modal
					currentLead = null;
					window.currentLeadId = null;
					currentLeadId = null;
					// Close modal
					closeModal();
					// Refresh the leads table
					await loadLeads();
				} else {
					throw new Error(result.message || 'Failed to delete customer');
				}
			} catch (error) {
				alert(`❌ Failed to delete customer: ${error.message}`);
				// Restore button
				deleteBtn.innerHTML = originalContent;
				deleteBtn.disabled = false;
			} finally {
				// Always ensure button is re-enabled if it exists
				const deleteBtn = document.getElementById('deleteCustomerBtn');
				if (deleteBtn && deleteBtn.disabled) {
					deleteBtn.disabled = false;
					if (!deleteBtn.innerHTML || deleteBtn.innerHTML.includes('⏳')) {
						deleteBtn.innerHTML = '🗑️';
					}
				}
			}
		}
		// Quick reply functions for conversation
		function insertQuickReply(text) {
			const emailBody = document.getElementById('emailBody');
			if (emailBody) {
				emailBody.value = text;
				emailBody.focus();
				// Scroll to email composer
				emailBody.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}
		}
		// Refresh conversation
		async function refreshConversation() {
			if (currentLead) {
				await populateEmailHistory(currentLead);
			}
		}
		// Refresh data
		function refreshData() {
			loadLeads();
		}
		// Export to CSV
		function exportLeads() {
			if (filteredLeads.length === 0) {
				alert('No leads to export');
				return;
			}
			const headers = ['Date', 'Name', 'Email', 'Phone', 'Company', 'Project Type', 'Budget', 'Timeline', 'Features', 'Status', 'Message'];
			const csvContent = [
				headers.join(','),
				...filteredLeads.map(lead => [
					new Date(lead.createdAt).toLocaleDateString(),
					lead.name,
					lead.email,
					lead.phone,
					lead.company || '',
					lead.projectType,
					lead.budget,
					lead.timeline,
					(lead.features || []).join('; '),
					lead.status,
					lead.message || ''
				].map(v => `"${v}"`).join(','))
			].join('\n');
			const blob = new Blob([csvContent], { type: 'text/csv' });
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.setAttribute('hidden', '');
			a.setAttribute('href', url);
			a.setAttribute('download', `leads-${new Date().toISOString().split('T')[0]}.csv`);
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
		}
		
		// Add Customer Modal Functions
		function openAddCustomerModal() {
			document.getElementById('addCustomerModal').classList.add('active');
			// Clear form
			document.getElementById('addCustomerForm').reset();
		}
		
		function closeAddCustomerModal() {
			document.getElementById('addCustomerModal').classList.remove('active');
		}
		
		async function handleAddCustomer(event) {
			event.preventDefault();
			
			// Get form values
			const customerData = {
				name: document.getElementById('newCustomerName').value.trim(),
				email: document.getElementById('newCustomerEmail').value.trim().toLowerCase(),
				phone: document.getElementById('newCustomerPhone').value.trim(),
				company: document.getElementById('newCustomerCompany').value.trim(),
				projectType: document.getElementById('newCustomerProjectType').value,
				budget: parseInt(document.getElementById('newCustomerBudget').value) || 0,
				timeline: document.getElementById('newCustomerTimeline').value,
				message: document.getElementById('newCustomerMessage').value.trim(),
				status: 'new'
			};
			
			// Validate required fields
			if (!customerData.name || !customerData.email || !customerData.phone) {
				alert('Please fill in all required fields (Name, Email, Phone)');
				return;
			}
			
			// Show loading state - get button reference early and safely
			const submitBtn = document.querySelector('#addCustomerForm button[type="submit"]');
			let originalText = 'Add Customer';
			if (submitBtn) {
				originalText = submitBtn.innerHTML;
				submitBtn.innerHTML = 'Adding Customer...';
				submitBtn.disabled = true;
			}
			
			try {
				const response = await fetch('/api/leads', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(customerData)
				});
				
				const result = await response.json();
				
				if (response.status === 409) {
					// Customer already exists
					alert(`⚠️ ${result.message}\n\nExisting customer:\n${result.existingCustomer.name} (${result.existingCustomer.email})`);
					if (submitBtn) {
						submitBtn.innerHTML = originalText;
						submitBtn.disabled = false;
					}
					return;
				}
				
				if (result.success) {
					alert(`✅ Customer "${customerData.name}" added successfully!`);
					closeAddCustomerModal();
					// Refresh the leads table
					await loadLeads();
					// Optionally open the new customer's profile
					if (result.lead && result.lead._id) {
						viewLead(result.lead._id);
					}
				} else {
					throw new Error(result.message || 'Failed to add customer');
				}
			} catch (error) {
				alert(`❌ Failed to add customer: ${error.message}`);
			} finally {
				// Restore button if it exists
				if (submitBtn) {
					submitBtn.innerHTML = originalText;
					submitBtn.disabled = false;
				}
			}
		}
		
		// Schedule Event Functions
		function scheduleWorkflowEvent(itemIndex, itemType, item) {
			// Get current lead data
			if (!currentLead) {
				alert('No customer selected');
				return;
			}
			
			// Open the schedule modal
			document.getElementById('scheduleEventModal').classList.add('active');
			
			// Pre-fill the form with workflow item data
			document.getElementById('eventTitle').value = item.name || 'Meeting with ' + currentLead.name;
			document.getElementById('eventLeadId').value = currentLead._id;
			document.getElementById('workflowItemId').value = itemIndex;
			document.getElementById('workflowItemType').value = itemType;
			
			// Set default date to tomorrow
			const tomorrow = new Date();
			tomorrow.setDate(tomorrow.getDate() + 1);
			document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
			document.getElementById('eventTime').value = '10:00';
			
			// Add workflow details to description
			const description = `Customer: ${currentLead.name}\nEmail: ${currentLead.email}\nPhone: ${currentLead.phone}\n\nWorkflow Item: ${item.name}\nStatus: ${item.status || 'Pending'}`;
			document.getElementById('eventDescription').value = description;
		}
		
		function closeScheduleEventModal() {
			document.getElementById('scheduleEventModal').classList.remove('active');
			document.getElementById('scheduleEventForm').reset();
		}
		
		// Schedule event from workflow stage
		function scheduleStageEvent(leadId, leadName, stageName, stageIndex) {
			// Pre-fill the schedule form with stage-specific data
			document.getElementById('eventLeadId').value = leadId;
			
			// Set default title based on stage
			const stageEventTitles = {
				'Initial Contact': `Initial Contact - ${leadName}`,
				'Discovery': `Discovery Call - ${leadName}`,
				'Proposal': `Proposal Review - ${leadName}`,
				'Negotiation': `Contract Discussion - ${leadName}`,
				'Project Start': `Project Kickoff - ${leadName}`
			};
			document.getElementById('eventTitle').value = stageEventTitles[stageName] || `${stageName} - ${leadName}`;
			
			// Set appropriate event type based on stage
			const stageEventTypes = {
				'Initial Contact': 'discovery-call',
				'Discovery': 'discovery-call',
				'Proposal': 'proposal-review',
				'Negotiation': 'follow-up',
				'Project Start': 'project-kickoff'
			};
			document.getElementById('eventType').value = stageEventTypes[stageName] || 'other';
			
			// Set default description
			document.getElementById('eventDescription').value = `${stageName} stage meeting for ${leadName}`;
			
			// Set workflow item ID for tracking
			document.getElementById('workflowItemId').value = `stage-${stageIndex}`;
			
			// Set default date to tomorrow and time to 10 AM
			const tomorrow = new Date();
			tomorrow.setDate(tomorrow.getDate() + 1);
			document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
			document.getElementById('eventTime').value = '10:00';
			
			// Show the modal
			openScheduleEventModal();
		}
		
		// Schedule new event for current lead
		function scheduleNewEventForLead() {
			if (!currentLead) return;
			
			document.getElementById('eventLeadId').value = currentLead._id;
			document.getElementById('eventTitle').value = `Meeting with ${currentLead.name || 'Customer'}`;
			document.getElementById('eventType').value = 'follow-up';
			document.getElementById('eventDescription').value = '';
			
			// Set default date to tomorrow and time to 10 AM
			const tomorrow = new Date();
			tomorrow.setDate(tomorrow.getDate() + 1);
			document.getElementById('eventDate').value = tomorrow.toISOString().split('T')[0];
			document.getElementById('eventTime').value = '10:00';
			
			openScheduleEventModal();
		}
		
		// Load customer events
		async function loadCustomerEvents(leadId) {
			try {
				const response = await fetch(`/api/calendar/events?leadId=${leadId}`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				
				if (!response.ok) {
					throw new Error('Failed to load events');
				}
				
				const data = await response.json();
				displayCustomerEvents(data.events || []);
			} catch (error) {
				console.error('Error loading customer events:', error);
				displayCustomerEvents([]);
			}
		}
		
		// Display customer events
		function displayCustomerEvents(events) {
			const eventsList = document.getElementById('customerEventsList');
			const noEventsMessage = document.getElementById('noEventsMessage');
			
			if (events.length === 0) {
				eventsList.style.display = 'none';
				noEventsMessage.style.display = 'block';
				return;
			}
			
			eventsList.style.display = 'flex';
			noEventsMessage.style.display = 'none';
			
			// Sort events by start time
			events.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
			
			eventsList.innerHTML = events.map(event => {
				const startDate = new Date(event.startTime);
				const endDate = new Date(event.endTime);
				const isPast = startDate < new Date();
				
				return `
					<div class="event-card" style="background: ${isPast ? '#f9fafb' : 'white'}; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; position: relative;">
						<div style="display: flex; justify-content: space-between; align-items: start;">
							<div style="flex: 1;">
								<h5 style="margin: 0 0 8px 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
									<span class="material-icons" style="font-size: 20px; color: ${isPast ? '#9ca3af' : '#4285f4'};">
										${getEventIcon(event.eventType)}
									</span>
									${event.title}
									${isPast ? '<span style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">Past</span>' : ''}
								</h5>
								<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
									<span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">schedule</span>
									${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
									- ${endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
								</div>
								${event.description ? `<p style="margin: 8px 0; font-size: 13px; color: var(--text-secondary);">${event.description}</p>` : ''}
								${event.location ? `
									<div style="font-size: 13px; color: var(--text-secondary);">
										<span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">place</span>
										${event.location}
									</div>
								` : ''}
							</div>
							<div style="display: flex; gap: 8px;">
								${!isPast ? `
									<button  
										style="background: transparent; border: 1px solid var(--border-color); padding: 6px; border-radius: 4px; cursor: pointer;"
										title="Edit Event">
										<span class="material-icons" style="font-size: 18px; color: var(--text-secondary);">edit</span>
									</button>
								` : ''}
								<button  
									style="background: transparent; border: 1px solid var(--border-color); padding: 6px; border-radius: 4px; cursor: pointer;"
									title="Delete Event">
									<span class="material-icons" style="font-size: 18px; color: #ef4444;">delete</span>
								</button>
							</div>
						</div>
						${event.googleCalendarSynced ? `
							<div style="position: absolute; bottom: 8px; right: 8px; font-size: 11px; color: #10b981; display: flex; align-items: center; gap: 4px;">
								<span class="material-icons" style="font-size: 14px;">sync</span>
								Synced to Google
							</div>
						` : ''}
					</div>
				`;
			}).join('');
		}
		
		// Get appropriate icon for event type
		function getEventIcon(eventType) {
			const icons = {
				'discovery-call': 'phone',
				'follow-up': 'chat',
				'proposal-review': 'description',
				'project-kickoff': 'rocket_launch',
				'check-in': 'check_circle',
				'final-review': 'rate_review',
				'workflow-task': 'task_alt',
				'other': 'event'
			};
			return icons[eventType] || 'event';
		}
		
		// Drag and drop for column reordering
		let draggedColumnIndex = null;
		
		function dragStartColumn(event, index) {
			draggedColumnIndex = index;
			event.dataTransfer.effectAllowed = 'move';
			event.target.style.opacity = '0.5';
		}
		
		function dragOverColumn(event) {
			event.preventDefault();
			event.dataTransfer.dropEffect = 'move';
		}
		
		function dropColumn(event, targetIndex) {
			event.preventDefault();
			
			if (draggedColumnIndex !== null && draggedColumnIndex !== targetIndex) {
				// Reorder columns
				const columns = [...workflowData.columns];
				const draggedColumn = columns[draggedColumnIndex];
				
				// Don't allow moving fixed columns
				if (draggedColumn.fixed) return;
				
				// Remove dragged column
				columns.splice(draggedColumnIndex, 1);
				
				// Insert at new position
				if (targetIndex > draggedColumnIndex) {
					columns.splice(targetIndex - 1, 0, draggedColumn);
				} else {
					columns.splice(targetIndex, 0, draggedColumn);
				}
				
				workflowData.columns = columns;
				
				// Refresh the dialog
				const currentColumnsDiv = document.getElementById('currentColumns');
				if (currentColumnsDiv) {
					refreshColumnsList();
				}
			}
			
			// Reset opacity
			document.querySelectorAll('.column-item').forEach(item => {
				item.style.opacity = '1';
			});
			
			draggedColumnIndex = null;
		}
		
		// Edit column width
		function editColumnWidth(columnId) {
			const column = workflowData.columns.find(c => c.id === columnId);
			if (!column) return;
			
			const newWidth = prompt(`Enter width for "${column.name}" column (in pixels):`, column.width);
			if (newWidth !== null) {
				const width = parseInt(newWidth);
				if (width >= 50 && width <= 500) {
					column.width = width;
					refreshColumnsList();
				} else {
					alert('Width must be between 50 and 500 pixels');
				}
			}
		}
		
		// Toggle quick column menu
		function toggleQuickColumnMenu() {
			const menu = document.getElementById('quickColumnMenu');
			const isVisible = menu.style.display !== 'none';
			
			if (!isVisible) {
				// Populate menu with column options
				const existingColumns = workflowData.columns.map(c => c.id);
				const availableColumns = [
					{ id: 'budget', name: 'Budget', type: 'number', icon: 'attach_money' },
					{ id: 'hours', name: 'Est. Hours', type: 'number', icon: 'schedule' },
					{ id: 'actualHours', name: 'Actual Hours', type: 'number', icon: 'timer' },
					{ id: 'tags', name: 'Tags', type: 'text', icon: 'label' },
					{ id: 'notes', name: 'Notes', type: 'text', icon: 'note' },
					{ id: 'client', name: 'Client', type: 'text', icon: 'person' },
					{ id: 'team', name: 'Team', type: 'text', icon: 'group' },
					{ id: 'category', name: 'Category', type: 'select', icon: 'category', options: ['Design', 'Development', 'Testing', 'Marketing', 'Other'] },
					{ id: 'phase', name: 'Phase', type: 'select', icon: 'timeline', options: ['Planning', 'Execution', 'Review', 'Complete'] },
					{ id: 'risk', name: 'Risk Level', type: 'select', icon: 'warning', options: ['Low', 'Medium', 'High', 'Critical'] },
					{ id: 'reviewer', name: 'Reviewer', type: 'text', icon: 'rate_review' },
					{ id: 'link', name: 'Link/URL', type: 'url', icon: 'link' },
					{ id: 'attachment', name: 'Attachment', type: 'text', icon: 'attach_file' },
					{ id: 'custom', name: 'Custom Column...', type: 'custom', icon: 'add_circle' }
				];
				
				// Filter out already added columns
				const filteredColumns = availableColumns.filter(col => 
					col.id === 'custom' || !existingColumns.includes(col.id)
				);
				
				menu.innerHTML = `
					<div style="padding: 8px 0;">
						<div style="padding: 8px 16px; font-size: 12px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border-color);">
							QUICK ADD COLUMN
						</div>
						${filteredColumns.length > 1 ? filteredColumns.map(col => `
							<div onclick="${col.id === 'custom' ? 'showCustomColumnDialog()' : `quickAddColumn('${col.id}', '${col.name}', '${col.type}', '${col.options ? col.options.join(',') : ''}')`}" 
								style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;"
								onmouseover="this.style.background='var(--hover-bg)'" 
								onmouseout="this.style.background='transparent'">
								<span class="material-icons" style="font-size: 18px; color: var(--text-secondary);">${col.icon}</span>
								<div>
									<div style="font-size: 14px; color: var(--text-primary);">${col.name}</div>
									${col.id !== 'custom' ? `<div style="font-size: 11px; color: var(--text-secondary);">Type: ${col.type}</div>` : ''}
								</div>
							</div>
						`).join('') : `
							<div style="padding: 20px 16px; text-align: center; color: var(--text-secondary);">
								<span class="material-icons" style="font-size: 32px; color: var(--border-color); margin-bottom: 8px;">check_circle</span>
								<div style="font-size: 14px;">All columns added!</div>
								<button onclick="showCustomColumnDialog()" style="margin-top: 12px; background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
									Add Custom Column
								</button>
							</div>
						`}
					</div>
				`;
				
				menu.style.display = 'block';
				
				// Close menu when clicking outside
				setTimeout(() => {
					document.addEventListener('click', closeQuickColumnMenu);
				}, 100);
			} else {
				closeQuickColumnMenu();
			}
		}
		
		function closeQuickColumnMenu() {
			document.getElementById('quickColumnMenu').style.display = 'none';
			document.removeEventListener('click', closeQuickColumnMenu);
		}
		
		// Quick add predefined column
		function quickAddColumn(id, name, type, optionsStr) {
			const newColumn = {
				id: id,
				name: name,
				type: type,
				width: 120
			};
			
			if (optionsStr) {
				newColumn.options = optionsStr.split(',');
			}
			
			// Add to columns array
			workflowData.columns.push(newColumn);
			
			// Initialize values for existing items
			workflowData.items.forEach(item => {
				if (!item[id]) {
					item[id] = type === 'number' ? 0 : '';
				}
				if (item.subitems) {
					item.subitems.forEach(subitem => {
						if (!subitem[id]) {
							subitem[id] = type === 'number' ? 0 : '';
						}
					});
				}
			});
			
			closeQuickColumnMenu();
			renderWorkflowBoard();
			saveWorkflowData();
			showTemporaryMessage(`✅ Added "${name}" column`);
		}
		
		// Show custom column dialog
		function showCustomColumnDialog() {
			closeQuickColumnMenu();
			
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed; top: 0; left: 0; right: 0; bottom: 0;
				background: rgba(0,0,0,0.5); display: flex; align-items: center;
				justify-content: center; z-index: 10001;
			`;
			
			const dialog = document.createElement('div');
			dialog.style.cssText = `
				background: white; padding: 24px; border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0,0,0,0.2); width: 400px; max-width: 90%;
			`;
			
			dialog.innerHTML = `
				<h3 style="margin: 0 0 20px 0; font-size: 18px;">Add Custom Column</h3>
				
				<div style="margin-bottom: 16px;">
					<label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Column Name</label>
					<input type="text" id="customColumnName" placeholder="e.g., Location, Contract #" 
						style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
				</div>
				
				<div style="margin-bottom: 16px;">
					<label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Column Type</label>
					<select id="customColumnType" onchange="toggleOptionsField()" 
						style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
						<option value="text">Text</option>
						<option value="number">Number</option>
						<option value="date">Date</option>
						<option value="select">Dropdown</option>
						<option value="url">URL/Link</option>
						<option value="email">Email</option>
						<option value="phone">Phone</option>
						<option value="checkbox">Checkbox</option>
					</select>
				</div>
				
				<div id="optionsField" style="margin-bottom: 16px; display: none;">
					<label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Dropdown Options</label>
					<input type="text" id="customColumnOptions" placeholder="Option 1, Option 2, Option 3" 
						style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
					<small style="color: var(--text-secondary); font-size: 12px;">Separate options with commas</small>
				</div>
				
				<div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
					<button onclick="closeCustomColumnDialog()" 
						style="padding: 10px 20px; border: 1px solid var(--border-color); background: white; border-radius: 6px; cursor: pointer;">
						Cancel
					</button>
					<button onclick="addCustomColumn()" 
						style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
						Add Column
					</button>
				</div>
			`;
			
			modal.appendChild(dialog);
			document.body.appendChild(modal);
			
			// Focus on name input
			setTimeout(() => {
				document.getElementById('customColumnName').focus();
			}, 100);
			
			// Make functions available
			window.toggleOptionsField = () => {
				const type = document.getElementById('customColumnType').value;
				document.getElementById('optionsField').style.display = type === 'select' ? 'block' : 'none';
			};
			
			window.addCustomColumn = () => {
				const name = document.getElementById('customColumnName').value.trim();
				const type = document.getElementById('customColumnType').value;
				const optionsStr = document.getElementById('customColumnOptions').value.trim();
				
				if (!name) {
					alert('Please enter a column name');
					return;
				}
				
				// Generate ID from name
				const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
				
				// Check if column already exists
				if (workflowData.columns.some(c => c.id === id)) {
					alert('A column with this name already exists');
					return;
				}
				
				const newColumn = {
					id: id,
					name: name,
					type: type,
					width: 120
				};
				
				if (type === 'select' && optionsStr) {
					newColumn.options = optionsStr.split(',').map(o => o.trim());
				}
				
				// Add column
				workflowData.columns.push(newColumn);
				
				// Initialize values
				const defaultValue = type === 'number' ? 0 : type === 'checkbox' ? false : '';
				workflowData.items.forEach(item => {
					item[id] = defaultValue;
					if (item.subitems) {
						item.subitems.forEach(subitem => {
							subitem[id] = defaultValue;
						});
					}
				});
				
				closeCustomColumnDialog();
				renderWorkflowBoard();
				saveWorkflowData();
				showTemporaryMessage(`✅ Added custom column "${name}"`);
			};
			
			window.closeCustomColumnDialog = () => {
				document.body.removeChild(modal);
				delete window.toggleOptionsField;
				delete window.addCustomColumn;
				delete window.closeCustomColumnDialog;
			};
			
			// Close on background click
			modal.onclick = (e) => {
				if (e.target === modal) {
					closeCustomColumnDialog();
				}
			};
		}
		
		// Sync workflow date to calendar
		async function //syncWorkflowDateToCalendar(itemIndex, workflowItem, dateColumn, parentName = '') {
			// Get the current lead from various possible sources
			const lead = currentLead || window.currentSelectedLead || getCurrentLead();
			if (!lead || !lead._id) {
				console.error('[Calendar Sync] No lead found for calendar sync', {
					currentLead,
					windowSelectedLead: window.currentSelectedLead,
					getCurrentLead: getCurrentLead()
				});
				showTemporaryMessage('❌ Cannot sync to calendar - no customer selected', 3000);
				return;
			}
			
			const itemName = parentName ? `${parentName} - ${workflowItem.name}` : workflowItem.name;
			const workflowItemId = `workflow-${itemIndex}-${dateColumn}`;  // Include column in ID for unique events per date column
			
			console.log(`[Calendar Sync] Starting sync for item: ${itemName}, column: ${dateColumn}, leadId: ${lead._id}`);
			
			try {
				// Check if an event already exists for this workflow item and date column
				const existingEventsResponse = await fetch(`/api/calendar/events?leadId=${lead._id}`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				
				let existingEvent = null;
				if (existingEventsResponse.ok) {
					const data = await existingEventsResponse.json();
					existingEvent = data.events.find(e => e.workflowItemId === workflowItemId);
					console.log(`[Calendar Sync] Found existing event: ${existingEvent ? 'Yes' : 'No'}`);
				} else {
					console.error('[Calendar Sync] Failed to fetch existing events:', existingEventsResponse.status);
				}
				
				// Get the date value for the specific column
				const dateValue = workflowItem[dateColumn] ? new Date(workflowItem[dateColumn]) : null;
				
				// Get column name for better event titles
				const column = workflowData.columns.find(c => c.id === dateColumn);
				const columnName = column ? column.name : dateColumn;
				
				console.log(`[Calendar Sync] ${columnName}: ${dateValue}`);
				
				// If date is cleared, delete the event
				if (!dateValue) {
					if (existingEvent) {
						await fetch(`/api/calendar/events/${existingEvent._id}`, {
							method: 'DELETE',
							headers: {
								'Authorization': `Bearer ${authToken}`
							}
						});
						console.log('[Calendar Sync] Deleted calendar event for cleared date');
						showTemporaryMessage('📅 Removed from calendar', 2000);
						// Refresh calendar if it's visible
						if (document.querySelector('#calendarTab').style.display !== 'none') {
							await populateCalendarTab(lead);
						}
					}
					return;
				}
				
				// Determine event start and end times based on the column type
				let eventStart, eventEnd;
				let eventTitle = itemName;
				
				if (dateColumn === 'dueDate' || columnName.toLowerCase().includes('due') || columnName.toLowerCase().includes('deadline')) {
					// Due date - create 2-hour event in afternoon
					eventStart = new Date(dateValue);
					eventStart.setHours(14, 0, 0, 0); // 2 PM for deadlines
					eventEnd = new Date(dateValue);
					eventEnd.setHours(16, 0, 0, 0);
					eventTitle = `${itemName} (${columnName})`;
				} else if (dateColumn === 'startDate' || columnName.toLowerCase().includes('start')) {
					// Start date - create 2-hour event in morning
					eventStart = new Date(dateValue);
					eventStart.setHours(9, 0, 0, 0);
					eventEnd = new Date(dateValue);
					eventEnd.setHours(11, 0, 0, 0);
					eventTitle = `${itemName} (${columnName})`;
				} else {
					// Generic date column - create 1-hour event at noon
					eventStart = new Date(dateValue);
					eventStart.setHours(12, 0, 0, 0);
					eventEnd = new Date(dateValue);
					eventEnd.setHours(13, 0, 0, 0);
					eventTitle = `${itemName} - ${columnName}`;
				}
				
				const eventData = {
					leadId: lead._id,
					title: eventTitle,
					eventType: 'workflow-task',
					description: `Workflow Task: ${itemName}\n${columnName}: ${dateValue.toLocaleDateString()}\nStatus: ${workflowItem.status || 'Not Started'}\nPriority: ${workflowItem.priority || 'Medium'}\nProgress: ${workflowItem.progress || 0}%`,
					location: '',
					workflowItemId: workflowItemId,
					startTime: eventStart.toISOString(),
					endTime: eventEnd.toISOString(),
					syncToGoogle: true
				};
				
				if (existingEvent) {
					// Update existing event
					const updateResponse = await fetch(`/api/calendar/events/${existingEvent._id}`, {
						method: 'PUT',
						headers: {
							'Authorization': `Bearer ${authToken}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(eventData)
					});
					
					if (updateResponse.ok) {
						console.log('[Calendar Sync] Updated calendar event from workflow date');
						showTemporaryMessage(`✅ Calendar updated: ${eventTitle}`, 3000);
					} else {
						console.error('[Calendar Sync] Failed to update event:', updateResponse.status);
						showTemporaryMessage('❌ Failed to update calendar event', 3000);
					}
				} else {
					// Create new event
					const createResponse = await fetch('/api/calendar/events', {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${authToken}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(eventData)
					});
					
					if (createResponse.ok) {
						console.log('[Calendar Sync] Created calendar event from workflow date');
						showTemporaryMessage(`✅ Added to calendar: ${eventTitle}`, 3000);
					} else {
						console.error('[Calendar Sync] Failed to create event:', createResponse.status);
						showTemporaryMessage('❌ Failed to create calendar event', 3000);
					}
				}
				
				// Refresh calendar if it's visible
				if (document.getElementById('customCalendar')) {
					await //loadCalendarEvents();
					//renderCustomCalendar();
				}
				
				// Refresh customer events if calendar tab is active
				if (document.getElementById('tab-calendar').classList.contains('active')) {
					await loadCustomerEvents(lead._id);  // Fixed: was using currentLead._id
				}
				
				// Also refresh the calendar tab if it's open
				const calendarTab = document.querySelector('#calendarTab');
				if (calendarTab && calendarTab.style.display !== 'none') {
					await populateCalendarTab(lead);
				}
			} catch (error) {
				console.error('[Calendar Sync] Error syncing workflow date to calendar:', error);
			}
		}
		
		async function handleScheduleEvent(event) {
			event.preventDefault();
			
			const form = document.getElementById('scheduleEventForm');
			const eventId = form.dataset.eventId; // Check if we're editing
			
			const eventData = {
				leadId: document.getElementById('eventLeadId').value,
				title: document.getElementById('eventTitle').value,
				eventType: document.getElementById('eventType').value,
				description: document.getElementById('eventDescription').value,
				location: document.getElementById('eventLocation').value,
				workflowItemId: document.getElementById('workflowItemId').value,
				syncToGoogle: document.getElementById('syncToGoogle').checked
			};
			
			// Calculate start and end times
			const date = document.getElementById('eventDate').value;
			const time = document.getElementById('eventTime').value;
			const duration = parseInt(document.getElementById('eventDuration').value);
			
			const startTime = new Date(`${date}T${time}`);
			const endTime = new Date(startTime.getTime() + duration * 60000);
			
			eventData.startTime = startTime.toISOString();
			eventData.endTime = endTime.toISOString();
			
			try {
				let response;
				if (eventId) {
					// Update existing event
					response = await fetch(`/api/calendar/events/${eventId}`, {
						method: 'PUT',
						headers: {
							'Authorization': `Bearer ${authToken}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(eventData)
					});
				} else {
					// Create new event
					response = await fetch('/api/calendar/events', {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${authToken}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(eventData)
					});
				}
				
				const result = await response.json();
				
				if (result.success) {
					// If sync to Google is enabled, also create/update Google Calendar event
					if (eventData.syncToGoogle) {
						createGoogleCalendarEventFromWorkflow(result.event);
					}
					
					alert(`✅ Event ${eventId ? 'updated' : 'scheduled'} successfully!`);
					closeScheduleEventModal();
					
					// Clear the event ID
					delete form.dataset.eventId;
					
					// Reset submit button text
					const submitBtn = form.querySelector('button[type="submit"]');
					if (submitBtn) {
						submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">event</span> Schedule Event';
					}
					
					// Refresh calendar to show new/updated event
					await //loadCalendarEvents();
					//renderCustomCalendar();
					
					// If we're in the customer profile, refresh events
					if (currentLead) {
						await loadCustomerEvents(currentLead._id);
					}
				} else {
					throw new Error(result.message || `Failed to ${eventId ? 'update' : 'schedule'} event`);
				}
			} catch (error) {
				alert(`❌ Failed to ${eventId ? 'update' : 'schedule'} event: ${error.message}`);
			}
		}
		
		function createGoogleCalendarEventFromWorkflow(event) {
			// Create Google Calendar URL with event details
			const title = encodeURIComponent(event.title);
			const details = encodeURIComponent(event.description || '');
			const location = encodeURIComponent(event.location || '');
			
			// Format dates for Google Calendar
			const startDate = new Date(event.startTime);
			const endDate = new Date(event.endTime);
			
			const formatDateForGoogle = (date) => {
				return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
			};
			
			let calendarUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
			calendarUrl += `&text=${title}`;
			calendarUrl += `&details=${details}`;
			calendarUrl += `&location=${location}`;
			calendarUrl += `&dates=${formatDateForGoogle(startDate)}/${formatDateForGoogle(endDate)}`;
			
			// Add customer email if available
			if (currentLead && currentLead.email) {
				calendarUrl += `&add=${encodeURIComponent(currentLead.email)}`;
			}
			
			// Open in new tab
			window.open(calendarUrl, '_blank');
		}
		
		// Load calendar events from database
		async function //loadCalendarEvents() {
			try {
				// Get current month's date range
				const startOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
				const endOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0, 23, 59, 59);
				
				const response = await fetch(`/api/calendar/events?start=${startOfMonth.toISOString()}&end=${endOfMonth.toISOString()}`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				
				if (response.ok) {
					const result = await response.json();
					if (result.success) {
						// Store events for calendar display
						window.calendarEvents = result.events;
						
						// Update calendar display
						displayEventsOnCalendar(result.events);
					}
				}
			} catch (error) {
				console.error('Failed to load calendar events:', error);
			}
		}
		
		// Display events on the calendar
		function displayEventsOnCalendar(events) {
			// Clear existing event indicators
					
					dayElement.appendChild(indicator);
					dayElement.classList.add('has-events');
				}
			});
		}
		
		// Show event details popup
		function showEventDetails(event) {
			const lead = event.leadId;
			const popup = document.getElementById('eventDetailsPopup');
			
			popup.innerHTML = `
				<div style="font-weight: 600; margin-bottom: 10px;">${event.title}</div>
				<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
					${new Date(event.startTime).toLocaleString()} - ${new Date(event.endTime).toLocaleTimeString()}
				</div>
				${lead ? `<div style="font-size: 13px; margin-bottom: 8px;">Customer: ${lead.name}</div>` : ''}
				${event.location ? `<div style="font-size: 13px; margin-bottom: 8px;">📍 ${event.location}</div>` : ''}
				${event.description ? `<div style="font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">${event.description.replace(/\n/g, '<br>')}</div>` : ''}
				<div style="margin-top: 15px; display: flex; gap: 8px;">
					<button  style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
					<button  style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
				</div>
			`;
			
			popup.style.display = 'block';
			// Position popup near the clicked element
			popup.style.top = '50%';
			popup.style.left = '50%';
			popup.style.transform = 'translate(-50%, -50%)';
		}
		
		// Edit calendar event
		async function editCalendarEvent(eventId) {
			try {
				// First fetch the event details
				const response = await fetch(`/api/calendar/events/${eventId}`, {
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				
				if (!response.ok) {
					throw new Error('Failed to fetch event');
				}
				
				const data = await response.json();
				const event = data.event;
				
				// Populate the form with event data
				document.getElementById('eventLeadId').value = event.leadId;
				document.getElementById('eventTitle').value = event.title;
				document.getElementById('eventType').value = event.eventType || 'other';
				document.getElementById('eventDescription').value = event.description || '';
				document.getElementById('eventLocation').value = event.location || '';
				
				// Set date and time
				const startDate = new Date(event.startTime);
				const endDate = new Date(event.endTime);
				const duration = Math.round((endDate - startDate) / 60000); // Convert to minutes
				
				document.getElementById('eventDate').value = startDate.toISOString().split('T')[0];
				document.getElementById('eventTime').value = startDate.toTimeString().substring(0, 5);
				document.getElementById('eventDuration').value = duration;
				
				// Store event ID for update
				document.getElementById('scheduleEventForm').dataset.eventId = eventId;
				
				// Change submit button text
				const submitBtn = document.querySelector('#scheduleEventForm button[type="submit"]');
				if (submitBtn) {
					submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">save</span> Update Event';
				}
				
				// Show the modal
				openScheduleEventModal();
			} catch (error) {
				console.error('Error editing event:', error);
				alert('Failed to load event for editing');
			}
		}
		
		// Delete calendar event
		async function deleteCalendarEvent(eventId) {
			if (!confirm('Are you sure you want to delete this event?')) {
				return;
			}
			
			try {
				const response = await fetch(`/api/calendar/events/${eventId}`, {
					method: 'DELETE',
					headers: {
						'Authorization': `Bearer ${authToken}`
					}
				});
				
				if (response.ok) {
					alert('Event deleted successfully');
					// Hide event details popup if it's open
					const popup = document.getElementById('eventDetailsPopup');
					if (popup) {
						popup.style.display = 'none';
					}
					// Refresh calendar and customer events list
					await //loadCalendarEvents();
					//renderCustomCalendar();
					// If we're in the customer profile, refresh events
					if (currentLead) {
						await loadCustomerEvents(currentLead._id);
					}
				}
			} catch (error) {
				alert('Failed to delete event');
			}
		}
		
		// Tab switching functionality
		function switchTab(tabName) {
			// Remove active class from all tabs and content
			document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			// Add active class to selected tab and content
			event.target.classList.add('active');
			document.getElementById(`tab-${tabName}`).classList.add('active');
			// Start/stop notification polling based on tab and auto-scroll communication
			if (tabName === 'communication') {
				startNotificationPolling();
				// Auto-scroll to bottom of conversation when switching to communication tab
				setTimeout(() => {
					scrollConversationToBottom();
				}, 100);
				setTimeout(() => {
					scrollConversationToBottom();
				}, 300);
			} else {
				stopNotificationPolling();
			}
		}
		// Update editable field
		async function updateField(fieldName, value) {
			if (!currentLead || !value) return;
			try {
				const response = await fetch(`/api/leads/${currentLead._id}`, {
					method: 'PATCH',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ [fieldName]: value })
				});
				const data = await response.json();
				if (data.success) {
					// Update local data
					currentLead[fieldName] = value;
					const leadIndex = allLeads.findIndex(l => l._id === currentLead._id);
					if (leadIndex !== -1) {
						allLeads[leadIndex][fieldName] = value;
					}
					// Update profile header if it's name or email
					if (fieldName === 'name') {
						const initials = value.split(' ').map(n => n[0]).join('').toUpperCase();
						document.getElementById('profileAvatar').textContent = initials;
						document.getElementById('profileName').textContent = value;
						renderLeads(); // Refresh table
					}
					if (fieldName === 'email' || fieldName === 'phone') {
						document.getElementById('profileSubtitle').textContent = 
							`${currentLead.email || 'No email'} • ${currentLead.phone || 'No phone'}`;
						renderLeads(); // Refresh table
					}
				} else {
					alert('Failed to update field');
					// Revert the field value
					document.getElementById(`editable${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`).value = currentLead[fieldName] || '';
				}
			} catch (error) {
				alert('Failed to update field');
				// Revert the field value
				document.getElementById(`editable${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`).value = currentLead[fieldName] || '';
			}
		}
		// Add new interaction
		async function addInteraction() {
			const type = document.getElementById('interactionType').value;
			const note = document.getElementById('interactionNote').value.trim();
			if (!note) {
				alert('Please enter interaction details');
				return;
			}
			if (!currentLead) {
				alert('No customer selected');
				return;
			}
			try {
				// Send interaction to server
				const response = await fetch(`/api/leads/${currentLead._id}/interactions`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						type: type,
						title: `${type.charAt(0).toUpperCase() + type.slice(1)} Interaction`,
						description: note
					})
				});
				const result = await response.json();
				if (result.success) {
					// Clear form
					document.getElementById('interactionNote').value = '';
					// Refresh timeline to show the new interaction
					await populateTimelineTab(currentLead);
					// Update interaction count
					const currentCount = parseInt(document.getElementById('totalInteractions').textContent) || 0;
					document.getElementById('totalInteractions').textContent = currentCount + 1;
					alert('Interaction logged successfully');
				} else {
					throw new Error(result.message || 'Failed to log interaction');
				}
			} catch (error) {
				alert('Failed to log interaction: ' + error.message);
			}
		}
		// Add new note
		async function addNote() {
			const noteText = document.getElementById('newNoteText').value.trim();
			const priority = document.getElementById('notePriority').value;
			if (!noteText) {
				alert('Please enter a note');
				return;
			}
			if (!currentLead) {
				alert('No customer selected');
				return;
			}
			try {
				// Send note to server
				const response = await fetch(`/api/leads/${currentLead._id}/notes`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${authToken}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						content: noteText,
						priority: priority
					})
				});
				const result = await response.json();
				if (result.success) {
					// Clear form
					document.getElementById('newNoteText').value = '';
					document.getElementById('notePriority').value = 'low';
					// Refresh notes list to show the new note
					await populateNotesTab(currentLead);
					alert('Note added successfully');
				} else {
					throw new Error(result.message || 'Failed to add note');
				}
			} catch (error) {
				alert('Failed to add note: ' + error.message);
			}
		}
		// Close modal when clicking outside
		window.onclick = function(event) {
			const leadModal = document.getElementById('leadModal');
			const settingsModal = document.getElementById('settingsModal');
			const eventModal = document.getElementById('createEventModal');
			if (event.target == leadModal) {
				closeModal();
			} else if (event.target == settingsModal) {
				closeSettings();
			} else if (event.target == eventModal) {
				closeCreateEventModal();
			}
		}
		// Dark mode toggle
		function toggleDarkMode() {
			const currentTheme = document.documentElement.getAttribute('data-theme');
			const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
			document.documentElement.setAttribute('data-theme', newTheme);
			localStorage.setItem('theme', newTheme);
			updateThemeIcon(newTheme);
		}
		// Update theme icon and text
		function updateThemeIcon(theme) {
			const icon = document.getElementById('themeIcon');
			const text = document.querySelector('.theme-text');
			if (icon) {
				icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
			}
			if (text) {
				text.textContent = theme === 'dark' ? 'Light' : 'Dark';
			}
		}

		// Initialize the page when DOM is loaded
		document.addEventListener('DOMContentLoaded', function() {
			console.log('DOM loaded, initializing...');
			// Update debug info to show JavaScript is ready
			const debugInfo = document.getElementById('debugInfo');
			console.log('Debug element found:', debugInfo);
			if (debugInfo) {
				debugInfo.textContent = 'Ready to login';
				debugInfo.style.color = 'blue';
				console.log('Debug message updated');
			}

			// Test if login form exists
			const loginForm = document.getElementById('loginForm');
			console.log('Login form found:', loginForm);
			
			// Add a test button click handler
			window.testLogin = function() {
				console.log('Test login function called');
				const password = document.getElementById('password').value;
				console.log('Password value:', password);
				alert('Test: Password = ' + password);
			};
			console.log('Test login function added to window');

			// Load theme from localStorage
			const savedTheme = localStorage.getItem('theme') || 'light';
			document.documentElement.setAttribute('data-theme', savedTheme);
			updateThemeIcon(savedTheme);

			// Check if user is already logged in
			const storedToken = localStorage.getItem('adminToken');
			if (storedToken) {
				authToken = storedToken;
				showDashboard();
			}
		});

		// Open chat for current lead
		function openChatForCurrentLead() {
			console.log('openChatForCurrentLead called');
			console.log('currentLead:', currentLead);
			
			if (!currentLead) {
				alert('No customer selected. Please select a customer first.');
				return;
			}
			
			if (!currentLead.phone) {
				alert('This customer does not have a phone number on file.');
				return;
			}

			// Check if openCustomerChat function exists
			if (typeof openCustomerChat === 'function') {
				openCustomerChat(currentLead._id, currentLead.name, currentLead.phone);
			} else {
				console.error('openCustomerChat function not found');
				alert('Chat functionality is not loaded. Please refresh the page.');
			}
		}

		// Make function globally available
		window.openChatForCurrentLead = openChatForCurrentLead;

		// Enhanced Calendar Functions
		
		// Enhanced schedule appointment using the new Google Calendar Manager
		async function enhancedScheduleAppointment() {
			const currentLead = window.currentSelectedLead;
			
			if (!currentLead) {
				showError('Please select a client first');
				return;
			}

			try {
				// Check if Google Calendar Manager is available and initialized
				if (typeof window.googleCalendarManager !== 'undefined') {
					const authStatus = window.googleCalendarManager.getAuthStatus();
					
					if (authStatus.hasCredentials && authStatus.initialized) {
						if (!authStatus.authenticated) {
							// Try to authenticate
							const confirmAuth = confirm(`Authenticate with Google Calendar to create events directly?\n\nClick OK to authenticate, or Cancel to use the fallback method.`);
							if (confirmAuth) {
								try {
									await window.googleCalendarManager.authenticate();
									// Create the appointment after successful authentication
									const event = await window.googleCalendarManager.createClientAppointment(currentLead);
									showSuccess(`✅ Strategy session scheduled successfully!\n\nEvent: ${event.summary}\nTime: ${new Date(event.start.dateTime).toLocaleString()}`);
									
									// Refresh the calendar view
									if (typeof renderCustomCalendar === 'function') {
										//renderCustomCalendar();
									}
									return;
								} catch (authError) {
									console.error('Authentication failed:', authError);
									showError('Authentication failed. Using fallback method.');
								}
							}
						} else {
							// Already authenticated, create event directly
							try {
								const event = await window.googleCalendarManager.createClientAppointment(currentLead);
								showSuccess(`✅ Strategy session scheduled successfully!\n\nEvent: ${event.summary}\nTime: ${new Date(event.start.dateTime).toLocaleString()}`);
								
								// Refresh the calendar view
								if (typeof renderCustomCalendar === 'function') {
									//renderCustomCalendar();
								}
								return;
							} catch (createError) {
								console.error('Event creation failed:', createError);
								showError('Failed to create event directly. Using fallback method.');
							}
						}
					}
				}
				
				// Fallback to the quick schedule method
				console.log('Using fallback quick schedule method');
				if (typeof window.googleCalendarManager !== 'undefined') {
					window.googleCalendarManager.quickScheduleWithClient(currentLead);
				} else {
					// Use the original schedule appointment function
					scheduleAppointment();
				}
				
			} catch (error) {
				console.error('Enhanced schedule error:', error);
				showError('An error occurred while scheduling. Please try the basic schedule option.');
			}
		}

		// Enhanced Google Calendar authentication with better user feedback
		async function enhancedGoogleCalendarAuth() {
			try {
				if (typeof window.googleCalendarManager === 'undefined') {
					showError('Google Calendar Manager not loaded. Please refresh the page.');
					return;
				}

				const authStatus = window.googleCalendarManager.getAuthStatus();
				
				if (!authStatus.hasCredentials) {
					showGoogleCalendarSetupInfo();
					return;
				}

				if (!authStatus.initialized) {
					showError('Google Calendar API not initialized. Please check your configuration.');
					return;
				}

				if (authStatus.authenticated) {
					// Sign out
					const confirmSignOut = confirm('Are you sure you want to disconnect from Google Calendar?');
					if (confirmSignOut) {
						await window.googleCalendarManager.signOut();
						updateGoogleCalendarButton('disconnected');
						showSuccess('Disconnected from Google Calendar');
						
						// Clear any Google events from local calendar
						if (typeof renderCustomCalendar === 'function') {
							//renderCustomCalendar();
						}
					}
				} else {
					// Sign in
					try {
						await window.googleCalendarManager.authenticate();
						updateGoogleCalendarButton('connected');
						showSuccess('Successfully connected to Google Calendar!');
						
						// Load events and refresh calendar
						if (typeof loadGoogleCalendarEvents === 'function') {
							//await loadGoogleCalendarEvents();
						}
						if (typeof renderCustomCalendar === 'function') {
							//renderCustomCalendar();
						}
					} catch (authError) {
						console.error('Authentication error:', authError);
						showError('Failed to authenticate with Google Calendar. Please try again.');
					}
				}
			} catch (error) {
				console.error('Enhanced auth error:', error);
				showError('An error occurred during authentication.');
			}
		}

		// Override the original handleGoogleCalendarAuth function with enhanced version
		if (typeof handleGoogleCalendarAuth !== 'undefined') {
			window.originalHandleGoogleCalendarAuth = handleGoogleCalendarAuth;
		}
		window.handleGoogleCalendarAuth = enhancedGoogleCalendarAuth;

		// Enhanced refresh calendar function
		async function enhancedRefreshCalendar() {
			try {
				if (typeof window.googleCalendarManager !== 'undefined') {
					const authStatus = window.googleCalendarManager.getAuthStatus();
					
					if (authStatus.authenticated) {
						// Get current month's date range
						const now = new Date();
						const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
						const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
						
						// Load events from Google Calendar
						await window.googleCalendarManager.listEvents(startOfMonth, endOfMonth);
						console.log('✅ Google Calendar events refreshed');
					}
				}
				
				// Call the original refresh function
				if (typeof renderCustomCalendar === 'function') {
					//renderCustomCalendar();
				}
				
				showSuccess('Calendar refreshed successfully!');
			} catch (error) {
				console.error('Enhanced refresh error:', error);
				showError('Failed to refresh calendar from Google.');
				
				// Fallback to basic refresh
				if (typeof renderCustomCalendar === 'function') {
					//renderCustomCalendar();
				}
			}
		}

		// Override the original refreshCalendar function
		if (typeof refreshCalendar !== 'undefined') {
			window.originalRefreshCalendar = refreshCalendar;
		}
		window.refreshCalendar = enhancedRefreshCalendar;

		// Make enhanced functions globally available
		window.enhancedScheduleAppointment = enhancedScheduleAppointment;
		window.enhancedGoogleCalendarAuth = enhancedGoogleCalendarAuth;
		window.enhancedRefreshCalendar = enhancedRefreshCalendar;

	</script>
</body>
</html>
